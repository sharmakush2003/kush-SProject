<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1024"> 
    <title>My Smart Expense Tracker üí∞</title>
    <link rel="icon" type="image/png" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3e%3cpath fill='%23f1c40f' d='M19 12h-6V6h-2v6H5v2h6v6h2v-6h6z'/%3e%3c/svg%3e">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /*
            ‚ú® UI Enhancements & Animations are deliberately minimized or removed for a completely static experience. ‚ú®
            - Only non-disruptive background animation retained.
            - Explicit transitions removed. Changes will be immediate.
            - Extensive Emoji Integration: In headings, welcome message, categories, buttons, summaries, and toasts.
            - Refined Glassmorphism: Remains, but active states change instantly.
            - Accessibility: Added aria-labels.
            - Usability: Better validation message positioning.
            
            NEW FEATURES:
            - Currency Selector: User can pick currency from settings.
            - Dark/Light Mode: Toggle between themes.
            - Improved Footer: "Developer Info" button & Copyright.

            NOTE: No media queries for fluid responsiveness; designed for fixed desktop scaling.
        */

        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        
        :root {
            /* Base Dark Theme Colors */
            --primary-color: #9B59B6; /* Amethyst */
            --secondary-color: #4BC0D9; /* Cyan-like Blue */
            --accent-color: #FFE66D; /* Soft Yellow/Gold */
            --danger-color: #e74c3c; /* Red */
            --success-color: #2ecc71; /* Green */
            --info-color: #6CCFEA;   /* Lighter Blue */

            --white-color: #F5F5F5; /* Off-white for softer look */
            --text-color: #ecf0f1; /* Light gray text */
            --background-gradient-start: #2c3e50;
            --background-gradient-mid-1: #34495e;
            --background-gradient-mid-2: #23a6d5;
            --background-gradient-end: #23d5ab;

            --soft-dark-bg: rgba(0, 0, 0, 0.45); 
            --modal-bg: rgba(44, 62, 80, 0.95); 
            --border-alpha: rgba(255, 255, 255, 0.25); 
            --input-border-alpha: rgba(255, 255, 255, 0.4); 
            --shadow-light: rgba(0, 0, 0, 0.8); 
            --shadow-button: rgba(0,0,0,0.5); 
            --bg-glass-active: rgba(0,0,0,0.6); 

            /* Dynamic Currency Symbol (JS will update this custom property) */
            --current-currency-symbol: '‚Çπ';
        }

        /* Light Mode Variables - Overrides defaults when .light-mode is on body */
        body.light-mode {
            --primary-color: #7f52a8; /* Darker Amethyst for contrast */
            --secondary-color: #0d8ca1; /* Darker Cyan */
            --accent-color: #e6b200; /* Richer Gold */
            --danger-color: #c0392b; 
            --success-color: #27ae60; 
            --info-color: #2980b9; 

            --white-color: #2c3e50; /* Darker text for light background */
            --text-color: #34495e; /* Main text color */
            --background-gradient-start: #bdc3c7;
            --background-gradient-mid-1: #ecf0f1;
            --background-gradient-mid-2: #95a5a6;
            --background-gradient-end: #65b8c9;

            --soft-dark-bg: rgba(255, 255, 255, 0.75); /* Lighter, opaque base for glass */
            --modal-bg: rgba(236, 240, 241, 0.98); /* Near-opaque light for modals */
            --border-alpha: rgba(0, 0, 0, 0.2); /* Darker borders for light theme */
            --input-border-alpha: rgba(0, 0, 0, 0.3); /* Darker borders for light inputs */
            --shadow-light: rgba(0, 0, 0, 0.5); 
            --shadow-button: rgba(0,0,0,0.3); 
            --bg-glass-active: rgba(255, 255, 255, 0.9); /* Distinct hover/focus background */
        }
        
        /* Apply light mode based on system preference */
        @media (prefers-color-scheme: light) {
            body:not([data-theme="dark"]) {
                --primary-color: #7f52a8; 
                --secondary-color: #0d8ca1;
                --accent-color: #e6b200;
                --danger-color: #c0392b; 
                --success-color: #27ae60; 
                --info-color: #2980b9; 

                --white-color: #2c3e50; 
                --text-color: #34495e; 
                --background-gradient-start: #bdc3c7;
                --background-gradient-mid-1: #ecf0f1;
                --background-gradient-mid-2: #95a5a6;
                --background-gradient-end: #65b8c9;

                --soft-dark-bg: rgba(255, 255, 255, 0.75); 
                --modal-bg: rgba(236, 240, 241, 0.98); 
                --border-alpha: rgba(0, 0, 0, 0.2); 
                --input-border-alpha: rgba(0, 0, 0, 0.3); 
                --shadow-light: rgba(0, 0, 0, 0.5); 
                --shadow-button: rgba(0,0,0,0.3); 
                --bg-glass-active: rgba(255, 255, 255, 0.9); 
            }
        }


        /* All CSS Transitions and @keyframes (except for background) have been removed */
        @keyframes gradient-animation { 
            0%{background-position:0% 50%} 
            50%{background-position:100% 50%} 
            100%{background-position:0% 50%} 
        }
       
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, var(--background-gradient-start), var(--background-gradient-mid-1), var(--background-gradient-mid-2), var(--background-gradient-end));
            background-size: 400% 400%; animation: gradient-animation 15s ease infinite; 
            color: var(--text-color); min-height: 100vh; padding: 20px;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }

        /* NEW: Utility bar for settings button */
        #utility-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        #settings-button {
            background: var(--soft-dark-bg);
            color: var(--text-color);
            padding: 10px 18px;
            border: 1px solid var(--border-alpha);
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px var(--shadow-button);
        }

        #settings-button:hover {
            background: var(--bg-glass-active);
        }

        /* NEW: App footer styling for developer info and copyright */
        .app-footer {
            text-align: center;
            margin-top: 60px; 
            padding-top: 30px; 
            border-top: 1px dashed rgba(255, 255, 255, 0.15); 
        }

        #dev-info-button {
            background: var(--soft-dark-bg);
            color: var(--text-color);
            padding: 10px 18px;
            border: 1px solid var(--border-alpha);
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex; 
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px var(--shadow-button);
            margin: 0 auto 15px auto; 
            width: fit-content; 
        }

        #dev-info-button:hover {
            background: var(--bg-glass-active);
        }

        .copyright-notice {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0; 
            font-weight: 300; 
            letter-spacing: 0.5px; 
        }

        body.light-mode .copyright-notice {
             color: rgba(0, 0, 0, 0.5); /* Darker for light mode */
        }


        .container {
            width: 100%; max-width: 950px; padding: 40px; 
            background: var(--soft-dark-bg); 
            border-radius: 20px;
            box-shadow: 0 15px 50px var(--shadow-light), inset 0 0 10px rgba(255,255,255,0.1); 
            backdrop-filter: blur(25px); 
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--border-alpha);
            margin: auto;
            position: relative;
        }

        /* Headings */
        h1 {
            font-size: 2.8rem; text-align: center; margin-bottom: 10px; font-weight: 700;
            background: linear-gradient(45deg, var(--white-color), var(--accent-color));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 5px 12px rgba(0,0,0,0.5); 
            letter-spacing: 1px; 
        }

        #welcome-message {
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 25px; 
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
        }
        
        body.light-mode #welcome-message {
            color: rgba(0, 0, 0, 0.9);
        }


        h2 {
            font-size: 2rem; 
            text-align: center; color: var(--text-color); /* Updated to use dynamic text color */
            margin: 45px 0 30px 0; 
            font-weight: 700;
            border-top: 1px solid var(--border-alpha); padding-top: 30px; 
            display: flex; align-items: center; justify-content: center; gap: 12px; 
            letter-spacing: 0.5px;
            transform: scale(1);
        }
        h2 i { color: var(--accent-color); font-size: 1.7rem; }

        /* Total Expenses Section */
        .total-expenses { text-align: center; margin-bottom: 30px; }
        .total-expenses h3 { font-weight: 400; font-size: 1rem; color: rgba(255, 255, 255, 0.8); } 
        body.light-mode .total-expenses h3 {
             color: rgba(0, 0, 0, 0.7);
        }

        .total-expenses #total-amount { 
            font-size: 3.5rem; font-weight: 700; color: var(--accent-color); 
        }
        
        /* Form Layout */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .form-control.full-width { grid-column: 1 / -1; }
        .form-control { display: flex; flex-direction: column; position: relative; }
        label { margin-bottom: 10px; font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.8px; opacity: 0.95; 
                color: var(--text-color); /* Ensure label text changes with theme */
        } 
        
        input[type="text"], input[type="number"], input[type="date"], select {
            padding: 16px; border: 1px solid var(--input-border-alpha); border-radius: 10px; 
            font-size: 17px; background: rgba(0, 0, 0, 0.35); 
            color: var(--text-color); /* Input text color dynamic */
            font-family: 'Poppins', sans-serif;
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.25); 
            -webkit-appearance: none; 
            -moz-appearance: none;
            appearance: none;
        }

        /* Custom dropdown arrow for select */
        select { 
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); 
            background-repeat: no-repeat;
            background-position: right 15px center; 
            padding-right: 40px; 
            cursor: pointer;
        }
        /* Adjust select arrow for light mode */
        body.light-mode select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%2334495e' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); 
        }

        /* Style for options within the select dropdown */
        select option {
            background-color: #2c3e50; /* Base color for dropdown option background */
            color: var(--text-color);
            padding: 10px; 
        }
        body.light-mode select option {
             background-color: #ecf0f1; /* Light color for dropdown option background */
        }


        input::placeholder { color: rgba(255, 255, 255, 0.8); }
        body.light-mode input::placeholder { color: rgba(0, 0, 0, 0.6); }

        input:focus, select:focus {
            outline: none; background: var(--bg-glass-active); 
            border-color: var(--primary-color);
            box-shadow: 0 0 20px var(--primary-color), inset 0 2px 10px rgba(0,0,0,0.4); 
        }
        input.invalid, select.invalid { border-color: var(--danger-color); box-shadow: 0 0 15px var(--danger-color), inset 0 2px 8px rgba(0,0,0,0.4); } 
        
        .form-control .error-message { 
            position: relative; 
            margin-top: 5px; 
            font-size: 0.78rem; 
            color: var(--danger-color);
            height: 1.1rem; 
            opacity: 0;
            overflow: hidden; 
            white-space: nowrap; 
            text-overflow: ellipsis; 
        }
        .form-control input.invalid + .error-message, 
        .form-control select.invalid + .error-message { 
            opacity: 1;
        }

        /* Buttons */
        .btn { 
            padding: 16px 25px; border: none; border-radius: 10px; 
            cursor: pointer; font-size: 17px; font-weight: 600; text-align: center; 
            letter-spacing: 0.8px; white-space: nowrap;
            display: inline-flex; align-items: center; justify-content: center; 
            line-height: 1; 
            box-shadow: 0 8px 25px var(--shadow-button);
            color: var(--white-color); /* Ensure text color is white for gradient buttons */
        }
        .btn:hover { 
            box-shadow: 0 14px 40px var(--shadow-light); 
        } 
        .btn-primary { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); } 
        .btn-primary:hover { 
            background: linear-gradient(45deg, color-mix(in srgb, var(--primary-color) 80%, black), color-mix(in srgb, var(--secondary-color) 80%, black)); /* Slightly darker hover */
        } 
        body.light-mode .btn-primary:hover {
            background: linear-gradient(45deg, color-mix(in srgb, var(--primary-color) 80%, white), color-mix(in srgb, var(--secondary-color) 80%, white));
        }

        /* Secondary buttons should follow their colors more strictly, adjusting hover */
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: color-mix(in srgb, var(--danger-color) 80%, black); }
        body.light-mode .btn-danger:hover { background-color: color-mix(in srgb, var(--danger-color) 80%, white); }

        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: color-mix(in srgb, var(--success-color) 80%, black); }
        body.light-mode .btn-success:hover { background-color: color-mix(in srgb, var(--success-color) 80%, white); }

        .btn-info { background-color: var(--info-color); }
        .btn-info:hover { background-color: color-mix(in srgb, var(--info-color) 80%, black); }
        body.light-mode .btn-info:hover { background-color: color-mix(in srgb, var(--info-color) 80%, white); }
        
        .btn i { margin-right: 10px; font-size: 1rem; } 

        /* Action Buttons within table */
        .action-btn { 
            background: none; border: none; cursor: pointer; font-size: 1.3rem; 
            padding: 6px; color: var(--text-color); opacity: 0.8; /* Uses dynamic text color */
            line-height: 1; 
        }
        .action-btn:hover { 
            opacity: 1; 
        } 
        .action-btn.edit-btn:hover { color: var(--secondary-color); }
        .action-btn.duplicate-btn:hover { color: var(--success-color); }
        .action-btn.delete-btn:hover { color: var(--danger-color); }
        
        .actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 40px; } 
        
        /* Summary Section Styling */
        #expense-summary-section {
            background: rgba(0,0,0,0.3); /* Static dark glass background for section */
            padding: 30px; 
            border-radius: 18px; 
            border: 1px solid var(--border-alpha);
            box-shadow: 0 8px 30px var(--shadow-button), inset 0 0 8px rgba(255,255,255,0.05);
            margin-bottom: 30px;
            margin-top: 40px; 
        }
        body.light-mode #expense-summary-section {
             background: rgba(255,255,255,0.75); /* Light glass background for section */
        }
        #expense-summary-section h3 {
            font-size: 1.6rem; 
            color: var(--accent-color);
            font-weight: 700;
            margin-bottom: 25px;
            padding-bottom: 20px; 
            border-bottom: 1px dashed var(--border-alpha); 
            gap: 15px; 
        }
        #expense-summary-section h3 i { color: var(--accent-color); font-size: 1.4rem; } 
        #expense-summary-content p {
            display: flex; 
            align-items: flex-start; 
            padding: 15px; 
            background: rgba(0,0,0,0.2); 
            border-left: 5px solid var(--secondary-color); 
            margin-bottom: 12px; 
            border-radius: 10px; 
            line-height: 1.7; 
            font-size: 1.05rem; 
            gap: 15px; 
            color: rgba(255,255,255,0.85); /* Summary paragraph text */
        }
        body.light-mode #expense-summary-content p {
            background: rgba(0,0,0,0.1); 
            color: rgba(0,0,0,0.85);
        }

        #expense-summary-content p:last-child { margin-bottom: 0; }
        #expense-summary-content strong { color: var(--white-color); }
        body.light-mode #expense-summary-content strong { color: var(--text-color); }

        #expense-summary-content .good-news { border-left-color: var(--success-color); }
        #expense-summary-content .bad-news { border-left-color: var(--danger-color); }
        #expense-summary-content .good-news i, #expense-summary-content .bad-news i {
            font-size: 1.3rem; 
        }
        #expense-summary-content p i { 
            font-size: 1.2rem; 
            flex-shrink: 0; 
            margin-top: 2px; 
        }

        /* Expense Controls (Filters/Search) */
        .expense-controls { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 20px; 
            align-items: flex-end; 
            margin-bottom: 25px; 
        } 
        .expense-controls .form-control { 
            min-width: unset; 
            flex: unset; 
        }
        .expense-controls #date-filter-group { 
            grid-column: 1 / -1; 
            display: flex; flex-wrap: wrap; gap: 20px; 
            padding: 20px 0 10px; 
            border-top: 1px dashed var(--border-alpha); 
            margin-top: 20px; 
        }

        /* Expense Table Styling */
        .expense-table-container { 
            max-height: 400px; overflow-y: auto; 
            background: rgba(0,0,0,0.28);
            border-radius: 10px; 
            border: 1px solid var(--border-alpha);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.15);
        }
        body.light-mode .expense-table-container {
             background: rgba(0,0,0,0.1); /* Darker translucent for table in light mode */
             box-shadow: inset 0 0 10px rgba(0,0,0,0.08);
        }
        .expense-table-container::-webkit-scrollbar { width: 10px; } 
        .expense-table-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 10px; }
        body.light-mode .expense-table-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.15); }
        .expense-table-container::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 10px; border: 2px solid rgba(0,0,0,0.2); } 
        .expense-table { width: 100%; border-collapse: collapse; }
        .expense-table th, .expense-table td { padding: 14px 18px; text-align: left; vertical-align: middle; color: var(--text-color); }
        .expense-table thead { position: sticky; top: 0; z-index: 10; }
        .expense-table thead tr { background: rgba(0, 0, 0, 0.7); border-bottom: 1px solid var(--border-alpha); } 
        body.light-mode .expense-table thead tr {
             background: rgba(255, 255, 255, 0.9);
        }

        .expense-table th { 
            font-weight: 700; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 0.8px; 
            color: rgba(255, 255, 255, 0.95);
            cursor: pointer; 
            white-space: nowrap;
        }
        body.light-mode .expense-table th {
            color: rgba(0, 0, 0, 0.95);
        }

        .expense-table th:hover { 
            color: var(--accent-color); 
            background: rgba(0,0,0,0.75); 
        } 
        body.light-mode .expense-table th:hover {
            background: rgba(0,0,0,0.15);
        }


        .expense-table th.sorted { color: var(--secondary-color); }

        .expense-table th .sort-icon { margin-left: 8px; font-size: 0.8em; } 

        .expense-table tbody tr { 
            border-bottom: 1px dashed var(--border-alpha); 
            background-color: rgba(0,0,0,0.2); 
        } 
        body.light-mode .expense-table tbody tr {
             background-color: transparent;
        }

        .expense-table tbody tr:last-child { border-bottom: none; }
        .expense-table tbody tr:hover { background-color: rgba(0,0,0,0.45); } 
        body.light-mode .expense-table tbody tr:hover { background-color: rgba(0,0,0,0.15); }

        .expense-table .col-amount { font-weight: 700; color: var(--accent-color); text-align: right; }
        body.light-mode .expense-table .col-amount { color: var(--danger-color); } /* Danger for expenses in light mode is a common pattern */

        .expense-table .col-actions { width: 120px; text-align: center; }

        /* Toast Notifications */
        #toast-container { 
            position: fixed; top: 25px; right: 25px; z-index: 2000; 
            display: flex; flex-direction: column; gap: 12px; pointer-events: none;
            overflow: hidden; 
        } 
        .toast {
            background-color: var(--modal-bg); color: var(--text-color); /* Toast text color */
            padding: 18px 30px; border-radius: 10px; 
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4); 
            backdrop-filter: blur(12px); 
            opacity: 0; transform: translateX(100%); 
            min-width: 280px; text-align: center;
            border: 1px solid var(--border-alpha);
            font-weight: 500;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .toast.show {
            opacity: 1; 
            transform: translateX(0); 
        }
        .toast.hide-effect {
            opacity: 0; 
            transform: translateX(100%); 
        }
        .toast i { font-size: 1.2em; }
        .toast.success { border-left: 6px solid var(--success-color); } 
        .toast.success i { color: var(--success-color); }
        .toast.error { border-left: 6px solid var(--danger-color); }
        .toast.error i { color: var(--danger-color); }
        .toast.info { border-left: 6px solid var(--info-color); }
        .toast.info i { color: var(--info-color); }

        /* Modal Styles (Tweaked for instant display without transitions) */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); 
            backdrop-filter: blur(15px); z-index: 1000; 
            display: none; 
            align-items: center; justify-content: center; 
            opacity: 0; 
        }
        .modal-overlay.active { 
            display: flex; 
            opacity: 1; 
        }
        .modal-content { 
            background: var(--modal-bg); border-radius: 20px; 
            box-shadow: 0 20px 60px var(--shadow-light), inset 0 0 10px rgba(255,255,255,0.05); 
            border: 1px solid var(--border-alpha); 
            padding: 45px; width: 90%; max-width: 650px; 
            transform: scale(1); 
            opacity: 1; 
            position: relative; 
            max-height: 90vh; 
            overflow-y: auto; 
            color: var(--text-color); /* Ensure modal text changes with theme */
        }

        #settings-modal .modal-content {
            max-width: 500px;
        }
        #settings-modal h2 { margin: 0 0 30px 0; }
        #settings-modal .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px dashed var(--border-alpha);
        }
        #settings-modal .settings-option:last-of-type { border-bottom: none; }
        #settings-modal .settings-option label {
            margin-bottom: 0; /* Override default label margin */
            font-size: 1rem;
            text-transform: none; /* Default capitalization */
            letter-spacing: normal;
        }

        /* The toggle switch specific styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc; /* Grey for off */
            border-radius: 28px; /* Rounded slider */
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
        }
        input:checked + .toggle-slider { background-color: var(--primary-color); }
        input:checked + .toggle-slider:before { transform: translateX(22px); }


        /* Specific content styles for the developer modal (remain the same) */
        #developer-modal .modal-content {
            text-align: left;
        }
        #developer-modal .modal-content h2 {
            margin: 0 0 20px 0; 
            padding-top: 0;
            border-top: none;
            justify-content: flex-start;
        }
        #developer-modal .modal-content h3 {
            color: var(--secondary-color);
            margin-top: 25px;
            margin-bottom: 10px;
            font-size: 1.3rem;
            font-weight: 600;
        }
        #developer-modal .modal-content p, #developer-modal .modal-content ul {
            font-size: 0.98rem;
            line-height: 1.6;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        #developer-modal .modal-content ul {
            margin-left: 20px;
            list-style-type: disc;
        }
        #developer-modal .modal-content ul li {
            margin-bottom: 8px;
        }
        #developer-modal .modal-content strong {
            color: var(--white-color);
        }
        #developer-modal .modal-content a {
            color: var(--info-color);
            text-decoration: none;
            font-weight: 500;
        }
        #developer-modal .modal-content a:hover {
            text-decoration: underline;
        }
        #developer-modal .contact-links i {
            margin-right: 8px;
            color: var(--accent-color);
        }

    </style>
</head>
<body>
    <!-- Utility bar for global settings -->
    <div id="utility-bar">
        <button id="settings-button" aria-label="Open Settings">
            <i class="fas fa-cog" aria-hidden="true"></i> Settings
        </button>
    </div>

    <!-- Main content container -->
    <div class="container">
        <h1>Smart Expense Tracker üí∞</h1>
        <p id="welcome-message"></p>

        <div class="total-expenses">
            <h3>Total Lifetime Expenses</h3>
            <div id="total-amount">‚Çπ0.00</div>
        </div>

        <div id="expenses-section" class="tab-content-section active">
            <form id="expense-form">
                <div class="form-grid">
                    <div class="form-control">
                        <label for="expense-date">Date</label>
                        <input type="date" id="expense-date" required>
                        <span class="error-message" data-input="expense-date"></span>
                    </div>
                    <div class="form-control">
                        <label for="expense-category">Category</label>
                        <select id="expense-category" required></select>
                        <span class="error-message" data-input="expense-category"></span>
                    </div>
                    <div class="form-control full-width">
                        <label for="expense-description">Description</label>
                        <input type="text" id="expense-description" placeholder="e.g., Lunch with team" required>
                        <span class="error-message" data-input="expense-description"></span>
                    </div>
                    <div class="form-control full-width">
                        <label for="expense-amount">Amount (‚Çπ)</label>
                        <input type="number" id="expense-amount" placeholder="e.g., 1250.50" step="0.01" min="0.01" required>
                        <span class="error-message" data-input="expense-amount"></span>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top: 25px;"><i class="fas fa-plus" aria-hidden="true"></i> Add Expense</button>
                <button type="button" id="add-category-btn" class="btn btn-info" style="margin-top: 25px; margin-left: 10px;"><i class="fas fa-tag" aria-hidden="true"></i> New Category</button>
            </form>
            
            <div id="expense-summary-section">
                <h3><i class="fas fa-chart-pie" aria-hidden="true"></i> Your Monthly Summary</h3>
                <div id="expense-summary-content">
                    <p style="text-align: center; color: rgba(255,255,255,0.7); border: none; background: none;">
                        <i class="fas fa-hand-holding-usd" style="margin-right: 8px;" aria-hidden="true"></i> Add some expenses to see a summary here! üöÄ
                    </p>
                </div>
            </div>

            <h2><i class="fas fa-list-alt" aria-hidden="true"></i> Your Expense Log</h2>
            <div class="expense-controls">
                <div class="form-control">
                    <label for="category-filter">Filter by Category</label>
                    <select id="category-filter"></select>
                </div>
                <div id="date-filter-group">
                    <div class="form-control">
                        <label for="start-date-filter">From Date</label>
                        <input type="date" id="start-date-filter">
                        <span class="error-message" data-input="start-date-filter"></span>
                    </div>
                    <div class="form-control">
                        <label for="end-date-filter">To Date</label>
                        <input type="date" id="end-date-filter">
                        <span class="error-message" data-input="end-date-filter"></span>
                    </div>
                </div>
            </div>
            
            <div class="expense-table-container">
                <table class="expense-table">
                    <thead>
                        <tr>
                            <th data-sort-by="date">Date <span class="sort-icon"></span></th>
                            <th data-sort-by="category">Category <span class="sort-icon"></span></th>
                            <th data-sort-by="description">Description <span class="sort-icon"></span></th>
                            <th data-sort-by="amount" class="col-amount">Amount <span class="sort-icon"></span></th>
                            <th class="col-actions">Action</th>
                        </tr>
                    </thead>
                    <tbody id="expense-table-body"></tbody>
                </table>
            </div>

            <div class="actions">
                <button id="send-email-btn" class="btn btn-primary"><i class="fas fa-envelope" aria-hidden="true"></i> Send Report to Email</button>
                <button id="clear-data-btn" class="btn btn-danger"><i class="fas fa-trash-alt" aria-hidden="true"></i> Clear All Data</button>
            </div>
        </div>

        <!-- NEW: App Footer Section for Developer Info and Copyright -->
        <div class="app-footer">
            <button id="dev-info-button" aria-label="Developer Information">
                <i class="fas fa-code" aria-hidden="true"></i> About the Developer
            </button>
            <p class="copyright-notice">
                All rights reserved &copy; Kush Sharma 2025
            </p>
        </div>

    </div>

    <!-- NEW: Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal-content">
            <h2>App Settings <i class="fas fa-cogs"></i></h2>
            <div class="settings-option">
                <label for="currency-select">Currency:</label>
                <select id="currency-select"></select>
            </div>
            <div class="settings-option">
                <label for="theme-toggle">Light Mode:</label>
                <label class="toggle-switch" aria-label="Toggle light mode">
                    <input type="checkbox" id="theme-toggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="modal-actions" style="margin-top: 25px;">
                <button type="button" class="btn btn-primary cancel-modal-btn"><i class="fas fa-check" aria-hidden="true"></i> Done</button>
            </div>
        </div>
    </div>


    <!-- Developer Info Modal -->
    <div class="modal-overlay" id="developer-modal">
        <div class="modal-content">
            <h2>About The Developer ‚ú®</h2>
            <div id="about-developer-content">
                <p>
                    Greetings, fellow developer! I'm <strong>Kush Sharma</strong>, a passionate and driven B.Tech IT student from Jaipur Engineering College and Research Centre. My academic journey, underscored by an 8.90 CGPA, has provided me with a strong foundation in core computer science principles, including Data Structures & Algorithms, DBMS, and Operating Systems.
                </p>

                <h3>üíª Expertise & Tech Stack:</h3>
                <p>
                    My specialization lies in building robust and engaging web applications. I possess a solid understanding of both front-end (HTML, CSS, JavaScript) and back-end (Node.js, Express.js) technologies. I'm adept with SQL and NoSQL databases like MongoDB, leveraging Mongoose for efficient data management. My toolkit also includes essential developer tools like Git, GitHub, VS Code, and Postman. I am continuously expanding my horizons, currently diving into MCP Server, GitLab, and PrimsaORM to broaden my capabilities.
                </p>

                <h3>üöÄ Key Experiences & Projects:</h3>
                <ul>
                    <li>
                        <strong>Web Development Intern (Matrix Education):</strong> Gained practical, hands-on experience developing responsive web pages ensuring cross-browser compatibility. My proudest achievement was independently designing and implementing my personal portfolio website, which showcases my skills and experience.
                        <br>Visit it live: <a href="https://kush-website.vercel.app/" target="_blank" rel="noopener noreferrer">kush-website.vercel.app/ <i class="fas fa-external-link-alt"></i></a>
                    </li>
                    <li>
                        <strong>REST API for Data Management & Authentication:</strong> Built a comprehensive REST API using Node.js, Express.js, MongoDB, and Mongoose for user data management and secure authentication with JWT. This project reinforced my skills in routing, data persistence, schema design, and API testing with Postman, including error handling and validation. (Note: This project is currently for practice and is not hosted online).
                    </li>
                    <li>
                        <strong>Kush's GenAI Chatbot:</strong> Explored the frontiers of AI by developing an experimental terminal-based AI chatbot integrated with Google's GenAI model. I implemented interactive text responses using ReadlineSync and enhanced the terminal UI/UX with animated feedback (Ora) and visual styling (Chalk), demonstrating my capacity for innovation and engaging interfaces even in unconventional environments. (Note: This is a conceptual implementation not hosted online).
                    </li>
                </ul>

                <h3>üí° Beyond Coding: Leadership & Resilience:</h3>
                <p>
                    I believe strong technical skills are complemented by robust soft skills. As a <strong>House Captain</strong>, I led a team of 800+ students, significantly boosting event participation through strategic engagement. My experience as a <strong>Kho-Kho Tournament Organizer</strong> and a <strong>District-Level Competitor</strong> in volleyball and cricket showcases my commitment to teamwork, seamless execution, and a competitive spirit.
                </p>

                <h3>üìà Aspirations:</h3>
                <p>
                    I am actively seeking internship or entry-level opportunities that challenge me to expand my existing knowledge, collaborate within dynamic teams, and contribute to cutting-edge solutions. My goal is to apply my passion for web development to create impactful and user-centric applications.
                </p>

                <h3>üìß Connect with me:</h3>
                <p class="contact-links">
                    <i class="fas fa-envelope"></i> <a href="mailto:kushsharma.cor@gmail.com">kushsharma.cor@gmail.com</a><br>
                    <i class="fas fa-phone-alt"></i> +91 8233816674<br>
                    <i class="fab fa-linkedin"></i> <a href="https://www.linkedin.com/in/kush-sharma-9721a02ab/" target="_blank" rel="noopener noreferrer">LinkedIn <i class="fas fa-external-link-alt"></i></a><br>
                    <i class="fab fa-github"></i> <a href="https://github.com/sharmakush2003?tab=repositories" target="_blank" rel="noopener noreferrer">GitHub Repositories <i class="fas fa-external-link-alt"></i></a><br>
                    <i class="fas fa-link"></i> <a href="https://linktr.ee/sharmaKush2003" target="_blank" rel="noopener noreferrer">Linktree <i class="fas fa-external-link-alt"></i></a>
                </p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-primary cancel-modal-btn"><i class="fas fa-arrow-left" aria-hidden="true"></i> Back to App</button>
            </div>
        </div>
    </div>


    <!-- Edit Modal (position unchanged) -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-content">
            <h2>Edit Expense ‚úçÔ∏è</h2>
            <form id="edit-form">
                <div class="form-grid">
                    <div class="form-control">
                        <label for="edit-date">Date</label>
                        <input type="date" id="edit-date" required>
                        <span class="error-message" data-input="edit-date"></span>
                    </div>
                    <div class="form-control">
                        <label for="edit-category">Category</label>
                        <select id="edit-category" required></select>
                        <span class="error-message" data-input="edit-category"></span>
                    </div>
                    <div class="form-control full-width">
                        <label for="edit-description">Description</label>
                        <input type="text" id="edit-description" required>
                        <span class="error-message" data-input="edit-description"></span>
                    </div>
                    <div class="form-control full-width">
                        <label for="edit-amount">Amount (‚Çπ)</label>
                        <input type="number" id="edit-amount" step="0.01" min="0.01" required>
                        <span class="error-message" data-input="edit-amount"></span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger cancel-modal-btn"><i class="fas fa-times-circle" aria-hidden="true"></i> Cancel</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-save" aria-hidden="true"></i> Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Category Modal (position unchanged) -->
    <div class="modal-overlay" id="add-category-modal">
        <div class="modal-content">
            <h2>Add New Category ‚ú®</h2>
            <form id="add-category-form">
                <div class="form-control full-width">
                    <label for="new-category-name">Category Name</label>
                    <input type="text" id="new-category-name" placeholder="e.g., Groceries" required>
                    <span class="error-message" data-input="new-category-name"></span>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger cancel-modal-btn"><i class="fas fa-times-circle" aria-hidden="true"></i> Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-plus" aria-hidden="true"></i> Add Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Clear All Data Confirmation Modal (position unchanged) -->
    <div class="modal-overlay" id="clear-confirm-modal">
        <div class="modal-content">
            <h2>Confirm Clear Data ‚ö†Ô∏è</h2>
            <p style="text-align: center; margin-bottom: 25px; color: rgba(255,255,255,0.9);">Are you absolutely sure you want to delete <strong style="color: var(--danger-color);">ALL</strong> expense data? This action cannot be undone.</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-success cancel-modal-btn"><i class="fas fa-times-circle" aria-hidden="true"></i> Cancel</button>
                <button type="button" id="confirm-clear-data-btn" class="btn btn-danger"><i class="fas fa-trash-alt" aria-hidden="true"></i> Yes, Clear All</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications Container (position unchanged) -->
    <div id="toast-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Constants ---
            const DEFAULT_CATEGORIES = [
                "Food", "Transport", "Bills", "Shopping", 
                "Entertainment", "Health", "Education", "Rent", "Other"
            ];
            
            // New: Currency Options
            const CURRENCY_OPTIONS = [
                { name: "Indian Rupee", symbol: "‚Çπ", code: "INR" },
                { name: "US Dollar", symbol: "$", code: "USD" },
                { name: "Euro", symbol: "‚Ç¨", code: "EUR" },
                { name: "British Pound", symbol: "¬£", code: "GBP" },
                { name: "Japanese Yen", symbol: "¬•", code: "JPY" },
                { name: "Chinese Yuan", symbol: "¬•", code: "CNY" },
                { name: "Australian Dollar", symbol: "A$", code: "AUD" },
                { name: "Canadian Dollar", symbol: "C$", code: "CAD" }
            ];

            // --- DOM Elements ---
            const expenseForm = document.getElementById('expense-form');
            const expenseTableBody = document.getElementById('expense-table-body');
            const totalAmountDisplay = document.getElementById('total-amount');
            const expenseSummaryContent = document.getElementById('expense-summary-content');
            const sendEmailBtn = document.getElementById('send-email-btn');
            const clearDataBtn = document.getElementById('clear-data-btn');
            const categoryFilter = document.getElementById('category-filter');
            const startDateFilter = document.getElementById('start-date-filter');
            const endDateFilter = document.getElementById('end-date-filter');
            const toastContainer = document.getElementById('toast-container');
            const addCategoryBtn = document.getElementById('add-category-btn');
            const welcomeMessageElement = document.getElementById('welcome-message'); 

            // Modals and their forms
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            const addCategoryModal = document.getElementById('add-category-modal');
            const addCategoryForm = document.getElementById('add-category-form');
            const clearConfirmModal = document.getElementById('clear-confirm-modal');
            const confirmClearDataBtn = document.getElementById('confirm-clear-data-btn');
            
            // Developer Info Modal Elements
            const developerModal = document.getElementById('developer-modal');
            const devInfoButton = document.getElementById('dev-info-button');

            // New: Settings Modal Elements
            const settingsModal = document.getElementById('settings-modal');
            const settingsButton = document.getElementById('settings-button');
            const currencySelect = document.getElementById('currency-select');
            const themeToggle = document.getElementById('theme-toggle');


            // --- State Variables ---
            let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
            let categories = JSON.parse(localStorage.getItem('categories')) || DEFAULT_CATEGORIES;
            let sortConfig = JSON.parse(localStorage.getItem('sortConfig')) || { key: 'date', direction: 'desc' }; 
            let currentEditId = null;

            // New: Current currency symbol, initialized from local storage or default
            let currentCurrencySymbol = localStorage.getItem('selectedCurrencySymbol') || '‚Çπ';
            document.documentElement.style.setProperty('--current-currency-symbol', `'${currentCurrencySymbol}'`); // Update CSS variable


            // --- Helper Functions ---
            const stripEmojis = (str) => {
                return str.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{2300}-\u{23FF}\u{2B00}-\u{2BFF}\u{25AA}-\u{25FE}\u{FE0F}]/gu, '').trim();
            };

            const toLocalDateInput = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString + 'T00:00:00Z'); 
                return date.toISOString().split('T')[0]; 
            };

            const formatCurrency = (amount) => {
                // Use the globally set currentCurrencySymbol
                return `${currentCurrencySymbol}${parseFloat(amount).toFixed(2)}`;
            };

            const showToast = (message, type = 'info', duration = 3000) => {
                const toast = document.createElement('div');
                toast.classList.add('toast', type);
                
                let icon = '';
                if (type === 'success') icon = '<i class="fas fa-check-circle" aria-hidden="true"></i>';
                else if (type === 'error') icon = '<i class="fas fa-times-circle" aria-hidden="true"></i>';
                else if (type === 'info') icon = '<i class="fas fa-info-circle" aria-hidden="true"></i>';

                toast.innerHTML = `${icon} <span>${message}</span>`;
                toastContainer.appendChild(toast);

                toast.classList.add('show'); 

                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.classList.add('hide-effect'); 
                    setTimeout(() => toast.remove(), 10); 
                }, duration);
            };

            const showModal = (modalElement) => {
                modalElement.classList.add('active'); 
                setTimeout(() => { 
                    const firstInput = modalElement.querySelector('input, select, textarea, button:not(.cancel-modal-btn)');
                    if (firstInput) {
                        firstInput.focus();
                    } else {
                        modalElement.querySelector('.modal-content').focus();
                    }
                }, 1); 
            };

            const closeModal = (modalElement) => {
                modalElement.classList.remove('active'); 
                const formInModal = modalElement.querySelector('form');
                if (formInModal) {
                    clearValidationErrors(formInModal);
                    formInModal.reset();
                }
            };

            // NEW: Theme and Currency functions
            const applyTheme = (themeName) => {
                const body = document.body;
                if (themeName === 'light') {
                    body.classList.add('light-mode');
                    body.dataset.theme = 'light';
                    themeToggle.checked = true; // Ensure toggle is checked for light mode
                } else {
                    body.classList.remove('light-mode');
                    body.dataset.theme = 'dark';
                    themeToggle.checked = false; // Ensure toggle is unchecked for dark mode
                }
                localStorage.setItem('theme', themeName);
            };

            const initializeTheme = () => {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme) {
                    applyTheme(savedTheme);
                } else {
                    // Detect system preference and apply default accordingly
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                        applyTheme('light');
                    } else {
                        applyTheme('dark'); // Default to dark if no preference or system is dark
                    }
                }
            };

            const populateCurrencyDropdown = () => {
                currencySelect.innerHTML = ''; // Clear existing options
                CURRENCY_OPTIONS.forEach(currency => {
                    const option = document.createElement('option');
                    option.value = currency.symbol;
                    option.textContent = `${currency.symbol} ${currency.code} (${currency.name})`;
                    currencySelect.appendChild(option);
                });

                // Set selected value from localStorage or default to INR
                const savedCurrencySymbol = localStorage.getItem('selectedCurrencySymbol') || '‚Çπ';
                if (Array.from(currencySelect.options).some(opt => opt.value === savedCurrencySymbol)) {
                    currencySelect.value = savedCurrencySymbol;
                } else {
                    currencySelect.value = '‚Çπ'; // Fallback to INR if saved symbol is not found
                }
                // Update global symbol variable and CSS custom property
                currentCurrencySymbol = currencySelect.value;
                document.documentElement.style.setProperty('--current-currency-symbol', `'${currentCurrencySymbol}'`);
            };

            const handleCurrencyChange = () => {
                currentCurrencySymbol = currencySelect.value;
                localStorage.setItem('selectedCurrencySymbol', currentCurrencySymbol);
                document.documentElement.style.setProperty('--current-currency-symbol', `'${currentCurrencySymbol}'`);
                // Re-render UI elements that display currency
                updateTotal();
                renderExpenses(); // Re-render table rows to update currency symbol
                updateExpenseSummary();
            };


            const persistExpensesToLocalStorage = () => {
                localStorage.setItem('expenses', JSON.stringify(expenses));
            };

            const saveCategories = () => {
                localStorage.setItem('categories', JSON.stringify(categories));
                populateCategoryDropdowns();
            };

            const validateInput = (inputElement) => {
                const errorMessageElement = inputElement.closest('.form-control')?.querySelector('.error-message');
                let isValid = true;
                let errorMessage = '';

                if (inputElement.required && inputElement.value.trim() === '') {
                    isValid = false;
                    errorMessage = 'This field is required.';
                } 
                else if (inputElement.type === 'number') {
                    const value = parseFloat(inputElement.value);
                    if (isNaN(value)) {
                        isValid = false;
                        errorMessage = 'Must be a valid number.';
                    } else if (value < 0) {
                        isValid = false;
                        errorMessage = 'Value cannot be negative.';
                    } else if (inputElement.min && value < parseFloat(inputElement.min)) {
                         isValid = false;
                        errorMessage = `Must be at least ${parseFloat(inputElement.min)}.`;
                    }
                } 
                else if (inputElement.id === 'new-category-name') {
                    const cleanedNewCatName = stripEmojis(inputElement.value);
                    const categoryExists = categories.some(cat => 
                        stripEmojis(cat).toLowerCase() === cleanedNewCatName.toLowerCase()
                    );

                    if (categoryExists) {
                        isValid = false;
                        errorMessage = 'Category already exists!';
                    }
                }
                else if (inputElement.id === 'start-date-filter' || inputElement.id === 'end-date-filter') {
                    const startVal = startDateFilter.value;
                    const endVal = endDateFilter.value;

                    const clearDateErrors = () => {
                        startDateFilter.classList.remove('invalid');
                        if (startDateFilter.closest('.form-control')?.querySelector('.error-message')) startDateFilter.closest('.form-control').querySelector('.error-message').textContent = '';
                        endDateFilter.classList.remove('invalid');
                        if (endDateFilter.closest('.form-control')?.querySelector('.error-message')) endDateFilter.closest('.form-control').querySelector('.error-message').textContent = '';
                    };
                    clearDateErrors();

                    if (startVal && endVal) {
                        const start = new Date(startVal + 'T00:00:00Z');
                        const end = new Date(endVal + 'T00:00:00Z');
                        if (start > end) {
                            isValid = false;
                            errorMessage = 'End date cannot be before start date.';
                            startDateFilter.classList.add('invalid');
                            if (startDateFilter.closest('.form-control')?.querySelector('.error-message')) startDateFilter.closest('.form-control').querySelector('.error-message').textContent = errorMessage;
                            endDateFilter.classList.add('invalid');
                            if (endDateFilter.closest('.form-control')?.querySelector('.error-message')) endDateFilter.closest('.form-control').querySelector('.error-message').textContent = errorMessage;
                        }
                    }
                    if (inputElement.id === 'start-date-filter' || inputElement.id === 'end-date-filter') return isValid;
                }

                if (!isValid) {
                    inputElement.classList.add('invalid');
                    if (errorMessageElement) {
                        errorMessageElement.textContent = errorMessage;
                        errorMessageElement.style.opacity = 1;
                    }
                } else {
                    inputElement.classList.remove('invalid');
                    if (errorMessageElement) {
                        errorMessageElement.textContent = '';
                        errorMessageElement.style.opacity = 0;
                    }
                }
                return isValid;
            };

            const validateForm = (formElement) => {
                let allValid = true;
                const inputs = formElement.querySelectorAll('input[required], select[required], input[type="number"], #new-category-name'); 
                inputs.forEach(input => {
                    if (!validateInput(input)) {
                        allValid = false;
                    }
                });
                return allValid;
            };

            const clearValidationErrors = (formElement) => {
                formElement.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
                formElement.querySelectorAll('.error-message').forEach(el => {
                    el.textContent = '';
                    el.style.opacity = 0;
                });
            };

            const createExpenseRow = (expense) => {
                const tr = document.createElement('tr');
                tr.className = 'expense-item';
                tr.dataset.id = expense.id; 
                
                const date = new Date(expense.date + 'T00:00:00Z'); 
                const formattedDate = date.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'UTC' });
                
                tr.innerHTML = `
                    <td data-label="Date">${formattedDate}</td>
                    <td data-label="Category">${stripEmojis(expense.category)}</td> 
                    <td data-label="Description">${expense.description}</td>
                    <td data-label="Amount" class="col-amount">${formatCurrency(expense.amount)}</td>
                    <td data-label="Actions" class="col-actions">
                        <button class="action-btn edit-btn" data-id="${expense.id}" title="Edit" aria-label="Edit expense"><i class="fas fa-edit" aria-hidden="true"></i></button>
                        <button class="action-btn duplicate-btn" data-id="${expense.id}" title="Duplicate" aria-label="Duplicate expense"><i class="fas fa-copy" aria-hidden="true"></i></button>
                        <button class="action-btn delete-btn" data-id="${expense.id}" title="Delete" aria-label="Delete expense"><i class="fas fa-trash" aria-hidden="true"></i></button>
                    </td>
                `;
                return tr;
            };

            const renderExpenses = () => {
                const expensesToRender = getFilteredAndSortedExpenses(); 
                expenseTableBody.innerHTML = ''; 

                if (expensesToRender.length === 0) {
                    const message = expenses.length === 0 
                        ? 'No expenses added yet. Start by using the form above! üìù' 
                        : 'No expenses match your current filters and date range. üßê Try adjusting your filters!';
                    expenseTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 25px 0; color: rgba(255,255,255,0.7);">${message}</td></tr>`;
                } else {
                    expensesToRender.forEach((expense) => { 
                        const tr = createExpenseRow(expense);
                        expenseTableBody.appendChild(tr);
                    });
                }
                updateSortIcons();
            };

            const updateExpenseTableAndSummary = () => {
                renderExpenses();
                updateTotal();
                updateExpenseSummary();
            };

            const populateCategoryDropdowns = () => {
                const dropdowns = [
                    document.getElementById('expense-category'),
                    document.getElementById('edit-category'),
                    document.getElementById('category-filter')
                ];
                
                dropdowns.forEach((dropdown, index) => {
                    const currentSelected = dropdown.value; 
                    dropdown.innerHTML = ''; 

                    if (index === 2) { 
                        const allOption = document.createElement('option');
                        allOption.value = 'all';
                        allOption.textContent = 'All Categories'; 
                        dropdown.appendChild(allOption);
                    }

                    categories.slice().sort((a, b) => {
                        const cleanA = stripEmojis(a);
                        const cleanB = stripEmojis(b);
                        return cleanA.localeCompare(cleanB);
                    }).forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat; 
                        option.textContent = stripEmojis(cat); 
                        dropdown.appendChild(option);
                    });

                    if (Array.from(dropdown.options).some(opt => opt.value === currentSelected)) {
                        dropdown.value = currentSelected;
                    } else if (index === 2) { 
                        dropdown.value = 'all';
                    } else if (dropdown.options.length > 0) { 
                        dropdown.value = dropdown.options[0].value;
                    }
                });
            };

            const updateTotal = () => {
                const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
                totalAmountDisplay.textContent = formatCurrency(total);
            };

            const updateExpenseSummary = () => {
                const summaryContentDiv = document.getElementById('expense-summary-content');
                let newSummaryHtml = '';

                if (expenses.length === 0) {
                    newSummaryHtml = `
                        <p style="text-align: center; color: rgba(255,255,255,0.7); border: none; background: none;">
                            <i class="fas fa-hand-holding-usd" style="margin-right: 8px;" aria-hidden="true"></i> Start by adding your first expense to see your financial summary here! üöÄ
                        </p>
                    `;
                } else {
                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const currentMonth = now.getMonth();

                    const getExpensesForMonth = (year, month) => {
                        return expenses.filter(exp => {
                            const expDate = new Date(exp.date + 'T00:00:00Z'); 
                            return expDate.getUTCFullYear() === year && expDate.getUTCMonth() === month;
                        });
                    };

                    const calculateSpendingByCategory = (expenseList) => {
                        return expenseList.reduce((acc, exp) => {
                            const categoryName = stripEmojis(exp.category);
                            acc[categoryName] = (acc[categoryName] || 0) + exp.amount;
                            return acc;
                        }, {});
                    };

                    const currentMonthExpenses = getExpensesForMonth(currentYear, currentMonth);
                    const totalCurrentMonthSpent = currentMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                    const currentMonthSpendingByCategory = calculateSpendingByCategory(currentMonthExpenses);

                    let lastMonth = currentMonth - 1;
                    let lastYear = currentYear;
                    if (lastMonth < 0) {
                        lastMonth = 11; 
                        lastYear--;
                    }
                    const lastMonthExpenses = getExpensesForMonth(lastYear, lastMonth);
                    const totalLastMonthSpent = lastMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                    const lastMonthSpendingByCategory = calculateSpendingByCategory(lastMonthExpenses);

                    let monthlyComparisonHtml = '';
                    const currentMonthName = now.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                    const lastMonthName = new Date(lastYear, lastMonth).toLocaleString('en-US', { month: 'long', year: 'numeric' });

                    if (totalCurrentMonthSpent > 0 && totalLastMonthSpent === 0) {
                        monthlyComparisonHtml = `
                            <p><i class="fas fa-money-bill-wave" aria-hidden="true"></i> In ${currentMonthName}, you've spent <strong>${formatCurrency(totalCurrentMonthSpent)}</strong>. Great start to your tracking journey! üí∞</p>
                        `;
                    } else if (totalCurrentMonthSpent > totalLastMonthSpent) {
                        const diff = totalCurrentMonthSpent - totalLastMonthSpent;
                        const percentage = (diff / (totalLastMonthSpent || 1)) * 100; 
                        monthlyComparisonHtml = `
                            <p class="bad-news">
                                <i class="fas fa-arrow-trend-up" aria-hidden="true"></i> Your spending in ${currentMonthName} is <strong>${formatCurrency(diff)} (${percentage.toFixed(1)}% higher)</strong> than ${lastMonthName}'s ${formatCurrency(totalLastMonthSpent)}. Let's review where that extra cash went! üí∏
                            </p>
                        `;
                    } else if (totalCurrentMonthSpent < totalLastMonthSpent && totalCurrentMonthSpent >= 0) { 
                        const diff = totalLastMonthSpent - totalCurrentMonthSpent;
                        const percentage = (diff / totalLastMonthSpent) * 100;
                        monthlyComparisonHtml = `
                            <p class="good-news">
                                <i class="fas fa-arrow-trend-down" aria-hidden="true"></i> Excellent! You spent <strong>${formatCurrency(diff)} (${percentage.toFixed(1)}% less)</strong> in ${currentMonthName} compared to ${lastMonthName}'s ${formatCurrency(totalLastMonthSpent)}. Keep up the smart saving! ‚ú®
                            </p>
                        `;
                    } else if (totalCurrentMonthSpent === totalLastMonthSpent && totalCurrentMonthSpent > 0) {
                        monthlyComparisonHtml = `
                            <p><i class="fas fa-balance-scale-left" aria-hidden="true"></i> Your spending in ${currentMonthName} is consistent with ${lastMonthName}, totaling around <strong>${formatCurrency(totalCurrentMonthSpent)}</strong>. Steady financial management! üëç</p>
                        `;
                    } else { 
                        monthlyComparisonHtml = `
                            <p><i class="fas fa-calendar-alt" aria-hidden="true"></i> No spending recorded for ${currentMonthName} or ${lastMonthName}. Let's get tracking your next expenses! üßê</p>
                        `;
                    }
                    newSummaryHtml += monthlyComparisonHtml;

                    if (currentMonthExpenses.length > 0) {
                        const sortedCategories = Object.entries(currentMonthSpendingByCategory)
                            .sort(([, a], [, b]) => b - a)
                            .slice(0, 3); 

                        if (sortedCategories.length > 0) {
                            const topCategoriesText = sortedCategories.map(([category, amount]) => {
                                const percentOfTotal = (amount / totalCurrentMonthSpent) * 100;
                                return `<strong>${stripEmojis(category)}</strong> (${formatCurrency(amount)}, ${percentOfTotal.toFixed(1)}% of total)`;
                            }).join(', ');
                            newSummaryHtml += `
                                <p><i class="fas fa-boxes" aria-hidden="true"></i> Your top ${sortedCategories.length} spending areas this month: ${topCategoriesText}.
                                Knowing these can help you identify where to focus for potential savings! üí°</p>
                            `;
                        }
                        
                        const categoryChanges = [];
                        const changeThreshold = 50; 
                        const minAmountThreshold = 500; 

                        for (const category in currentMonthSpendingByCategory) {
                            const currentMonthAmount = currentMonthSpendingByCategory[category];
                            const lastMonthAmount = lastMonthSpendingByCategory[category] || 0;

                            if (currentMonthAmount >= minAmountThreshold) { 
                                if (lastMonthAmount > 0) { 
                                    const percentageChange = ((currentMonthAmount - lastMonthAmount) / lastMonthAmount) * 100;
                                    if (percentageChange > changeThreshold) {
                                        categoryChanges.push(`<strong>${stripEmojis(category)}</strong> (up ${percentageChange.toFixed(0)}%)`);
                                    }
                                } else { 
                                    categoryChanges.push(`<strong>${stripEmojis(category)}</strong> (new significant spending)`);
                                }
                            }
                        }

                        if (categoryChanges.length > 0) {
                            newSummaryHtml += `
                                <p class="bad-news">
                                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i> You might want to check your spending in: ${categoryChanges.join(', ')}. 
                                    These areas saw significant changes recently. üò¨
                                </p>
                            `;
                        }

                        const largestExpense = currentMonthExpenses.reduce((max, exp) => (exp.amount > (max ? max.amount : 0)) ? exp : max, null);
                        if (largestExpense) {
                            newSummaryHtml += `
                                <p><i class="fas fa-hand-holding-usd" aria-hidden="true"></i> Your single largest expense this month was <strong>${formatCurrency(largestExpense.amount)}</strong> for "${largestExpense.description}" in "${stripEmojis(largestExpense.category)}". Big spending calls for careful consideration! üí∏</p>
                            `;
                        }
                    } else {
                        newSummaryHtml += `<p><i class="fas fa-smile-beam" aria-hidden="true"></i> No spending recorded for ${currentMonthName} yet. A fresh start for tracking your finances! üÜï</p>`;
                    }

                    newSummaryHtml += `
                        <p style="border:none; margin-top:18px; text-align:center; font-style: italic; font-size: 0.85rem; color: rgba(255,255,255,0.6); background: none; padding-top: 5px; padding-bottom: 5px;">
                            *Insights based on available data and general spending patterns. Always cross-check!*
                        </p>
                    `;
                }

                if (summaryContentDiv.innerHTML.trim() !== newSummaryHtml.trim()) {
                    summaryContentDiv.innerHTML = newSummaryHtml;
                }
            };

            const updateSortIcons = () => {
                document.querySelectorAll('.expense-table th').forEach(header => {
                    const sortKey = header.dataset.sortBy;
                    const iconSpan = header.querySelector('.sort-icon');
                    if (iconSpan) {
                        let icon = '';
                        if (sortKey === sortConfig.key) {
                            icon = sortConfig.direction === 'asc' ? ' ‚Üë' : ' ‚Üì';
                            header.classList.add('sorted');
                        } else {
                            header.classList.remove('sorted');
                        }
                        iconSpan.textContent = icon;
                    }
                });
            };

            const updateWelcomeMessage = () => {
                let userName = localStorage.getItem('userName');
                if (!userName) {
                    userName = prompt("üëã Welcome to your Smart Expense Tracker! What's your name?");
                    if (userName) {
                        localStorage.setItem('userName', userName.trim());
                    } else {
                        userName = "Guest";
                    }
                }
                welcomeMessageElement.textContent = `Hello, ${userName}! Let's track your expenses. üìä`;
            };
            
            document.getElementById('expense-date').valueAsDate = new Date();

            expenseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!validateForm(expenseForm)) {
                    showToast('Please correct the highlighted fields.', 'error');
                    return;
                }

                const newExpense = {
                    id: Date.now(), 
                    date: toLocalDateInput(document.getElementById('expense-date').value),
                    category: document.getElementById('expense-category').value, 
                    description: document.getElementById('expense-description').value.trim(),
                    amount: parseFloat(document.getElementById('expense-amount').value),
                };
                
                expenses.unshift(newExpense); 
                persistExpensesToLocalStorage();

                const newRow = createExpenseRow(newExpense);
                const expensesToRender = getFilteredAndSortedExpenses();
                if (expensesToRender[0] && expensesToRender[0].id === newExpense.id) {
                     expenseTableBody.prepend(newRow);
                     if (expenseTableBody.querySelector('td[colspan="5"]')) {
                        expenseTableBody.querySelector('td[colspan="5"]').parentElement.remove();
                    }
                } else {
                    renderExpenses(); 
                }

                updateTotal();
                updateExpenseSummary();
                expenseForm.reset();
                document.getElementById('expense-date').valueAsDate = new Date(); 
                clearValidationErrors(expenseForm);
                showToast('Expense Added Successfully! ‚úÖ', 'success');
            });

            expenseTableBody.addEventListener('click', (e) => {
                const button = e.target.closest('.action-btn');
                if (!button) return;

                const id = parseInt(button.dataset.id);
                const expenseIndex = expenses.findIndex(exp => exp.id === id);
                if (expenseIndex === -1) {
                    showToast('Expense not found! ü§∑', 'error');
                    return;
                }

                const row = button.closest('tr'); 

                if (button.classList.contains('delete-btn')) {
                    if(row) { 
                        expenses.splice(expenseIndex, 1);
                        persistExpensesToLocalStorage();
                        row.remove(); 
                        updateTotal();
                        updateExpenseSummary();
                        if (expenseTableBody.children.length === 0 || (expenseTableBody.children.length === 1 && expenseTableBody.children[0].tagName === 'TR' && expenseTableBody.children[0].children[0].getAttribute('colspan') === '5')) {
                            renderExpenses(); 
                        }
                        showToast('Expense Deleted. üóëÔ∏è', 'info');
                    }
                } else if (button.classList.contains('duplicate-btn')) {
                    const expenseToDuplicate = expenses[expenseIndex];
                    const duplicatedExpense = { 
                        ...expenseToDuplicate, 
                        id: Date.now(), 
                        date: toLocalDateInput(new Date().toISOString()), 
                        description: `(Copy) ${expenseToDuplicate.description}`
                    };
                    
                    expenses.unshift(duplicatedExpense);
                    persistExpensesToLocalStorage();

                    const newRow = createExpenseRow(duplicatedExpense);
                    const expensesToRender = getFilteredAndSortedExpenses();
                    if (expensesToRender[0] && expensesToRender[0].id === duplicatedExpense.id) {
                         expenseTableBody.prepend(newRow);
                         if (expenseTableBody.querySelector('td[colspan="5"]')) {
                            expenseTableBody.querySelector('td[colspan="5"]').parentElement.remove();
                        }
                    } else {
                        renderExpenses(); 
                    }
                    
                    updateTotal();
                    updateExpenseSummary();
                    showToast('Expense Duplicated! üìã', 'info');

                } else if (button.classList.contains('edit-btn')) {
                    const expenseToEdit = expenses[expenseIndex];
                    currentEditId = id;
                    document.getElementById('edit-date').value = toLocalDateInput(expenseToEdit.date);
                    document.getElementById('edit-category').value = expenseToEdit.category;
                    document.getElementById('edit-description').value = expenseToEdit.description;
                    document.getElementById('edit-amount').value = expenseToEdit.amount;
                    clearValidationErrors(editForm);
                    showModal(editModal);
                }
            });

            editForm.addEventListener('submit', e => {
                e.preventDefault();
                if (!validateForm(editForm)) {
                    showToast('Please correct the highlighted fields. ‚ùå', 'error');
                    return;
                }

                const expenseIndex = expenses.findIndex(exp => exp.id === currentEditId);
                if (expenseIndex > -1) {
                    const updatedExpense = {
                        id: currentEditId,
                        date: toLocalDateInput(document.getElementById('edit-date').value),
                        category: document.getElementById('edit-category').value, 
                        description: document.getElementById('edit-description').value.trim(),
                        amount: parseFloat(document.getElementById('edit-amount').value),
                    };
                    expenses[expenseIndex] = updatedExpense;
                    persistExpensesToLocalStorage();

                    const existingRow = expenseTableBody.querySelector(`tr[data-id="${currentEditId}"]`);
                    if (existingRow) {
                        const date = new Date(updatedExpense.date + 'T00:00:00Z'); 
                        const formattedDate = date.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'UTC' });

                        existingRow.children[0].textContent = formattedDate;
                        existingRow.children[1].textContent = stripEmojis(updatedExpense.category);
                        existingRow.children[2].textContent = updatedExpense.description;
                        existingRow.children[3].textContent = formatCurrency(updatedExpense.amount);
                    } else {
                        renderExpenses();
                    }
                    
                    updateTotal();
                    updateExpenseSummary();
                    showToast('Changes Saved! ‚ú®', 'success');
                }
                closeModal(editModal);
                currentEditId = null;
            });

            addCategoryBtn.addEventListener('click', () => {
                clearValidationErrors(addCategoryForm);
                document.getElementById('new-category-name').value = '';
                showModal(addCategoryModal);
            });

            addCategoryForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newCatNameInput = document.getElementById('new-category-name');
                const newCategoryName = newCatNameInput.value.trim(); 

                if (!validateInput(newCatNameInput)) return; 
                
                categories.push(stripEmojis(newCategoryName)); 
                saveCategories();
                closeModal(addCategoryModal);
                showToast(`Category "${newCategoryName}" Added! üéâ`, 'success');
            });
            
            // Centralized modal closing for all modal close buttons
            document.querySelectorAll('.cancel-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const parentModal = e.target.closest('.modal-overlay');
                    if (parentModal) closeModal(parentModal);
                });
            });

            clearDataBtn.addEventListener('click', () => {
                const isCategoriesDefault = JSON.stringify([...categories].map(c => stripEmojis(c)).sort()) === JSON.stringify([...DEFAULT_CATEGORIES].sort());
                const hasExpenses = expenses.length > 0;

                if (!hasExpenses && isCategoriesDefault) {
                    showToast('No user data to clear. üßπ', 'info');
                    return;
                }
                showModal(clearConfirmModal);
            });

            confirmClearDataBtn.addEventListener('click', () => {
                expenses = [];
                categories = [...DEFAULT_CATEGORIES]; 
                localStorage.clear(); // Clears all local storage including user name, theme, currency etc.

                // Re-initialize specific preferences
                sortConfig = { key: 'date', direction: 'desc' };
                localStorage.setItem('sortConfig', JSON.stringify(sortConfig));
                
                persistExpensesToLocalStorage(); 
                saveCategories();
                updateWelcomeMessage(); 
                
                categoryFilter.value = 'all';
                startDateFilter.value = '';
                endDateFilter.value = '';
                updateExpenseTableAndSummary(); 

                closeModal(clearConfirmModal);
                showToast('All expense data cleared! ‚úÖ', 'success');
            });

            categoryFilter.addEventListener('change', updateExpenseTableAndSummary);
            startDateFilter.addEventListener('change', () => { 
                validateInput(startDateFilter); 
                validateInput(endDateFilter); 
                updateExpenseTableAndSummary(); 
            });
            endDateFilter.addEventListener('change', () => { 
                validateInput(endDateFilter); 
                validateInput(startDateFilter); 
                updateExpenseTableAndSummary(); 
            });

            document.querySelectorAll('.expense-table th[data-sort-by]').forEach(header => {
                header.addEventListener('click', () => {
                    const newSortKey = header.dataset.sortBy;
                    if (sortConfig.key === newSortKey) {
                        sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortConfig.key = newSortKey;
                        if (newSortKey === 'date' || newSortKey === 'amount') {
                            sortConfig.direction = 'desc'; 
                        } else {
                            sortConfig.direction = 'asc'; 
                        }
                    }
                    localStorage.setItem('sortConfig', JSON.stringify(sortConfig));
                    updateExpenseTableAndSummary(); 
                });
            });

            const getFilteredAndSortedExpenses = () => {
                const filterValue = categoryFilter.value;
                const start = startDateFilter.value ? new Date(startDateFilter.value + 'T00:00:00Z') : null;
                const end = endDateFilter.value ? new Date(endDateFilter.value + 'T00:00:00Z') : null;

                let filtered = [...expenses]; 

                if (filterValue !== 'all') {
                    filtered = filtered.filter(exp => stripEmojis(exp.category) === stripEmojis(filterValue));
                }
                if (start && !isNaN(start.getTime())) { 
                    filtered = filtered.filter(exp => new Date(exp.date + 'T00:00:00Z') >= start);
                }
                if (end && !isNaN(end.getTime())) { 
                    const endOfDay = new Date(end.valueOf()); 
                    endOfDay.setUTCHours(23, 59, 59, 999);
                    filtered = filtered.filter(exp => new Date(exp.date + 'T00:00:00Z') <= endOfDay);
                }

                filtered.sort((a, b) => {
                    let valA, valB;
                    if (sortConfig.key === 'date') {
                        valA = new Date(a.date);
                        valB = new Date(b.date);
                    } else if (sortConfig.key === 'amount') {
                        valA = a.amount;
                        valB = b.amount;
                    } else {
                        valA = stripEmojis(String(a[sortConfig.key])).toLowerCase(); 
                        valB = stripEmojis(String(b[sortConfig.key])).toLowerCase();
                    }

                    if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
                
                return filtered;
            };

            sendEmailBtn.addEventListener('click', () => {
                const expensesToReport = getFilteredAndSortedExpenses();
                if (expensesToReport.length === 0) {
                    showToast('There are no expenses to report matching your current filters. üßê', 'info');
                    return;
                }

                const email = prompt("üìß Please enter your email address to send the report:");
                if (!email) { showToast("Email sending cancelled. ‚ùå", 'info'); return; }
                if (!email.includes('@')) { showToast("Please enter a valid email address. ‚ö†Ô∏è", 'error'); return; }
                
                const userName = localStorage.getItem('userName') || "User";
                const totalReportAmount = expensesToReport.reduce((sum, expense) => sum + expense.amount, 0);

                let dateRange = "All Time";
                let currentMonthYear = '';
                const startDate = startDateFilter.value ? new Date(startDateFilter.value + 'T00:00:00Z') : null;
                const endDate = endDateFilter.value ? new Date(endDateFilter.value + 'T00:00:00Z') : null;

                if (startDate && endDate) {
                    dateRange = `${startDate.toLocaleDateString('en-US', {day:'numeric', month:'short', year:'numeric', timeZone:'UTC'})} - ${endDate.toLocaleDateString('en-US', {day:'numeric', month:'short', year:'numeric', timeZone:'UTC'})}`;
                } else if (startDate) {
                    dateRange = `From ${startDate.toLocaleDateString('en-US', {day:'numeric', month:'short', year:'numeric', timeZone:'UTC'})}`;
                } else if (endDate) {
                    dateRange = `To ${endDate.toLocaleDateString('en-US', {day:'numeric', month:'short', year:'numeric', timeZone:'UTC'})}`;
                } else {
                     if (expensesToReport.length > 0) {
                        const firstDate = new Date(expensesToReport[0].date + 'T00:00:00Z');
                        const lastDate = new Date(expensesToReport[expensesToReport.length - 1].date + 'T00:00:00Z');
                        if (firstDate.getUTCMonth() === lastDate.getUTCMonth() && firstDate.getUTCFullYear() === lastDate.getUTCFullYear()) {
                            dateRange = `${firstDate.toLocaleDateString('en-US', {month:'long', year:'numeric', timeZone:'UTC'})}`;
                            currentMonthYear = dateRange; 
                        }
                    }
                }

                const spendingByCategoryReport = expensesToReport.reduce((acc, exp) => {
                    const categoryName = stripEmojis(exp.category); 
                    acc[categoryName] = (acc[categoryName] || 0) + exp.amount;
                    return acc;
                }, {});

                const sortedTopCategories = Object.entries(spendingByCategoryReport)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 3); 

                let topCategoriesSummary = '';
                if (sortedTopCategories.length > 0) {
                    topCategoriesSummary = sortedTopCategories.map(([cat, amount]) => {
                        const percent = (amount / totalReportAmount) * 100;
                        return `- ${cat}: ${formatCurrency(amount)} (${percent.toFixed(1)}%)`;
                    }).join('\n');
                } else {
                    topCategoriesSummary = 'No categorized spending for this period.';
                }
                
                let subject = 'Smart Expense Tracker Report';
                if (currentMonthYear) {
                    subject = `${currentMonthYear} Expense Report - Smart Expense Tracker`;
                } else if (dateRange !== 'All Time') {
                    subject += ` (${dateRange})`;
                }

                let body = '';
                body += `Dear ${userName},\n\n`;
                body += `Here is your detailed expense report for the period: ${dateRange}.\n\n`;
                body += `--- REPORT SUMMARY ---\n`;
                body += `Total Spending: ${formatCurrency(totalReportAmount)}\n\n`;
                body += `Top Categories:\n${topCategoriesSummary}\n`;
                body += `----------------------\n\n`;

                body += `--- DETAILED EXPENSES ---\n\n`;
                body += `Date       Category         Description                 Amount\n`;
                body += `---------- --------------- ---------------------------- ----------\n`;
                expensesToReport.forEach(expense => {
                    const date = new Date(expense.date + 'T00:00:00Z'); 
                    const formattedDate = date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: '2-digit', timeZone: 'UTC' });
                    
                    const paddedDescription = expense.description.length > 25 ? expense.description.substring(0, 22) + '...' : expense.description;

                    body += `${formattedDate.padEnd(11)}`; 
                    body += `${stripEmojis(expense.category).padEnd(16)}`; 
                    body += `${paddedDescription.padEnd(29)}`; 
                    body += `${formatCurrency(expense.amount).padStart(10)}\n`; 
                });
                body += `-----------------------------------------------------------\n`;
                body += `TOTAL:                                                ${formatCurrency(totalReportAmount).padStart(10)}\n`;
                body += `===========================================================\n\n`;

                let filtersApplied = [];
                if (categoryFilter.value !== 'all') { filtersApplied.push(`Category: ${stripEmojis(categoryFilter.value)}`); } 
                if (startDateFilter.value) { filtersApplied.push(`From Date: ${toLocalDateInput(startDateFilter.value)}`); }
                if (endDateFilter.value) { filtersApplied.push(`To Date: ${toLocalDateInput(endDateFilter.value)}`); }

                if (filtersApplied.length > 0) {
                    body += `Note: This report includes data filtered by: ${filtersApplied.join(', ')}.\n\n`;
                }
                
                body += `We hope this report helps you in managing your finances effectively!\n`;
                body += `\nBest regards,\nYour Smart Expense Tracker Team\n`;
                body += `\nThis report was generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}.`;
                
                const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoLink;
                
                showToast('Attempting to open email client with report... üìß', 'info', 3000);
                
                setTimeout(() => {
                    const userConfirmedCopy = confirm("Your email client should have opened now. If it didn't, would you like to copy the report text to your clipboard instead?");
                    if (userConfirmedCopy) {
                        navigator.clipboard.writeText(body)
                            .then(() => showToast('Report copied to clipboard! üìã', 'success', 4000))
                            .catch(err => showToast('Failed to copy report to clipboard: ' + err + ' ‚ùå', 'error', 4000));
                    }
                }, 1000); 
            });

            document.querySelectorAll('input[required], select[required], input[type="number"], #new-category-name').forEach(input => {
                input.addEventListener('blur', () => validateInput(input));
                input.addEventListener('input', () => { 
                    if (input.classList.contains('invalid')) { 
                        validateInput(input);
                    }
                });
            });

            // Event listener for Developer Info button
            devInfoButton.addEventListener('click', () => {
                showModal(developerModal);
            });

            // NEW: Event listener for Settings button
            settingsButton.addEventListener('click', () => {
                showModal(settingsModal);
            });

            // NEW: Event listener for Theme Toggle
            themeToggle.addEventListener('change', () => {
                applyTheme(themeToggle.checked ? 'light' : 'dark');
            });

            // NEW: Event listener for Currency Select
            currencySelect.addEventListener('change', handleCurrencyChange);


            const initializeApp = () => {
                initializeTheme(); // Apply theme first
                updateWelcomeMessage(); 
                populateCategoryDropdowns();
                populateCurrencyDropdown(); // Populate currency dropdown and set initial value
                document.getElementById('expense-date').valueAsDate = new Date(); 
                renderExpenses(); 
                updateTotal();
                updateExpenseSummary(); 
            };

            initializeApp();
        });
    </script>
</body>
</html>