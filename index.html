<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- MODIFIED: Changed viewport width to a fixed desktop value -->
    <meta name="viewport" content="width=1024"> 
    <title>My Smart Expense Tracker 💰</title>
    <link rel="icon" type="image/png" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3e%3cpath fill='%23f1c40f' d='M19 12h-6V6h-2v6H5v2h6v6h2v-6h6z'/%3e%3c/svg%3e">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /*
            ✨ BEST-IN-CLASS UI ENHANCEMENTS & ANIMATIONS ✨
            - Extensive Emoji Integration: In headings, welcome message, categories, buttons, summaries, and toasts.
            - Refined Glassmorphism: Improved shadows, borders, and active states for a more premium feel.
            - Dynamic Animations:
                - Animated button hovers (transform, shadow).
                - Animated table headers on sort hover.
                - Enhanced toast entry/exit (slide and fade).
                - Subtle heading hover animation.
            - Accessibility: Added aria-labels.
            - Usability: Better validation message positioning.
            
            NOTE: All responsive design media queries have been removed to force desktop rendering on all devices.
        */

        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        
        :root {
            /* Revised Color Palette */
            --primary-color: #9B59B6; /* Amethyst - New Purple */
            --secondary-color: #4BC0D9; /* Cyan-like Blue - New Accent Blue */
            --accent-color: #FFE66D; /* Soft Yellow/Gold - New Vibrant Accent */
            --danger-color: #e74c3c; /* Red */
            --success-color: #2ecc71; /* Green */
            --info-color: #6CCFEA;   /* Lighter Blue */
            --white-color: #F5F5F5; /* Off-white for softer look */
            --text-color: #ecf0f1; /* Light gray text */

            /* Glassmorphism & Shadow Enhancements */
            --soft-dark-bg: rgba(0, 0, 0, 0.45); /* Slightly more opaque base for glass elements */
            --modal-bg: rgba(44, 62, 80, 0.95); /* Near-opaque dark blue for modals, subtle backdrop bleed */
            --border-alpha: rgba(255, 255, 255, 0.25); /* Slightly more opaque for borders */
            --input-border-alpha: rgba(255, 255, 255, 0.4); /* More opaque for inputs */
            --shadow-light: rgba(0, 0, 0, 0.8); /* Stronger, deeper shadow for depth */
            --shadow-button: rgba(0,0,0,0.5); /* Stronger button shadow */
            --bg-glass-active: rgba(0,0,0,0.6); /* More distinct hover/focus background for glass elements */
        }

        /* Keyframe Animations */
        @keyframes gradient-animation { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOutShrink { from { opacity: 1; transform: scale(1); max-height: 200px; padding-top: 12px; padding-bottom: 12px; margin: auto;} to { opacity: 0; transform: scale(0.9); max-height: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; margin-bottom: 0;} }
        @keyframes flash { 0% { color: var(--accent-color); text-shadow: 0 0 20px var(--accent-color), 0 0 40px var(--accent-color); transform: scale(1.08); } 100% { color: var(--accent-color); text-shadow: none; transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 80% { transform: scale(1.02); opacity: 1; } 100% { transform: scale(1); } }
        /* Toast Animations */
        @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideOutRight { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }

        /* Base styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, #2c3e50, #34495e, #23a6d5, #23d5ab); /* Maintain vibrant gradient background */
            background-size: 400% 400%; animation: gradient-animation 15s ease infinite;
            color: var(--text-color); min-height: 100vh; padding: 20px;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }

        .container {
            width: 100%; max-width: 950px; padding: 40px; 
            background: var(--soft-dark-bg); 
            border-radius: 20px;
            /* Enhanced Glassmorphism & Shadow */
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.8), inset 0 0 10px rgba(255,255,255,0.1); 
            backdrop-filter: blur(25px); /* Increased blur for more pronounced glass effect */
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--border-alpha);
            animation: slideInUp 0.9s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            margin: auto;
            position: relative;
        }

        /* Headings */
        h1 {
            font-size: 2.8rem; text-align: center; margin-bottom: 10px; font-weight: 700;
            /* Vibrant Gradient for Title */
            background: linear-gradient(45deg, var(--white-color), var(--accent-color));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 5px 12px rgba(0,0,0,0.5); /* Stronger text shadow */
            transition: all 0.3s ease;
            letter-spacing: 1px; 
        }
        h1:hover { transform: translateY(-3px) scale(1.01); text-shadow: 0 8px 20px rgba(0,0,0,0.6); } /* More prominent hover animation */


        #welcome-message {
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 25px; 
            color: rgba(255, 255, 255, 0.9); /* Brighter for emphasis */
            font-weight: 400;
        }
        
        h2 {
            font-size: 2rem; 
            text-align: center; color: var(--white-color);
            margin: 45px 0 30px 0; 
            font-weight: 700;
            border-top: 1px solid var(--border-alpha); padding-top: 30px; 
            transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center; gap: 12px; 
            letter-spacing: 0.5px;
            /* Subtle transform for heading 2 for interactive feel */
            transform: scale(1);
        }
        h2 i { color: var(--accent-color); font-size: 1.7rem; }
        h2:hover { transform: translateY(-2px); color: var(--white-color); text-shadow: 0 2px 8px rgba(255,255,255,0.1); }

        /* Total Expenses Section */
        .total-expenses { text-align: center; margin-bottom: 30px; }
        .total-expenses h3 { font-weight: 400; font-size: 1rem; color: rgba(255, 255, 255, 0.8); } 
        .total-expenses #total-amount { font-size: 3.5rem; font-weight: 700; color: var(--accent-color); transition: all 0.3s ease; }
        .total-expenses #total-amount.flash-update { animation: flash 0.7s ease-out; }

        /* Form Layout */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .form-control.full-width { grid-column: 1 / -1; }
        .form-control { display: flex; flex-direction: column; position: relative; }
        label { margin-bottom: 10px; font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.8px; opacity: 0.95; } 
        
        input[type="text"], input[type="number"], input[type="date"], select {
            padding: 16px; border: 1px solid var(--input-border-alpha); border-radius: 10px; 
            font-size: 17px; background: rgba(0, 0, 0, 0.35); /* More translucent input background */
            color: var(--white-color);
            transition: all 0.3s ease; font-family: 'Poppins', sans-serif;
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.25); /* Subtle inner shadow */
            -webkit-appearance: none; 
            -moz-appearance: none;
            appearance: none;
        }

        /* Custom dropdown arrow for select */
        select { 
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); 
            background-repeat: no-repeat;
            background-position: right 15px center; 
            padding-right: 40px; 
            cursor: pointer;
        }
        /* Style for options within the select dropdown */
        select option {
            background-color: #2c3e50; /* Darker background for option text */
            color: var(--white-color);
            padding: 10px; 
        }

        input::placeholder { color: rgba(255, 255, 255, 0.8); } /* Brighter placeholder */
        input:focus, select:focus {
            outline: none; background: var(--bg-glass-active); 
            border-color: var(--primary-color);
            /* Enhanced focus shadow for better feedback */
            box-shadow: 0 0 20px rgba(155, 89, 182, 0.8), inset 0 2px 10px rgba(0,0,0,0.4); 
            transform: scale(1.005); 
        }
        input.invalid, select.invalid { border-color: var(--danger-color); box-shadow: 0 0 15px rgba(231, 76, 60, 0.7), inset 0 2px 8px rgba(0,0,0,0.4); } 
        
        /* Adjusted positioning for error message */
        .form-control .error-message { 
            position: relative; 
            margin-top: 5px; 
            font-size: 0.78rem; 
            color: var(--danger-color);
            height: 1.1rem; 
            opacity: 0;
            transition: opacity 0.3s ease; 
            overflow: hidden; 
            white-space: nowrap; 
            text-overflow: ellipsis; 
        }
        .form-control input.invalid + .error-message, 
        .form-control select.invalid + .error-message { 
            opacity: 1;
        }

        /* Buttons */
        .btn { 
            padding: 16px 25px; border: none; border-radius: 10px; 
            cursor: pointer; font-size: 17px; font-weight: 600; text-align: center; 
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            letter-spacing: 0.8px; white-space: nowrap;
            display: inline-flex; align-items: center; justify-content: center; 
            line-height: 1; 
            box-shadow: 0 8px 25px var(--shadow-button); /* Stronger initial shadow */
        }
        .btn:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 14px 40px var(--shadow-light); } /* More dramatic hover lift and shadow */
        .btn:active { transform: translateY(-1px) scale(0.98); box-shadow: inset 0 2px 8px rgba(0,0,0,0.4), 0 3px 10px var(--shadow-button); } 

        .btn-primary { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: var(--white-color); } 
        .btn-primary:hover { background: linear-gradient(45deg, #af6ace, #52caef); } /* Slightly adjusted gradient on hover */
        .btn-danger { background-color: var(--danger-color); color: var(--white-color); }
        .btn-danger:hover { background-color: #c0392b; }
        .btn-success { background-color: var(--success-color); color: var(--white-color); }
        .btn-success:hover { background-color: #27ae60; }
        .btn-info { background-color: var(--info-color); color: var(--white-color); }
        .btn-info:hover { background-color: #55c0e1; }
        
        .btn i { margin-right: 10px; font-size: 1rem; } 

        /* Action Buttons within table */
        .action-btn { 
            background: none; border: none; cursor: pointer; font-size: 1.3rem; 
            transition: all 0.3s ease, transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            padding: 6px; color: var(--text-color); opacity: 0.8; 
            line-height: 1; 
        }
        .action-btn:hover { opacity: 1; transform: scale(1.5); } /* More pronounced scale */
        .action-btn.edit-btn:hover { color: var(--secondary-color); }
        .action-btn.duplicate-btn:hover { color: var(--success-color); }
        .action-btn.delete-btn:hover { color: var(--danger-color); }
        
        .actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 40px; } 
        
        /* Summary Section Styling */
        #expense-summary-section {
            background: rgba(0,0,0,0.3); /* Lighter base for glass */
            padding: 30px; 
            border-radius: 18px; 
            border: 1px solid var(--border-alpha);
            box-shadow: 0 8px 30px rgba(0,0,0,0.35), inset 0 0 8px rgba(255,255,255,0.05); /* Deeper shadow + subtle inner glow */
            margin-bottom: 30px;
            margin-top: 40px; 
            animation: fadeIn 1s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        }
        #expense-summary-section h3 {
            font-size: 1.6rem; 
            color: var(--accent-color);
            font-weight: 700;
            margin-bottom: 25px;
            padding-bottom: 20px; 
            border-bottom: 1px dashed rgba(255, 255, 255, 0.2); 
            gap: 15px; 
        }
        #expense-summary-section h3 i { font-size: 1.4rem; } 
        #expense-summary-content p {
            display: flex; 
            align-items: flex-start; 
            padding: 15px; 
            background: rgba(0,0,0,0.2); /* Lighter translucent background for summary items */
            border-left: 5px solid var(--secondary-color); 
            margin-bottom: 12px; 
            border-radius: 10px; 
            line-height: 1.7; 
            font-size: 1.05rem; 
            gap: 15px; 
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #expense-summary-content p:last-child { margin-bottom: 0; }
        #expense-summary-content strong { color: var(--white-color); }
        #expense-summary-content .good-news { border-left-color: var(--success-color); }
        #expense-summary-content .bad-news { border-left-color: var(--danger-color); }
        #expense-summary-content .good-news i, #expense-summary-content .bad-news i {
            font-size: 1.3rem; 
        }
        #expense-summary-content p i { 
            font-size: 1.2rem; 
            flex-shrink: 0; 
            margin-top: 2px; 
        }


        /* Expense Controls (Filters/Search) */
        .expense-controls { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 20px; 
            align-items: flex-end; 
            margin-bottom: 25px; 
        } 
        .expense-controls .form-control { 
            min-width: unset; 
            flex: unset; 
        }
        .expense-controls #date-filter-group { 
            grid-column: 1 / -1; 
            display: flex; flex-wrap: wrap; gap: 20px; 
            padding: 20px 0 10px; 
            border-top: 1px dashed rgba(255, 255, 255, 0.15); 
            margin-top: 20px; 
        }
        .expense-controls #date-filter-group .form-control { flex: 1 1 calc(50% - 10px); }


        /* Expense Table Styling */
        .expense-table-container { 
            max-height: 400px; overflow-y: auto; 
            background: rgba(0,0,0,0.28); /* Slightly darker, more prominent glass table background */
            border-radius: 10px; 
            border: 1px solid var(--border-alpha);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.15); /* More visible inset shadow */
        }
        .expense-table-container::-webkit-scrollbar { width: 10px; } 
        .expense-table-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 10px; }
        .expense-table-container::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 10px; border: 2px solid rgba(0,0,0,0.2); } 
        .expense-table { width: 100%; border-collapse: collapse; }
        .expense-table th, .expense-table td { padding: 14px 18px; text-align: left; vertical-align: middle; }
        .expense-table thead { position: sticky; top: 0; z-index: 10; }
        .expense-table thead tr { background: rgba(0, 0, 0, 0.7); border-bottom: 1px solid var(--border-alpha); } /* Stronger background */
        .expense-table th { 
            font-weight: 700; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 0.8px; 
            color: rgba(255, 255, 255, 0.95); /* Brighter */
            cursor: pointer; transition: all 0.25s ease;
            white-space: nowrap;
        }
        .expense-table th:hover { 
            color: var(--accent-color); 
            background: rgba(0,0,0,0.75); 
            transform: translateY(-3px); /* More pronounced lift on hover */
            box-shadow: 0 3px 8px rgba(0,0,0,0.4); /* Subtle shadow on hover */
        } 
        .expense-table th.sorted { color: var(--secondary-color); }
        .expense-table th .sort-icon { margin-left: 8px; font-size: 0.8em; } 

        .expense-table tbody tr { 
            border-bottom: 1px dashed rgba(255, 255, 255, 0.15); 
            transition: background-color 0.3s ease, transform 0.3s ease, opacity 0.3s ease; 
            background-color: rgba(0,0,0,0.2); /* Base row background */
        } 
        .expense-table tbody tr:last-child { border-bottom: none; }
        .expense-table tbody tr:hover { background-color: rgba(0,0,0,0.45); } /* Stronger hover */
        .expense-table tr.item-exit { animation: fadeOutShrink 0.5s ease-in forwards; }
        .expense-table .col-amount { font-weight: 700; text-align: right; color: var(--white-color); }
        .expense-table .col-actions { width: 120px; text-align: center; }

        /* Toast Notifications */
        #toast-container { 
            position: fixed; top: 25px; right: 25px; z-index: 2000; 
            display: flex; flex-direction: column; gap: 12px; pointer-events: none;
            overflow: hidden; 
        } 
        .toast {
            background-color: var(--modal-bg); color: var(--white-color); 
            padding: 18px 30px; border-radius: 10px; 
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4); 
            backdrop-filter: blur(12px); /* Increased toast blur */ 
            opacity: 0; transform: translateX(100%); 
            animation: slideInRight 0.4s ease-out forwards; 
            min-width: 280px; text-align: center;
            border: 1px solid var(--border-alpha);
            font-weight: 500;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .toast.hide { animation: slideOutRight 0.4s ease-in forwards; } 
        .toast i { font-size: 1.2em; }
        .toast.success { border-left: 6px solid var(--success-color); } 
        .toast.success i { color: var(--success-color); }
        .toast.error { border-left: 6px solid var(--danger-color); }
        .toast.error i { color: var(--danger-color); }
        .toast.info { border-left: 6px solid var(--info-color); }
        .toast.info i { color: var(--info-color); }

        /* Modal Styles */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); /* Darker overlay */ 
            backdrop-filter: blur(15px); /* Stronger blur */ z-index: 1000; 
            display: flex; align-items: center; justify-content: center; 
            opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0s linear 0.4s; 
        }
        .modal-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.4s ease, visibility 0s linear 0s; }
        .modal-content { 
            background: var(--modal-bg); border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7), inset 0 0 10px rgba(255,255,255,0.05); /* Deeper shadow with inner glow */ 
            border: 1px solid var(--border-alpha); 
            padding: 45px; width: 90%; max-width: 550px; transform: scale(0.9); opacity: 0; 
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s ease; 
            animation: popIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        }
        .modal-overlay.active .modal-content { transform: scale(1); opacity: 1; }
        .modal-content h2 { margin: 0 0 30px 0; padding: 0; border: none; font-size: 2.2rem; } 
        .modal-actions { display: flex; justify-content: flex-end; gap: 20px; margin-top: 35px; flex-wrap: wrap; } 
        .modal-actions .btn { flex-grow: 1; min-width: 140px; } 

        /* REMOVED: Desktop Recommendation Message styles (no longer needed) */
        
        /* REMOVED: All Responsive Design Breakpoints and Mobile-Specific Styles */
        /* @media (max-width: 768px) { ... } */
        /* @media (max-width: 768px) and (orientation: landscape) { ... } */
    </style>
</head>
<body>
    <!-- REMOVED: Desktop Recommendation Message HTML -->
    
    <div class="container">
        <h1>Smart Expense Tracker 💰</h1>
        <p id="welcome-message"></p>

        <div class="total-expenses">
            <h3>Total Lifetime Expenses</h3>
            <div id="total-amount">₹0.00</div>
        </div>

        <div id="expenses-section" class="tab-content-section active">
            <form id="expense-form">
                <div class="form-grid">
                    <div class="form-control">
                        <label for="expense-date">Date</label>
                        <input type="date" id="expense-date" required>
                        <span class="error-message" data-input="expense-date"></span>
                    </div>
                    <div class="form-control">
                        <label for="expense-category">Category</label>
                        <select id="expense-category" required></select>
                        <span class="error-message" data-input="expense-category"></span>
                    </div>
                    <div class="form-control full-width">
                        <label for="expense-description">Description</label>
                        <input type="text" id="expense-description" placeholder="e.g., Lunch with team" required>
                        <span class="error-message" data-input="expense-description"></span>
                    </div>
                    <div class="form-control full-width">
                        <label for="expense-amount">Amount (₹)</label>
                        <input type="number" id="expense-amount" placeholder="e.g., 1250.50" step="0.01" min="0.01" required>
                        <span class="error-message" data-input="expense-amount"></span>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top: 25px;"><i class="fas fa-plus" aria-hidden="true"></i> Add Expense</button>
                <button type="button" id="add-category-btn" class="btn btn-info" style="margin-top: 25px; margin-left: 10px;"><i class="fas fa-tag" aria-hidden="true"></i> New Category</button>
            </form>
            
            <div id="expense-summary-section">
                <h3><i class="fas fa-chart-pie" aria-hidden="true"></i> Your Monthly Summary</h3>
                <div id="expense-summary-content">
                    <p style="text-align: center; color: rgba(255,255,255,0.7); border: none; background: none;">
                        <i class="fas fa-hand-holding-usd" style="margin-right: 8px;" aria-hidden="true"></i> Add some expenses to see a summary here! 🚀
                    </p>
                </div>
            </div>

            <h2><i class="fas fa-list-alt" aria-hidden="true"></i> Your Expense Log</h2>
            <div class="expense-controls">
                <div class="form-control">
                    <label for="category-filter">Filter by Category</label>
                    <select id="category-filter"></select>
                </div>
                <div id="date-filter-group">
                    <div class="form-control">
                        <label for="start-date-filter">From Date</label>
                        <input type="date" id="start-date-filter">
                        <span class="error-message" data-input="start-date-filter"></span>
                    </div>
                    <div class="form-control">
                        <label for="end-date-filter">To Date</label>
                        <input type="date" id="end-date-filter">
                        <span class="error-message" data-input="end-date-filter"></span>
                    </div>
                </div>
            </div>
            
            <div class="expense-table-container">
                <table class="expense-table">
                    <thead>
                        <tr>
                            <th data-sort-by="date">Date <span class="sort-icon"></span></th>
                            <th data-sort-by="category">Category <span class="sort-icon"></span></th>
                            <th data-sort-by="description">Description <span class="sort-icon"></span></th>
                            <th data-sort-by="amount" class="col-amount">Amount <span class="sort-icon"></span></th>
                            <th class="col-actions">Action</th>
                        </tr>
                    </thead>
                    <tbody id="expense-table-body"></tbody>
                </table>
            </div>

            <div class="actions">
                <button id="send-email-btn" class="btn btn-primary"><i class="fas fa-envelope" aria-hidden="true"></i> Send Report to Email</button>
                <button id="clear-data-btn" class="btn btn-danger"><i class="fas fa-trash-alt" aria-hidden="true"></i> Clear All Data</button>
            </div>
        </div>

    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-content">
            <h2>Edit Expense ✍️</h2>
            <form id="edit-form">
                <div class="form-grid">
                    <div class="form-control">
                        <label for="edit-date">Date</label>
                        <input type="date" id="edit-date" required>
                        <span class="error-message" data-input="edit-date"></span>
                    </div>
                    <div class="form-control">
                        <label for="edit-category">Category</label>
                        <select id="edit-category" required></select>
                        <span class="error-message" data-input="edit-category"></span>
                    </div>
                    <div class="form-control full-width">
                        <label for="edit-description">Description</label>
                        <input type="text" id="edit-description" required>
                        <span class="error-message" data-input="edit-description"></span>
                    </div>
                    <div class="form-control full-width">
                        <label for="edit-amount">Amount (₹)</label>
                        <input type="number" id="edit-amount" step="0.01" min="0.01" required>
                        <span class="error-message" data-input="edit-amount"></span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger cancel-modal-btn"><i class="fas fa-times-circle" aria-hidden="true"></i> Cancel</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-save" aria-hidden="true"></i> Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal-overlay" id="add-category-modal">
        <div class="modal-content">
            <h2>Add New Category ✨</h2>
            <form id="add-category-form">
                <div class="form-control full-width">
                    <label for="new-category-name">Category Name</label>
                    <input type="text" id="new-category-name" placeholder="e.g., Groceries" required>
                    <span class="error-message" data-input="new-category-name"></span>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger cancel-modal-btn"><i class="fas fa-times-circle" aria-hidden="true"></i> Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-plus" aria-hidden="true"></i> Add Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Clear All Data Confirmation Modal -->
    <div class="modal-overlay" id="clear-confirm-modal">
        <div class="modal-content">
            <h2>Confirm Clear Data ⚠️</h2>
            <p style="text-align: center; margin-bottom: 25px; color: rgba(255,255,255,0.9);">Are you absolutely sure you want to delete <strong style="color: var(--danger-color);">ALL</strong> expense data? This action cannot be undone.</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-success cancel-modal-btn"><i class="fas fa-times-circle" aria-hidden="true"></i> Cancel</button>
                <button type="button" id="confirm-clear-data-btn" class="btn btn-danger"><i class="fas fa-trash-alt" aria-hidden="true"></i> Yes, Clear All</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div id="toast-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Constants ---
            // Emojis removed from default categories
            const DEFAULT_CATEGORIES = [
                "Food", "Transport", "Bills", "Shopping", 
                "Entertainment", "Health", "Education", "Rent", "Other"
            ];

            // --- DOM Elements ---
            const expenseForm = document.getElementById('expense-form');
            const expenseTableBody = document.getElementById('expense-table-body');
            const totalAmountDisplay = document.getElementById('total-amount');
            const expenseSummaryContent = document.getElementById('expense-summary-content');
            const sendEmailBtn = document.getElementById('send-email-btn');
            const clearDataBtn = document.getElementById('clear-data-btn');
            const categoryFilter = document.getElementById('category-filter');
            const startDateFilter = document.getElementById('start-date-filter');
            const endDateFilter = document.getElementById('end-date-filter');
            const toastContainer = document.getElementById('toast-container');
            const addCategoryBtn = document.getElementById('add-category-btn');
            const welcomeMessageElement = document.getElementById('welcome-message'); 
            
            // Modals and their forms
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            const addCategoryModal = document.getElementById('add-category-modal');
            const addCategoryForm = document.getElementById('add-category-form');
            const clearConfirmModal = document.getElementById('clear-confirm-modal');
            const confirmClearDataBtn = document.getElementById('confirm-clear-data-btn');

            // --- State Variables ---
            let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
            let categories = JSON.parse(localStorage.getItem('categories')) || DEFAULT_CATEGORIES;
            let currentEditId = null;
            let sortConfig = JSON.parse(localStorage.getItem('sortConfig')) || { key: 'date', direction: 'desc' }; // Default sort by date descending

            // --- Helper Functions ---

            // New helper function to strip emojis
            const stripEmojis = (str) => {
                // Regular expression to match various Unicode emoji categories
                return str.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{2300}-\u{23FF}\u{2B00}-\u{2BFF}\u{25AA}-\u{25FE}\u{FE0F}]/gu, '').trim();
            };

            const toLocalDateInput = (dateString) => {
                if (!dateString) return '';
                // Ensure date is treated as UTC to prevent timezone issues shifting date
                const date = new Date(dateString + 'T00:00:00Z'); 
                return date.toISOString().split('T')[0]; 
            };

            const formatCurrency = (amount) => {
                return `₹${parseFloat(amount).toFixed(2)}`;
            };

            const flashUpdate = (element) => {
                element.classList.add('flash-update');
                setTimeout(() => element.classList.remove('flash-update'), 700);
            };

            const showToast = (message, type = 'info', duration = 3000) => {
                const toast = document.createElement('div');
                toast.classList.add('toast', type);
                
                let icon = '';
                if (type === 'success') icon = '<i class="fas fa-check-circle" aria-hidden="true"></i>';
                else if (type === 'error') icon = '<i class="fas fa-times-circle" aria-hidden="true"></i>';
                else if (type === 'info') icon = '<i class="fas fa-info-circle" aria-hidden="true"></i>';

                toast.innerHTML = `${icon} <span>${message}</span>`;
                toastContainer.appendChild(toast);

                // Animate out and remove
                setTimeout(() => {
                    toast.classList.add('hide'); // Trigger slideOutRight
                    toast.addEventListener('animationend', () => toast.remove(), { once: true });
                }, duration);
            };

            const showModal = (modalElement) => {
                modalElement.classList.add('active');
                setTimeout(() => {
                    const firstInput = modalElement.querySelector('input, select, textarea, button:not(.cancel-modal-btn)');
                    if (firstInput) {
                        firstInput.focus();
                    } else {
                        modalElement.querySelector('.modal-content').focus();
                    }
                }, 100); 
            };

            const closeModal = (modalElement) => {
                modalElement.classList.remove('active');
                const formInModal = modalElement.querySelector('form');
                if (formInModal) {
                    clearValidationErrors(formInModal);
                    formInModal.reset();
                }
            };

            // --- Local Storage Management (now purely for persistence) ---
            const persistExpensesToLocalStorage = () => {
                localStorage.setItem('expenses', JSON.stringify(expenses));
            };

            const saveCategories = () => {
                localStorage.setItem('categories', JSON.stringify(categories));
                populateCategoryDropdowns();
            };

            // --- Input Validation ---
            const validateInput = (inputElement) => {
                const errorMessageElement = inputElement.closest('.form-control')?.querySelector('.error-message');
                let isValid = true;
                let errorMessage = '';

                if (inputElement.required && inputElement.value.trim() === '') {
                    isValid = false;
                    errorMessage = 'This field is required.';
                } 
                else if (inputElement.type === 'number') {
                    const value = parseFloat(inputElement.value);
                    if (isNaN(value)) {
                        isValid = false;
                        errorMessage = 'Must be a valid number.';
                    } else if (value < 0) {
                        isValid = false;
                        errorMessage = 'Value cannot be negative.';
                    } else if (inputElement.min && value < parseFloat(inputElement.min)) {
                         isValid = false;
                        errorMessage = `Must be at least ${parseFloat(inputElement.min)}.`;
                    }
                } 
                else if (inputElement.id === 'new-category-name') {
                    const cleanedNewCatName = stripEmojis(inputElement.value);
                    const categoryExists = categories.some(cat => 
                        stripEmojis(cat).toLowerCase() === cleanedNewCatName.toLowerCase()
                    );

                    if (categoryExists) {
                        isValid = false;
                        errorMessage = 'Category already exists!';
                    }
                }
                else if (inputElement.id === 'start-date-filter' || inputElement.id === 'end-date-filter') {
                    const startVal = startDateFilter.value;
                    const endVal = endDateFilter.value;

                    // Clear previous date errors before re-validating the pair
                    const clearDateErrors = () => {
                        startDateFilter.classList.remove('invalid');
                        if (startDateFilter.closest('.form-control')?.querySelector('.error-message')) startDateFilter.closest('.form-control').querySelector('.error-message').textContent = '';
                        endDateFilter.classList.remove('invalid');
                        if (endDateFilter.closest('.form-control')?.querySelector('.error-message')) endDateFilter.closest('.form-control').querySelector('.error-message').textContent = '';
                    };
                    clearDateErrors();

                    if (startVal && endVal) {
                        const start = new Date(startVal + 'T00:00:00Z');
                        const end = new Date(endVal + 'T00:00:00Z');
                        if (start > end) {
                            isValid = false;
                            errorMessage = 'End date cannot be before start date.';
                            startDateFilter.classList.add('invalid');
                            if (startDateFilter.closest('.form-control')?.querySelector('.error-message')) startDateFilter.closest('.form-control').querySelector('.error-message').textContent = errorMessage;
                            endDateFilter.classList.add('invalid');
                            if (endDateFilter.closest('.form-control')?.querySelector('.error-message')) endDateFilter.closest('.form-control').querySelector('.error-message').textContent = errorMessage;
                        }
                    }
                    // For date filters, we validate them as a pair.
                    // This specific validation (returning isValid immediately) prevents the individual element's state from overriding the pair's.
                    if (inputElement.id === 'start-date-filter' || inputElement.id === 'end-date-filter') return isValid;
                }

                if (!isValid) {
                    inputElement.classList.add('invalid');
                    if (errorMessageElement) {
                        errorMessageElement.textContent = errorMessage;
                        errorMessageElement.style.opacity = 1;
                    }
                } else {
                    inputElement.classList.remove('invalid');
                    if (errorMessageElement) {
                        errorMessageElement.textContent = '';
                        errorMessageElement.style.opacity = 0;
                    }
                }
                return isValid;
            };

            const validateForm = (formElement) => {
                let allValid = true;
                const inputs = formElement.querySelectorAll('input[required], select[required], input[type="number"], #new-category-name'); 
                inputs.forEach(input => {
                    if (!validateInput(input)) {
                        allValid = false;
                    }
                });
                return allValid;
            };

            const clearValidationErrors = (formElement) => {
                formElement.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
                formElement.querySelectorAll('.error-message').forEach(el => {
                    el.textContent = '';
                    el.style.opacity = 0;
                });
            };

            // --- UI Rendering & Updates (optimized) ---

            const createExpenseRow = (expense) => {
                const tr = document.createElement('tr');
                tr.className = 'expense-item';
                tr.dataset.id = expense.id; // Store ID on the row for easy lookup
                
                const date = new Date(expense.date + 'T00:00:00Z'); 
                const formattedDate = date.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'UTC' });
                
                tr.innerHTML = `
                    <td data-label="Date">${formattedDate}</td>
                    <td data-label="Category">${stripEmojis(expense.category)}</td> 
                    <td data-label="Description">${expense.description}</td>
                    <td data-label="Amount" class="col-amount">${formatCurrency(expense.amount)}</td>
                    <td data-label="Actions" class="col-actions">
                        <button class="action-btn edit-btn" data-id="${expense.id}" title="Edit" aria-label="Edit expense"><i class="fas fa-edit" aria-hidden="true"></i></button>
                        <button class="action-btn duplicate-btn" data-id="${expense.id}" title="Duplicate" aria-label="Duplicate expense"><i class="fas fa-copy" aria-hidden="true"></i></button>
                        <button class="action-btn delete-btn" data-id="${expense.id}" title="Delete" aria-label="Delete expense"><i class="fas fa-trash" aria-hidden="true"></i></button>
                    </td>
                `;
                return tr;
            };

            const renderExpenses = () => {
                const expensesToRender = getFilteredAndSortedExpenses(); 
                expenseTableBody.innerHTML = ''; // Clear existing rows (needed for sort/filter)

                if (expensesToRender.length === 0) {
                    const message = expenses.length === 0 
                        ? 'No expenses added yet. Start by using the form above! 📝' 
                        : 'No expenses match your current filters and date range. 🧐 Try adjusting your filters!';
                    expenseTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 25px 0; color: rgba(255,255,255,0.7);">${message}</td></tr>`;
                } else {
                    expensesToRender.forEach((expense, index) => {
                        const tr = createExpenseRow(expense);
                        tr.style.animationDelay = `${Math.min(index * 50, 500)}ms`; // Fade in animation delay
                        expenseTableBody.appendChild(tr);
                    });
                }
                updateSortIcons();
            };

            // Call this to trigger full re-render on sort/filter change
            const updateExpenseTableAndSummary = () => {
                renderExpenses(); // Full re-render needed for sort/filter
                updateTotal();
                updateExpenseSummary();
            };

            const populateCategoryDropdowns = () => {
                const dropdowns = [
                    document.getElementById('expense-category'),
                    document.getElementById('edit-category'),
                    document.getElementById('category-filter')
                ];
                
                dropdowns.forEach((dropdown, index) => {
                    const currentSelected = dropdown.value; 
                    dropdown.innerHTML = ''; 

                    if (index === 2) { 
                        const allOption = document.createElement('option');
                        allOption.value = 'all';
                        allOption.textContent = 'All Categories'; 
                        dropdown.appendChild(allOption);
                    }

                    categories.slice().sort((a, b) => {
                        const cleanA = stripEmojis(a);
                        const cleanB = stripEmojis(b);
                        return cleanA.localeCompare(cleanB);
                    }).forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat; 
                        option.textContent = stripEmojis(cat); 
                        dropdown.appendChild(option);
                    });

                    // Attempt to restore selection, else set default
                    if (Array.from(dropdown.options).some(opt => opt.value === currentSelected)) {
                        dropdown.value = currentSelected;
                    } else if (index === 2) { 
                        dropdown.value = 'all';
                    } else if (dropdown.options.length > 0) { 
                        dropdown.value = dropdown.options[0].value;
                    }
                });
            };

            const updateTotal = () => {
                const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
                totalAmountDisplay.textContent = formatCurrency(total);
                flashUpdate(totalAmountDisplay);
            };

            const updateExpenseSummary = () => {
                const summaryContentDiv = document.getElementById('expense-summary-content');
                summaryContentDiv.innerHTML = ''; // Clear for update

                if (expenses.length === 0) {
                    summaryContentDiv.innerHTML = `
                        <p style="text-align: center; color: rgba(255,255,255,0.7); border: none; background: none;">
                            <i class="fas fa-hand-holding-usd" style="margin-right: 8px;" aria-hidden="true"></i> Start by adding your first expense to see your financial summary here! 🚀
                        </p>
                    `;
                    return;
                }

                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();

                const getExpensesForMonth = (year, month) => {
                    return expenses.filter(exp => {
                        const expDate = new Date(exp.date + 'T00:00:00Z'); 
                        return expDate.getUTCFullYear() === year && expDate.getUTCMonth() === month;
                    });
                };

                const calculateSpendingByCategory = (expenseList) => {
                    return expenseList.reduce((acc, exp) => {
                        const categoryName = stripEmojis(exp.category);
                        acc[categoryName] = (acc[categoryName] || 0) + exp.amount;
                        return acc;
                    }, {});
                };

                const currentMonthExpenses = getExpensesForMonth(currentYear, currentMonth);
                const totalCurrentMonthSpent = currentMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                const currentMonthSpendingByCategory = calculateSpendingByCategory(currentMonthExpenses);

                let lastMonth = currentMonth - 1;
                let lastYear = currentYear;
                if (lastMonth < 0) {
                    lastMonth = 11; 
                    lastYear--;
                }
                const lastMonthExpenses = getExpensesForMonth(lastYear, lastMonth);
                const totalLastMonthSpent = lastMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                const lastMonthSpendingByCategory = calculateSpendingByCategory(lastMonthExpenses);

                let monthlyComparisonHtml = '';
                const currentMonthName = now.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                const lastMonthName = new Date(lastYear, lastMonth).toLocaleString('en-US', { month: 'long', year: 'numeric' });


                if (totalCurrentMonthSpent > 0 && totalLastMonthSpent === 0) {
                     monthlyComparisonHtml = `
                        <p><i class="fas fa-money-bill-wave" aria-hidden="true"></i> In ${currentMonthName}, you've spent <strong>${formatCurrency(totalCurrentMonthSpent)}</strong>. Great start to your tracking journey! 💰</p>
                    `;
                } else if (totalCurrentMonthSpent > totalLastMonthSpent) {
                    const diff = totalCurrentMonthSpent - totalLastMonthSpent;
                    const percentage = (diff / (totalLastMonthSpent || 1)) * 100; 
                    monthlyComparisonHtml = `
                        <p class="bad-news">
                            <i class="fas fa-arrow-trend-up" aria-hidden="true"></i> Your spending in ${currentMonthName} is <strong>${formatCurrency(diff)} (${percentage.toFixed(1)}% higher)</strong> than ${lastMonthName}'s ${formatCurrency(totalLastMonthSpent)}. Let's review where that extra cash went! 💸
                        </p>
                    `;
                } else if (totalCurrentMonthSpent < totalLastMonthSpent && totalCurrentMonthSpent >= 0) { 
                    const diff = totalLastMonthSpent - totalCurrentMonthSpent;
                    const percentage = (diff / totalLastMonthSpent) * 100;
                    monthlyComparisonHtml = `
                        <p class="good-news">
                            <i class="fas fa-arrow-trend-down" aria-hidden="true"></i> Excellent! You spent <strong>${formatCurrency(diff)} (${percentage.toFixed(1)}% less)</strong> in ${currentMonthName} compared to ${lastMonthName}'s ${formatCurrency(totalLastMonthSpent)}. Keep up the smart saving! ✨
                        </p>
                    `;
                } else if (totalCurrentMonthSpent === totalLastMonthSpent && totalCurrentMonthSpent > 0) {
                    monthlyComparisonHtml = `
                        <p><i class="fas fa-balance-scale-left" aria-hidden="true"></i> Your spending in ${currentMonthName} is consistent with ${lastMonthName}, totaling around <strong>${formatCurrency(totalCurrentMonthSpent)}</strong>. Steady financial management! 👍</p>
                    `;
                } else { 
                     monthlyComparisonHtml = `
                        <p><i class="fas fa-calendar-alt" aria-hidden="true"></i> No spending recorded for ${currentMonthName} or ${lastMonthName}. Let's get tracking your next expenses! 🧐</p>
                     `;
                }
                summaryContentDiv.innerHTML += monthlyComparisonHtml;

                if (currentMonthExpenses.length > 0) {
                    const sortedCategories = Object.entries(currentMonthSpendingByCategory)
                        .sort(([, a], [, b]) => b - a)
                        .slice(0, 3); 

                    if (sortedCategories.length > 0) {
                        const topCategoriesText = sortedCategories.map(([category, amount]) => {
                            const percentOfTotal = (amount / totalCurrentMonthSpent) * 100;
                            return `<strong>${stripEmojis(category)}</strong> (${formatCurrency(amount)}, ${percentOfTotal.toFixed(1)}% of total)`;
                        }).join(', ');
                        summaryContentDiv.innerHTML += `
                            <p><i class="fas fa-boxes" aria-hidden="true"></i> Your top ${sortedCategories.length} spending areas this month: ${topCategoriesText}.
                            Knowing these can help you identify where to focus for potential savings! 💡</p>
                        `;
                    }
                    
                    const categoryChanges = [];
                    const changeThreshold = 50; 
                    const minAmountThreshold = 500; 

                    for (const category in currentMonthSpendingByCategory) {
                        const currentMonthAmount = currentMonthSpendingByCategory[category];
                        const lastMonthAmount = lastMonthSpendingByCategory[category] || 0;

                        if (currentMonthAmount >= minAmountThreshold) { 
                            if (lastMonthAmount > 0) { 
                                const percentageChange = ((currentMonthAmount - lastMonthAmount) / lastMonthAmount) * 100;
                                if (percentageChange > changeThreshold) {
                                    categoryChanges.push(`<strong>${stripEmojis(category)}</strong> (up ${percentageChange.toFixed(0)}%)`);
                                }
                            } else { 
                                categoryChanges.push(`<strong>${stripEmojis(category)}</strong> (new significant spending)`);
                            }
                        }
                    }

                    if (categoryChanges.length > 0) {
                        summaryContentDiv.innerHTML += `
                            <p class="bad-news">
                                <i class="fas fa-exclamation-triangle" aria-hidden="true"></i> You might want to check your spending in: ${categoryChanges.join(', ')}. 
                                These areas saw significant changes recently. 😬
                            </p>
                        `;
                    }

                    const largestExpense = currentMonthExpenses.reduce((max, exp) => (exp.amount > (max ? max.amount : 0)) ? exp : max, null);
                    if (largestExpense) {
                        summaryContentDiv.innerHTML += `
                            <p><i class="fas fa-hand-holding-usd" aria-hidden="true"></i> Your single largest expense this month was <strong>${formatCurrency(largestExpense.amount)}</strong> for "${largestExpense.description}" in "${stripEmojis(largestExpense.category)}". Big spending calls for careful consideration! 💸</p>
                        `;
                    }
                } else {
                     summaryContentDiv.innerHTML += `<p><i class="fas fa-smile-beam" aria-hidden="true"></i> No spending recorded for ${currentMonthName} yet. A fresh start for tracking your finances! 🆕</p>`;
                }

                summaryContentDiv.innerHTML += `
                    <p style="border:none; margin-top:18px; text-align:center; font-style: italic; font-size: 0.85rem; color: rgba(255,255,255,0.6); background: none; padding-top: 5px; padding-bottom: 5px;">
                        *Insights based on available data and general spending patterns. Always cross-check!*
                    </p>
                `;
            };

            const updateSortIcons = () => {
                document.querySelectorAll('.expense-table th').forEach(header => {
                    const sortKey = header.dataset.sortBy;
                    const iconSpan = header.querySelector('.sort-icon');
                    if (iconSpan) {
                        let icon = '';
                        if (sortKey === sortConfig.key) {
                            icon = sortConfig.direction === 'asc' ? ' ↑' : ' ↓';
                            header.classList.add('sorted');
                        } else {
                            header.classList.remove('sorted');
                        }
                        iconSpan.textContent = icon;
                    }
                });
            };

            // --- Welcome Message Logic ---
            const updateWelcomeMessage = () => {
                let userName = localStorage.getItem('userName');
                if (!userName) {
                    userName = prompt("👋 Welcome to your Smart Expense Tracker! What's your name?");
                    if (userName) {
                        localStorage.setItem('userName', userName.trim());
                    } else {
                        userName = "Guest";
                    }
                }
                welcomeMessageElement.textContent = `Hello, ${userName}! Let's track your expenses. 📊`;
            };
            
            // --- Event Listeners ---
            document.getElementById('expense-date').valueAsDate = new Date();

            expenseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!validateForm(expenseForm)) {
                    showToast('Please correct the highlighted fields.', 'error');
                    return;
                }

                const newExpense = {
                    id: Date.now(), 
                    date: toLocalDateInput(document.getElementById('expense-date').value),
                    category: document.getElementById('expense-category').value, 
                    description: document.getElementById('expense-description').value.trim(),
                    amount: parseFloat(document.getElementById('expense-amount').value),
                };
                
                expenses.unshift(newExpense); // Add to the beginning for immediate display without re-sorting
                persistExpensesToLocalStorage();

                // Append the new row directly
                const newRow = createExpenseRow(newExpense);
                // If the table is filtered/sorted, we still need to decide where to put the new item.
                // For simplicity for `Add Expense`, we'll assume adding to top if filters allow it.
                // If current filters don't include this new item, it won't appear until filters change.
                const expensesToRender = getFilteredAndSortedExpenses();
                if (expensesToRender[0] && expensesToRender[0].id === newExpense.id) { // Check if new item is top of the sorted list
                     expenseTableBody.prepend(newRow); // Add at the top for immediate visibility
                     if (expenseTableBody.querySelector('td[colspan="5"]')) { // Remove "No expenses" message if present
                        expenseTableBody.querySelector('td[colspan="5"]').parentElement.remove();
                    }
                } else {
                    renderExpenses(); // If new item wouldn't naturally be at the top of filtered/sorted, re-render
                }

                updateTotal();
                updateExpenseSummary();
                expenseForm.reset();
                document.getElementById('expense-date').valueAsDate = new Date(); 
                clearValidationErrors(expenseForm);
                showToast('Expense Added Successfully! ✅', 'success');
            });

            expenseTableBody.addEventListener('click', (e) => {
                const button = e.target.closest('.action-btn');
                if (!button) return;

                const id = parseInt(button.dataset.id);
                const expenseIndex = expenses.findIndex(exp => exp.id === id);
                if (expenseIndex === -1) {
                    showToast('Expense not found! 🤷', 'error');
                    return;
                }

                const row = button.closest('tr'); // Get the row element for the expense

                if (button.classList.contains('delete-btn')) {
                    if(row) { 
                        row.classList.add('item-exit');
                        row.addEventListener('animationend', () => {
                            expenses.splice(expenseIndex, 1);
                            persistExpensesToLocalStorage();
                            row.remove(); // Directly remove the row from the DOM
                            updateTotal();
                            updateExpenseSummary();
                            // If table becomes empty, display the "No expenses" message
                            if (expenseTableBody.children.length === 0 || expenseTableBody.children[0].tagName === 'TR' && expenseTableBody.children[0].children[0].getAttribute('colspan') === '5') {
                                // This check handles if after deleting, filters leave an empty visible list
                                renderExpenses(); 
                            }
                            showToast('Expense Deleted. 🗑️', 'info');
                        }, { once: true });
                    }
                } else if (button.classList.contains('duplicate-btn')) {
                    const expenseToDuplicate = expenses[expenseIndex];
                    const duplicatedExpense = { 
                        ...expenseToDuplicate, 
                        id: Date.now(), 
                        date: toLocalDateInput(new Date().toISOString()), 
                        description: `(Copy) ${expenseToDuplicate.description}`
                    };
                    
                    expenses.unshift(duplicatedExpense); // Add to the beginning
                    persistExpensesToLocalStorage();

                    const newRow = createExpenseRow(duplicatedExpense);
                    // Again, assume prepending for simplicity, re-render if filters conflict
                    const expensesToRender = getFilteredAndSortedExpenses();
                    if (expensesToRender[0] && expensesToRender[0].id === duplicatedExpense.id) {
                         expenseTableBody.prepend(newRow);
                         if (expenseTableBody.querySelector('td[colspan="5"]')) { // Remove "No expenses" message if present
                            expenseTableBody.querySelector('td[colspan="5"]').parentElement.remove();
                        }
                    } else {
                        renderExpenses(); // Re-render if new item isn't at the top after sorting/filtering
                    }
                    
                    updateTotal();
                    updateExpenseSummary();
                    showToast('Expense Duplicated! 📋', 'info');

                } else if (button.classList.contains('edit-btn')) {
                    const expenseToEdit = expenses[expenseIndex];
                    currentEditId = id;
                    document.getElementById('edit-date').value = toLocalDateInput(expenseToEdit.date);
                    document.getElementById('edit-category').value = expenseToEdit.category;
                    document.getElementById('edit-description').value = expenseToEdit.description;
                    document.getElementById('edit-amount').value = expenseToEdit.amount;
                    clearValidationErrors(editForm);
                    showModal(editModal);
                }
            });

            editForm.addEventListener('submit', e => {
                e.preventDefault();
                if (!validateForm(editForm)) {
                    showToast('Please correct the highlighted fields. ❌', 'error');
                    return;
                }

                const expenseIndex = expenses.findIndex(exp => exp.id === currentEditId);
                if (expenseIndex > -1) {
                    const updatedExpense = {
                        id: currentEditId,
                        date: toLocalDateInput(document.getElementById('edit-date').value),
                        category: document.getElementById('edit-category').value, 
                        description: document.getElementById('edit-description').value.trim(),
                        amount: parseFloat(document.getElementById('edit-amount').value),
                    };
                    expenses[expenseIndex] = updatedExpense;
                    persistExpensesToLocalStorage();

                    // Find the existing row by ID and update its contents
                    const existingRow = expenseTableBody.querySelector(`tr[data-id="${currentEditId}"]`);
                    if (existingRow) {
                        const date = new Date(updatedExpense.date + 'T00:00:00Z'); 
                        const formattedDate = date.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'UTC' });

                        // Update individual cells, or replace innerHTML but keep event listeners via parent
                        // A more robust way would be to create new TDs, but for small changes direct content is fine.
                        existingRow.children[0].textContent = formattedDate; // Date
                        existingRow.children[1].textContent = stripEmojis(updatedExpense.category); // Category
                        existingRow.children[2].textContent = updatedExpense.description; // Description
                        existingRow.children[3].textContent = formatCurrency(updatedExpense.amount); // Amount (assuming it's the 4th td)
                    } else {
                        // If for some reason the row wasn't found (e.g., it was filtered out), re-render the whole table.
                        renderExpenses();
                    }
                    
                    updateTotal();
                    updateExpenseSummary();
                    showToast('Changes Saved! ✨', 'success');
                }
                closeModal(editModal);
                currentEditId = null;
            });

            addCategoryBtn.addEventListener('click', () => {
                clearValidationErrors(addCategoryForm);
                document.getElementById('new-category-name').value = '';
                showModal(addCategoryModal);
            });

            addCategoryForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newCatNameInput = document.getElementById('new-category-name');
                const newCategoryName = newCatNameInput.value.trim(); 

                if (!validateInput(newCatNameInput)) return; 
                
                categories.push(stripEmojis(newCategoryName)); 
                saveCategories(); // This will also re-populate dropdowns
                closeModal(addCategoryModal);
                showToast(`Category "${newCategoryName}" Added! 🎉`, 'success');
            });
            
            document.querySelectorAll('.cancel-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const parentModal = e.target.closest('.modal-overlay');
                    if (parentModal) closeModal(parentModal);
                });
            });

            clearDataBtn.addEventListener('click', () => {
                const isCategoriesDefault = JSON.stringify([...categories].map(c => stripEmojis(c)).sort()) === JSON.stringify([...DEFAULT_CATEGORIES].sort());
                const hasExpenses = expenses.length > 0;

                if (!hasExpenses && isCategoriesDefault) {
                    showToast('No user data to clear. 🧹', 'info');
                    return;
                }
                showModal(clearConfirmModal);
            });

            confirmClearDataBtn.addEventListener('click', () => {
                expenses = [];
                categories = [...DEFAULT_CATEGORIES]; 
                localStorage.clear();

                sortConfig = { key: 'date', direction: 'desc' };
                localStorage.setItem('sortConfig', JSON.stringify(sortConfig));
                
                persistExpensesToLocalStorage(); 
                saveCategories(); // This will populate dropdowns with default categories
                updateWelcomeMessage(); 
                
                // Clear filters and re-render everything from scratch
                categoryFilter.value = 'all';
                startDateFilter.value = '';
                endDateFilter.value = '';
                updateExpenseTableAndSummary(); // Triggers full render and summary update

                closeModal(clearConfirmModal);
                showToast('All expense data cleared! ✅', 'success');
            });

            // These event listeners should trigger a full re-render for filtering/sorting
            categoryFilter.addEventListener('change', updateExpenseTableAndSummary);
            startDateFilter.addEventListener('change', () => { 
                validateInput(startDateFilter); 
                validateInput(endDateFilter); 
                updateExpenseTableAndSummary(); 
            });
            endDateFilter.addEventListener('change', () => { 
                validateInput(endDateFilter); 
                validateInput(startDateFilter); 
                updateExpenseTableAndSummary(); 
            });

            document.querySelectorAll('.expense-table th[data-sort-by]').forEach(header => {
                header.addEventListener('click', () => {
                    const newSortKey = header.dataset.sortBy;
                    if (sortConfig.key === newSortKey) {
                        sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortConfig.key = newSortKey;
                        // Default descending for numeric/date, ascending for text
                        if (newSortKey === 'date' || newSortKey === 'amount') {
                            sortConfig.direction = 'desc'; 
                        } else {
                            sortConfig.direction = 'asc'; 
                        }
                    }
                    localStorage.setItem('sortConfig', JSON.stringify(sortConfig));
                    updateExpenseTableAndSummary(); // Re-render for sorting
                });
            });

            const getFilteredAndSortedExpenses = () => {
                const filterValue = categoryFilter.value;
                const start = startDateFilter.value ? new Date(startDateFilter.value + 'T00:00:00Z') : null;
                const end = endDateFilter.value ? new Date(endDateFilter.value + 'T00:00:00Z') : null;

                let filtered = [...expenses]; // Start with a copy of the main expenses array

                if (filterValue !== 'all') {
                    filtered = filtered.filter(exp => stripEmojis(exp.category) === stripEmojis(filterValue));
                }
                if (start && !isNaN(start.getTime())) { 
                    filtered = filtered.filter(exp => new Date(exp.date + 'T00:00:00Z') >= start);
                }
                if (end && !isNaN(end.getTime())) { 
                    const endOfDay = new Date(end.valueOf()); 
                    endOfDay.setUTCHours(23, 59, 59, 999);
                    filtered = filtered.filter(exp => new Date(exp.date + 'T00:00:00Z') <= endOfDay);
                }

                filtered.sort((a, b) => {
                    let valA, valB;
                    if (sortConfig.key === 'date') {
                        valA = new Date(a.date);
                        valB = new Date(b.date);
                    } else if (sortConfig.key === 'amount') {
                        valA = a.amount;
                        valB = b.amount;
                    } else {
                        valA = stripEmojis(String(a[sortConfig.key])).toLowerCase(); 
                        valB = stripEmojis(String(b[sortConfig.key])).toLowerCase();
                    }

                    if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
                
                return filtered;
            };

            sendEmailBtn.addEventListener('click', () => {
                const expensesToReport = getFilteredAndSortedExpenses();
                if (expensesToReport.length === 0) {
                    showToast('There are no expenses to report matching your current filters. 🧐', 'info');
                    return;
                }

                const email = prompt("📧 Please enter your email address to send the report:");
                if (!email) { showToast("Email sending cancelled. ❌", 'info'); return; }
                if (!email.includes('@')) { showToast("Please enter a valid email address. ⚠️", 'error'); return; }
                
                const userName = localStorage.getItem('userName') || "User";
                const totalReportAmount = expensesToReport.reduce((sum, expense) => sum + expense.amount, 0);

                let dateRange = "All Time";
                let currentMonthYear = '';
                const startDate = startDateFilter.value ? new Date(startDateFilter.value + 'T00:00:00Z') : null;
                const endDate = endDateFilter.value ? new Date(endDateFilter.value + 'T00:00:00Z') : null;

                if (startDate && endDate) {
                    dateRange = `${startDate.toLocaleDateString('en-US', {day:'numeric', month:'short', year:'numeric', timeZone:'UTC'})} - ${endDate.toLocaleDateString('en-US', {day:'numeric', month:'short', year:'numeric', timeZone:'UTC'})}`;
                } else if (startDate) {
                    dateRange = `From ${startDate.toLocaleDateString('en-US', {day:'numeric', month:'short', year:'numeric', timeZone:'UTC'})}`;
                } else if (endDate) {
                    dateRange = `To ${endDate.toLocaleDateString('en-US', {day:'numeric', month:'short', year:'numeric', timeZone:'UTC'})}`;
                } else {
                     if (expensesToReport.length > 0) {
                        const firstDate = new Date(expensesToReport[0].date + 'T00:00:00Z');
                        const lastDate = new Date(expensesToReport[expensesToReport.length - 1].date + 'T00:00:00Z');
                        if (firstDate.getUTCMonth() === lastDate.getUTCMonth() && firstDate.getUTCFullYear() === lastDate.getUTCFullYear()) {
                            dateRange = `${firstDate.toLocaleDateString('en-US', {month:'long', year:'numeric', timeZone:'UTC'})}`;
                            currentMonthYear = dateRange; 
                        }
                    }
                }

                const spendingByCategoryReport = expensesToReport.reduce((acc, exp) => {
                    const categoryName = stripEmojis(exp.category); 
                    acc[categoryName] = (acc[categoryName] || 0) + exp.amount;
                    return acc;
                }, {});

                const sortedTopCategories = Object.entries(spendingByCategoryReport)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 3); 

                let topCategoriesSummary = '';
                if (sortedTopCategories.length > 0) {
                    topCategoriesSummary = sortedTopCategories.map(([cat, amount]) => {
                        const percent = (amount / totalReportAmount) * 100;
                        return `- ${cat}: ${formatCurrency(amount)} (${percent.toFixed(1)}%)`;
                    }).join('\n');
                } else {
                    topCategoriesSummary = 'No categorized spending for this period.';
                }
                
                let subject = 'Smart Expense Tracker Report';
                if (currentMonthYear) {
                    subject = `${currentMonthYear} Expense Report - Smart Expense Tracker`;
                } else if (dateRange !== 'All Time') {
                    subject += ` (${dateRange})`;
                }

                let body = '';
                body += `Dear ${userName},\n\n`;
                body += `Here is your detailed expense report for the period: ${dateRange}.\n\n`;
                body += `--- REPORT SUMMARY ---\n`;
                body += `Total Spending: ${formatCurrency(totalReportAmount)}\n\n`;
                body += `Top Categories:\n${topCategoriesSummary}\n`;
                body += `----------------------\n\n`;

                body += `--- DETAILED EXPENSES ---\n\n`;
                body += `Date       Category         Description                 Amount\n`;
                body += `---------- --------------- ---------------------------- ----------\n`;
                expensesToReport.forEach(expense => {
                    const date = new Date(expense.date + 'T00:00:00Z'); 
                    const formattedDate = date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: '2-digit', timeZone: 'UTC' });
                    
                    const paddedDescription = expense.description.length > 25 ? expense.description.substring(0, 22) + '...' : expense.description;

                    body += `${formattedDate.padEnd(11)}`; 
                    body += `${stripEmojis(expense.category).padEnd(16)}`; 
                    body += `${paddedDescription.padEnd(29)}`; 
                    body += `${formatCurrency(expense.amount).padStart(10)}\n`; 
                });
                body += `-----------------------------------------------------------\n`;
                body += `TOTAL:                                                ${formatCurrency(totalReportAmount).padStart(10)}\n`;
                body += `===========================================================\n\n`;

                let filtersApplied = [];
                if (categoryFilter.value !== 'all') { filtersApplied.push(`Category: ${stripEmojis(categoryFilter.value)}`); } 
                if (startDateFilter.value) { filtersApplied.push(`From Date: ${toLocalDateInput(startDateFilter.value)}`); }
                if (endDateFilter.value) { filtersApplied.push(`To Date: ${toLocalDateInput(endDateFilter.value)}`); }

                if (filtersApplied.length > 0) {
                    body += `Note: This report includes data filtered by: ${filtersApplied.join(', ')}.\n\n`;
                }
                
                body += `We hope this report helps you in managing your finances effectively!\n`;
                body += `\nBest regards,\nYour Smart Expense Tracker Team\n`;
                body += `\nThis report was generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}.`;
                
                const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoLink;
                
                showToast('Attempting to open email client with report... 📧', 'info', 3000);
                
                setTimeout(() => {
                    const userConfirmedCopy = confirm("Your email client should have opened now. If it didn't, would you like to copy the report text to your clipboard instead?");
                    if (userConfirmedCopy) {
                        navigator.clipboard.writeText(body)
                            .then(() => showToast('Report copied to clipboard! 📋', 'success', 4000))
                            .catch(err => showToast('Failed to copy report to clipboard: ' + err + ' ❌', 'error', 4000));
                    }
                }, 1000); 
            });

            document.querySelectorAll('input[required], select[required], input[type="number"], #new-category-name').forEach(input => {
                input.addEventListener('blur', () => validateInput(input));
                input.addEventListener('input', () => { 
                    if (input.classList.contains('invalid')) { 
                        validateInput(input);
                    }
                });
            });

            // --- Initialization ---
            const initializeApp = () => {
                updateWelcomeMessage(); 
                populateCategoryDropdowns();
                document.getElementById('expense-date').valueAsDate = new Date(); 
                renderExpenses(); // Initial render of all expenses
                updateTotal();
                updateExpenseSummary(); 
            };

            initializeApp();
        });
    </script>
</body>
</html>