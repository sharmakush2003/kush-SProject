<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1024"> 
    <title>My Smart Expense Tracker 💰</title>
    <link rel="icon" type="image/png" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3e%3cpath fill='%23f1c40f' d='M19 12h-6V6h-2v6H5v2h6v6h2v-6h6z'/%3e%3csvg%3e">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /*
            --- Cleaned & Reorganized CSS ---
            - Removed all transitions and blur effects for an instant, static UI.
            - Grouped related selectors for better readability.
            - Added comments to delineate sections.
        */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap');
        
        /* --- ROOT VARIABLES --- */
        :root {
            --primary-color: #9B59B6;
            --secondary-color: #4BC0D9;
            --accent-color: #FFE66D;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --info-color: #6CCFEA;
            --white-color: #F5F5F5;
            --text-color: #ecf0f1;
            --background-gradient-start: #2c3e50;
            --background-gradient-mid-1: #34495e;
            --background-gradient-mid-2: #23a6d5;
            --background-gradient-end: #23d5ab;
            --soft-dark-bg: rgba(0, 0, 0, 0.45); 
            --modal-bg: rgba(44, 62, 80, 0.95); 
            --border-alpha: rgba(255, 255, 255, 0.25); 
            --input-border-alpha: rgba(255, 255, 255, 0.4); 
            --shadow-light: rgba(0, 0, 0, 0.8); 
            --shadow-button: rgba(0,0,0,0.5); 
            --bg-glass-active: rgba(0,0,0,0.6); 
            --current-currency-symbol: '₹';
            --chart-color-1: #9B59B6;
            --chart-color-2: #4BC0D9;
            --chart-color-3: #FFE66D;
            --chart-color-4: #e74c3c;
            --chart-color-5: #2ecc71;
            --chart-color-6: #6CCFEA;
            --chart-color-7: #fd79a8;
            --chart-color-8: #a29bfe;
            --chart-color-9: #fab1a0;
            --chart-color-10: #00b894;
        }

        /* --- GLOBAL & ANIMATIONS --- */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        @keyframes gradient-animation { 
            0%{background-position:0% 50%} 
            50%{background-position:100% 50%} 
            100%{background-position:0% 50%} 
        }
       
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, var(--background-gradient-start), var(--background-gradient-mid-1), var(--background-gradient-mid-2), var(--background-gradient-end));
            background-size: 400% 400%; 
            animation: gradient-animation 15s ease infinite; 
            color: var(--text-color); 
            min-height: 100vh; 
            padding: 20px;
            display: flex; 
            align-items: flex-start;
            justify-content: center;
            position: relative;
        }

        /* --- LAYOUT & CONTAINERS --- */
        .container {
            width: 100%; 
            max-width: 950px; 
            padding: 40px; 
            background: var(--soft-dark-bg); 
            border-radius: 20px;
            box-shadow: 0 15px 50px var(--shadow-light), inset 0 0 10px rgba(255,255,255,0.1); 
            border: 1px solid var(--border-alpha);
            margin: auto;
            position: relative;
        }

        .app-footer {
            text-align: center;
            margin-top: 60px; 
            padding-top: 30px; 
            border-top: 1px dashed rgba(255, 255, 255, 0.15); 
        }

        /* --- HEADINGS & TEXT --- */
        h1 {
            font-size: 2.8rem; 
            text-align: center; 
            margin-bottom: 10px; 
            font-weight: 800;
            background: linear-gradient(45deg, var(--white-color), var(--accent-color));
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent;
            text-shadow: 0 5px 12px rgba(0,0,0,0.5); 
            letter-spacing: 1px; 
        }

        h2 {
            font-size: 2rem; 
            text-align: center; 
            color: var(--text-color); 
            margin: 45px 0 30px 0; 
            font-weight: 700;
            border-top: 1px solid var(--border-alpha); 
            padding-top: 30px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 12px; 
            letter-spacing: 0.5px;
        }
        h2 i { color: var(--accent-color); font-size: 1.7rem; }

        #welcome-message {
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 25px; 
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
        }

        .copyright-notice {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0; 
            font-weight: 300; 
            letter-spacing: 0.5px; 
        }
        
        /* --- TOP & UTILITY BAR --- */
        #utility-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        #settings-button {
            background: var(--soft-dark-bg);
            color: var(--text-color);
            padding: 10px 18px;
            border: 1px solid var(--border-alpha);
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px var(--shadow-button);
        }
        #settings-button:hover { background: var(--bg-glass-active); }

        /* --- TOTAL EXPENSES DISPLAY (ENHANCED) --- */
        .total-expenses-wrapper {
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid var(--border-alpha);
        }
        .total-expenses h3 { 
            font-weight: 500; 
            font-size: 1.1rem; 
            color: rgba(255, 255, 255, 0.8); 
            text-transform: uppercase;
            letter-spacing: 1.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        } 
        .total-expenses #total-amount { 
            font-size: 3.5rem; 
            font-weight: 800; 
            color: var(--accent-color); 
            text-shadow: 0 3px 10px rgba(0,0,0,0.4);
        }
        
        /* --- FORM ELEMENTS --- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .form-control.full-width { grid-column: 1 / -1; }
        .form-control { display: flex; flex-direction: column; position: relative; }

        label { 
            margin-bottom: 10px; 
            font-weight: 600; 
            font-size: 0.9rem; 
            text-transform: uppercase; 
            letter-spacing: 0.8px; 
            opacity: 0.95; 
            color: var(--text-color); 
        } 
        
        input[type="text"], input[type="number"], input[type="date"], select {
            padding: 16px; 
            border: 1px solid var(--input-border-alpha); 
            border-radius: 10px; 
            font-size: 17px; 
            background: rgba(0, 0, 0, 0.35); 
            color: var(--text-color); 
            font-family: 'Poppins', sans-serif;
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.25); 
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }

        select { 
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); 
            background-repeat: no-repeat;
            background-position: right 15px center; 
            padding-right: 40px; 
            cursor: pointer;
        }
        select option { background-color: #2c3e50; color: var(--text-color); padding: 10px; }
        input::placeholder { color: rgba(255, 255, 255, 0.8); }

        input:focus, select:focus {
            outline: none; background: var(--bg-glass-active); 
            border-color: var(--primary-color);
            box-shadow: 0 0 20px var(--primary-color), inset 0 2px 10px rgba(0,0,0,0.4); 
        }
        
        input.invalid, select.invalid { 
            border-color: var(--danger-color); 
            box-shadow: 0 0 15px var(--danger-color), inset 0 2px 8px rgba(0,0,0,0.4); 
        } 
        
        .form-control .error-message { 
            position: relative; 
            margin-top: 5px; 
            font-size: 0.78rem; 
            color: var(--danger-color); 
            height: 1.1rem; 
            opacity: 0;
            white-space: nowrap; 
        }
        .form-control input.invalid + .error-message, .form-control select.invalid + .error-message { opacity: 1; }
        
        /* --- BUTTONS --- */
        .btn { 
            padding: 16px 25px; border: none; border-radius: 10px; 
            cursor: pointer; font-size: 17px; font-weight: 600; text-align: center; 
            letter-spacing: 0.8px; white-space: nowrap;
            display: inline-flex; align-items: center; justify-content: center; 
            line-height: 1; 
            box-shadow: 0 8px 25px var(--shadow-button);
            color: var(--white-color);
        }
        .btn:hover { 
            box-shadow: 0 14px 40px var(--shadow-light); 
        } 
        .btn-primary { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); } 
        .btn-primary:hover { background: linear-gradient(45deg, color-mix(in srgb, var(--primary-color) 80%, black), color-mix(in srgb, var(--secondary-color) 80%, black)); } 
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: color-mix(in srgb, var(--danger-color) 80%, black); }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: color-mix(in srgb, var(--success-color) 80%, black); }
        .btn-info { background-color: var(--info-color); }
        .btn-info:hover { background-color: color-mix(in srgb, var(--info-color) 80%, black); }
        .btn i { margin-right: 10px; font-size: 1rem; } 
        .btn:disabled {
            background: #555;
            color: #999;
            cursor: not-allowed;
            box-shadow: none;
        }

        .actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 40px; } 

        #dev-info-button, #year-in-review-btn {
            background: var(--soft-dark-bg);
            color: var(--text-color);
            padding: 10px 18px;
            border: 1px solid var(--border-alpha);
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-flex; 
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px var(--shadow-button);
            margin: 0 5px 15px 5px; 
            width: fit-content; 
        }
        #dev-info-button:hover, #year-in-review-btn:hover { background: var(--bg-glass-active); }

        /* --- SUMMARY & ANALYSIS SECTIONS --- */
        #expense-summary-section, #expense-analysis-section { 
            background: rgba(0,0,0,0.3);
            padding: 30px; border-radius: 18px; border: 1px solid var(--border-alpha);
            box-shadow: 0 8px 30px var(--shadow-button), inset 0 0 8px rgba(255,255,255,0.05);
            margin-bottom: 30px; margin-top: 40px; 
        }
        #expense-summary-section h3, #expense-analysis-section h3 {
            font-size: 1.6rem; color: var(--accent-color); font-weight: 700;
            margin-bottom: 25px; padding-bottom: 20px; 
            border-bottom: 1px dashed var(--border-alpha); 
            display: flex; align-items: center; justify-content: center; gap: 15px;
            text-align: center;
        }
        #expense-summary-section h3 i, #expense-analysis-section h3 i { 
            color: var(--accent-color); font-size: 1.4rem; 
        } 
        #expense-summary-content p, #analysis-suggestions-content p { 
            display: flex; align-items: flex-start;
            padding: 15px; background: rgba(0,0,0,0.2); 
            border-left: 5px solid var(--secondary-color); 
            margin-bottom: 12px; border-radius: 10px; 
            line-height: 1.7; font-size: 1.05rem; gap: 15px;
            color: rgba(255,255,255,0.85);
        }
        #expense-summary-content p span, #analysis-suggestions-content p span { flex-grow: 1; }
        #expense-summary-content p:last-child, #analysis-suggestions-content p:last-child { margin-bottom: 0; }
        #expense-summary-content strong, #analysis-suggestions-content strong { color: var(--white-color); font-weight: 700; }
        #expense-summary-content .good-news, #analysis-suggestions-content .good-news { border-left-color: var(--success-color); }
        #expense-summary-content .bad-news, #analysis-suggestions-content .bad-news { border-left-color: var(--danger-color); }
        #expense-summary-content p i, #analysis-suggestions-content p i { 
            font-size: 1.2rem; flex-shrink: 0; margin-top: 2px; color: var(--secondary-color); 
        }
        #analysis-suggestions-content .good-news i, #analysis-suggestions-content .bad-news i { color: unset; }

        /* --- PIE CHART --- */
        #expense-analysis-content {
            display: flex; justify-content: center; align-items: center; gap: 30px; flex-wrap: wrap; 
        }
        #pie-chart-container {
            flex: 0 0 380px; height: 380px; display: flex;
            justify-content: center; align-items: center; padding: 10px;
            background: rgba(0,0,0,0.2); border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
            position: relative;
        }
        #expenseChart { max-height: 100%; max-width: 100%; }
        #analysis-suggestions-content {
            flex: 1 1 400px; max-width: calc(100% - 380px - 30px);
        }

        /* --- EXPENSE LOG & TABLE --- */
        .expense-controls { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 20px; align-items: flex-end; margin-bottom: 25px; 
        } 
        .expense-controls .form-control { min-width: unset; flex: unset; }
        .expense-controls #date-filter-group { 
            grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 20px; 
            padding: 20px 0 10px; border-top: 1px dashed var(--border-alpha); margin-top: 20px; 
        }
        .expense-table-container { 
            max-height: 400px; overflow-y: auto; 
            background: rgba(0,0,0,0.28);
            border-radius: 10px; border: 1px solid var(--border-alpha);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.15);
        }
        .expense-table-container::-webkit-scrollbar { width: 10px; } 
        .expense-table-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 10px; }
        .expense-table-container::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 10px; border: 2px solid rgba(0,0,0,0.2); } 
        .expense-table { width: 100%; border-collapse: collapse; }
        .expense-table th, .expense-table td { padding: 14px 18px; text-align: left; vertical-align: middle; color: var(--text-color); }
        .expense-table thead { position: sticky; top: 0; z-index: 10; }
        .expense-table thead tr { background: rgba(0, 0, 0, 0.7); border-bottom: 1px solid var(--border-alpha); } 
        .expense-table th { 
            font-weight: 700; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 0.8px; 
            color: rgba(255, 255, 255, 0.95);
            cursor: pointer; white-space: nowrap;
        }
        .expense-table th:hover { color: var(--accent-color); background: rgba(0,0,0,0.75); } 
        .expense-table th .sort-icon { margin-left: 8px; font-size: 0.8em; } 
        .expense-table tbody tr { border-bottom: 1px dashed var(--border-alpha); background-color: rgba(0,0,0,0.2); } 
        .expense-table tbody tr:last-child { border-bottom: none; }
        .expense-table tbody tr:hover { background-color: rgba(0,0,0,0.45); } 
        .expense-table .col-amount { font-weight: 700; color: var(--accent-color); text-align: right; }
        .expense-table .col-actions { width: 120px; text-align: center; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 1.3rem; padding: 6px; color: var(--text-color); opacity: 0.8; line-height: 1; }
        .action-btn:hover { opacity: 1; } 
        .action-btn.edit-btn:hover { color: var(--secondary-color); }
        .action-btn.duplicate-btn:hover { color: var(--success-color); }
        .action-btn.delete-btn:hover { color: var(--danger-color); }

        /* --- TOAST NOTIFICATIONS --- */
        #toast-container { 
            position: fixed; top: 25px; right: 25px; z-index: 2000; 
            display: flex; flex-direction: column; gap: 12px; pointer-events: none;
        } 
        .toast {
            background-color: var(--modal-bg); color: var(--text-color); 
            padding: 18px 30px; border-radius: 10px; 
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4); 
            opacity: 0; transform: translateX(100%); 
            min-width: 280px; text-align: center;
            border: 1px solid var(--border-alpha);
            font-weight: 500;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .toast button {
            padding: 5px 10px; margin-left: 10px; border: 1px solid var(--border-alpha);
            background: rgba(255,255,255,0.1); color: var(--text-color);
            border-radius: 5px; cursor: pointer; pointer-events: all;
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.hide-effect { opacity: 0; transform: translateX(100%); }
        .toast i { font-size: 1.2em; }
        .toast.success { border-left: 6px solid var(--success-color); } 
        .toast.success i { color: var(--success-color); }
        .toast.error { border-left: 6px solid var(--danger-color); }
        .toast.error i { color: var(--danger-color); }
        .toast.info { border-left: 6px solid var(--info-color); }
        .toast.info i { color: var(--info-color); }

        /* --- MODAL STYLES --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 1000; 
            display: none; align-items: center; justify-content: center; 
        }
        .modal-overlay.active { display: flex; }
        .modal-content { 
            background: var(--modal-bg); border-radius: 20px; 
            box-shadow: 0 20px 60px var(--shadow-light), inset 0 0 10px rgba(255,255,255,0.05); 
            border: 1px solid var(--border-alpha); 
            padding: 45px; width: 90%; max-width: 650px; 
            position: relative; max-height: 90vh; overflow-y: auto; color: var(--text-color); 
        }

        #settings-modal .modal-content, #budget-modal .modal-content { max-width: 500px; }
        #settings-modal h2, #budget-modal h2, #year-in-review-modal h2 { 
            margin: 0 0 30px 0; justify-content: center; padding-top: 0; border-top: none; 
        }
        .settings-option { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px dashed var(--border-alpha); }
        #settings-modal .settings-option:last-of-type, #budget-modal .budget-item:last-of-type { border-bottom: none; }
        .settings-option label, .settings-action-link, .budget-item label { margin-bottom: 0; font-size: 1rem; text-transform: none; letter-spacing: normal; }
        .settings-action-link { color: var(--info-color); text-decoration: none; display: flex; align-items: center; gap: 8px; font-weight: 500; }
        .settings-action-link:hover { text-decoration: underline; }

        /* --- BUDGETING MODULE STYLES --- */
        .budget-item {
            display: grid; grid-template-columns: 1fr 150px; gap: 15px;
            align-items: center; padding: 15px 0; border-bottom: 1px dashed var(--border-alpha);
        }
        .budget-item label { font-weight: 500; }
        .budget-item .budget-input-wrapper { display: flex; align-items: center; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid var(--input-border-alpha); }
        .budget-item .budget-input-wrapper span { padding-left: 12px; color: var(--accent-color); }
        .budget-item .budget-input-wrapper input { border: none; background: transparent; box-shadow: none; text-align: right; padding-right: 12px; width: 100%; }
        .budget-summary { padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 12px; }
        .budget-summary h4 { margin-bottom: 10px; font-weight: 600; display: flex; justify-content: space-between; }
        .progress-bar-container { width: 100%; height: 12px; background-color: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden; margin: 8px 0; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--success-color), var(--accent-color)); border-radius: 6px; }
        .progress-bar.warning { background: linear-gradient(90deg, var(--accent-color), var(--danger-color)); }
        .progress-bar.exceeded { background-color: var(--danger-color); }
        .budget-details { font-size: 0.9rem; opacity: 0.8; display: flex; justify-content: space-between; }

        /* --- RECURRING EXPENSE STYLES --- */
        #recurring-options-container { display: none; flex-direction: column; gap: 10px; margin-top: 15px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; }
        .recurring-toggle { display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.95rem; }
        .recurring-toggle input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

        /* --- YEAR IN REVIEW & DEV MODAL STYLES --- */
        #developer-modal .modal-content { text-align: left; }
        #developer-modal .modal-content h2 { margin: 0 0 20px 0; padding-top: 0; border-top: none; justify-content: flex-start; }
        #developer-modal .modal-content h3 { color: var(--secondary-color); margin-top: 25px; margin-bottom: 10px; font-size: 1.3rem; font-weight: 600; }
        #developer-modal .modal-content p, #developer-modal .modal-content ul { font-size: 0.98rem; line-height: 1.6; margin-bottom: 15px; }
        #developer-modal .modal-content ul { margin-left: 20px; list-style-type: disc; }
        #developer-modal .modal-content ul li { margin-bottom: 8px; }
        #developer-modal .modal-content strong { color: var(--white-color); }
        #developer-modal .modal-content a { color: var(--info-color); text-decoration: none; font-weight: 500; }
        #developer-modal .modal-content a:hover { text-decoration: underline; }
        #developer-modal .contact-links i { margin-right: 8px; color: var(--accent-color); }

        #year-in-review-modal .modal-content { max-width: 700px; text-align: center; }
        .review-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; text-align: left; margin-top: 20px; }
        .stat-card { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; border: 1px solid var(--border-alpha); }
        .stat-card h4 { font-size: 1rem; font-weight: 400; opacity: 0.8; margin-bottom: 8px; }
        .stat-card .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--accent-color); }
        .stat-card .stat-details { font-size: 0.9rem; opacity: 0.7; }
        .stat-card.full-width { grid-column: 1 / -1; }

        /* --- SPEECH RECOGNITION --- */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; }
        }
        #speak-description-btn { background: linear-gradient(45deg, #1abc9c, #16a085); }
        #speak-description-btn:hover:not(:disabled) { background: linear-gradient(45deg, color-mix(in srgb, #1abc9c 80%, black), color-mix(in srgb, #16a085 80%, black)); }
        #speak-description-btn.recognizing {
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5), inset 0 0 5px rgba(0, 255, 0, 0.3);
            background: linear-gradient(45deg, #1abc9c, #16a085) !important;
            cursor: not-allowed; opacity: 0.9;
        }
        #speak-description-btn.recognizing i { animation: pulse 1.5s infinite; }
        #speak-description-btn.recognizing span { font-weight: 700; }

    </style>
</head>
<body>
    <div id="utility-bar">
        <button id="settings-button" type="button" aria-label="Open Settings"><i class="fas fa-cog" aria-hidden="true"></i> Settings</button>
    </div>

    <div class="container">
        <h1>Smart Expense Tracker 💰</h1>
        <p id="welcome-message"></p>
        
        <!-- ENHANCED TOTAL EXPENSES DISPLAY -->
        <div class="total-expenses-wrapper">
            <div class="total-expenses">
                <h3><i class="fas fa-wallet"></i>Total Lifetime Expenses</h3>
                <div id="total-amount">₹0.00</div>
            </div>
        </div>

        <div id="expenses-section">
            <form id="expense-form">
                <div class="form-grid">
                    <div class="form-control"><label for="expense-date">Date</label><input type="date" id="expense-date" required><span class="error-message"></span></div>
                    <div class="form-control"><label for="expense-category">Category</label><select id="expense-category" required></select><span class="error-message"></span></div>
                    <div class="form-control full-width"><label for="expense-description">Description</label><input type="text" id="expense-description" placeholder="e.g., Lunch with team" required><span class="error-message"></span></div>
                    <div class="form-control full-width"><label for="expense-amount">Amount (<span id="currency-label-main">₹</span>)</label><input type="number" id="expense-amount" placeholder="e.g., 1250.50" step="0.01" min="0.01" required><span class="error-message"></span></div>
                    <div class="form-control full-width" id="recurring-options-container"><label for="recurring-frequency">Recurring Frequency</label><select id="recurring-frequency"><option value="weekly">Weekly</option><option value="monthly" selected>Monthly</option><option value="yearly">Yearly</option></select></div>
                </div>
                <div class="form-control full-width" style="margin-top: 15px;"><label class="recurring-toggle"><input type="checkbox" id="recurring-checkbox"/>Mark as a new recurring expense</label></div>
                <div style="margin-top:25px; display:flex; flex-wrap:wrap; gap:10px;">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-plus" aria-hidden="true"></i> Add Expense</button>
                    <button type="button" id="manage-recurring-btn" class="btn btn-info"><i class="fas fa-sync-alt" aria-hidden="true"></i> Recurring</button>
                    <button type="button" id="speak-description-btn" class="btn"><i class="fas fa-microphone" aria-hidden="true"></i> Speak</button>
                </div>
            </form>
            
            <div id="expense-summary-section">
                <h3><i class="fas fa-chart-line" aria-hidden="true"></i> Your Monthly Summary</h3>
                <div id="expense-summary-content"><p style="text-align: center; color: rgba(255,255,255,0.7); border: none; background: none;"><i class="fas fa-hand-holding-usd" style="margin-right: 8px;" aria-hidden="true"></i> <span>Add some expenses to see a summary here! 🚀</span></p></div>
            </div>

            <div id="expense-analysis-section">
                <h3><i class="fas fa-chart-pie" aria-hidden="true"></i> Detailed Expense Analysis</h3>
                <div id="expense-analysis-content">
                    <div id="pie-chart-container"><canvas id="expenseChart"></canvas><p id="no-chart-data-message" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; text-align: center; color: rgba(255,255,255,0.7); width: 80%;">No data for analysis. Add expenses or adjust filters. 📊</p></div>
                    <div id="analysis-suggestions-content"><p style="text-align: center; color: rgba(255,255,255,0.7); border: none; background: none;"><i class="fas fa-lightbulb" style="margin-right: 8px;" aria-hidden="true"></i> <span>Insights will appear here once you have expense data!💡</span></p></div>
                </div>
            </div>

            <h2><i class="fas fa-list-alt" aria-hidden="true"></i> Your Expense Log</h2>
            <div class="expense-controls">
                <div class="form-control"><label for="category-filter">Filter by Category</label><select id="category-filter"></select></div>
                <div id="date-filter-group">
                    <div class="form-control"><label for="start-date-filter">From Date</label><input type="date" id="start-date-filter"><span class="error-message"></span></div>
                    <div class="form-control"><label for="end-date-filter">To Date</label><input type="date" id="end-date-filter"><span class="error-message"></span></div>
                </div>
            </div>
            
            <div class="expense-table-container">
                <table class="expense-table">
                    <thead>
                        <tr>
                            <th data-sort-by="date">Date <span class="sort-icon"></span></th>
                            <th data-sort-by="category">Category <span class="sort-icon"></span></th>
                            <th data-sort-by="description">Description <span class="sort-icon"></span></th>
                            <th data-sort-by="amount" class="col-amount">Amount <span class="sort-icon"></span></th>
                            <th class="col-actions">Action</th>
                        </tr>
                    </thead>
                    <tbody id="expense-table-body"></tbody>
                </table>
            </div>

            <div class="actions">
                <button type="button" id="send-email-btn" class="btn btn-primary"><i class="fas fa-envelope" aria-hidden="true"></i> Send Report to Email</button>
                <button type="button" id="clear-data-btn" class="btn btn-danger"><i class="fas fa-trash-alt" aria-hidden="true"></i> Clear All Data</button>
            </div>
        </div>

        <div class="app-footer">
            <button type="button" id="dev-info-button" aria-label="Developer Information"><i class="fas fa-code" aria-hidden="true"></i> About the Developer</button>
            <button type="button" id="year-in-review-btn" aria-label="View Year in Review"><i class="fas fa-calendar-check" aria-hidden="true"></i> Year in Review</button>
            <p class="copyright-notice">All rights reserved © Kush Sharma 2025</p>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal-content">
            <h2>App Settings <i class="fas fa-cogs"></i></h2>
            <div class="settings-option"><label for="currency-select">Currency:</label><select id="currency-select"></select></div>
            <div class="settings-option"><label>Manage Budgets:</label><a href="#" id="set-budgets-btn" class="settings-action-link" aria-label="Set Budgets" title="Set your monthly budgets"><i class="fas fa-piggy-bank"></i> Set Budgets</a></div>
            <div class="settings-option"><label>Report a Bug:</label><a href="mailto:kushsharma.cor@gmail.com?subject=Bug Report - Smart Expense Tracker" class="settings-action-link" aria-label="Report a bug via email" title="Send bug report email"><i class="fas fa-bug"></i> Send Email</a></div>
            <div class="modal-actions" style="margin-top: 25px;"><button type="button" class="btn btn-primary cancel-modal-btn"><i class="fas fa-check"></i> Done</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="developer-modal">
        <div class="modal-content">
            <h2>About The Developer ✨</h2>
            <div id="about-developer-content">
                 <p>Greetings, fellow developer! I'm <strong>Kush Sharma</strong>, a passionate and driven B.Tech IT student from Jaipur Engineering College and Research Centre. My academic journey, underscored by an 8.90 CGPA, has provided me with a strong foundation in core computer science principles, including Data Structures & Algorithms, DBMS, and Operating Systems.</p>
                <h3>💻 Expertise & Tech Stack:</h3>
                <p>My specialization lies in building robust and engaging web applications. I possess a solid understanding of both front-end (HTML, CSS, JavaScript) and back-end (Node.js, Express.js) technologies. I'm adept with SQL and NoSQL databases like MongoDB, leveraging Mongoose for efficient data management. My toolkit also includes essential developer tools like Git, GitHub, VS Code, and Postman. I am continuously expanding my horizons, currently diving into MCP Server, GitLab, and PrimsaORM to broaden my capabilities.</p>
                <h3>🚀 Key Experiences & Projects:</h3>
                <ul>
                    <li><strong>Web Development Intern (Matrix Education):</strong> Gained practical, hands-on experience developing responsive web pages ensuring cross-browser compatibility. My proudest achievement was independently designing and implementing my personal portfolio website, which showcases my skills and experience.<br>Visit it live: <a href="https://kush-website.vercel.app/" target="_blank" rel="noopener noreferrer">kush-website.vercel.app/ <i class="fas fa-external-link-alt"></i></a></li>
                    <li><strong>REST API for Data Management & Authentication:</strong> Built a comprehensive REST API using Node.js, Express.js, MongoDB, and Mongoose for user data management and secure authentication with JWT. This project reinforced my skills in routing, data persistence, schema design, and API testing with Postman, including error handling and validation. (Note: This project is currently for practice and is not hosted online).</li>
                    <li><strong>Kush's GenAI Chatbot:</strong> Explored the frontiers of AI by developing an experimental terminal-based AI chatbot integrated with Google's GenAI model. I implemented interactive text responses using ReadlineSync and enhanced the terminal UI/UX with animated feedback (Ora) and visual styling (Chalk), demonstrating my capacity for innovation and engaging interfaces even in unconventional environments. (Note: This is a conceptual implementation not hosted online).</li>
                </ul>
                <h3>💡 Beyond Coding: Leadership & Resilience:</h3>
                <p>I believe strong technical skills are complemented by robust soft skills. As a <strong>House Captain</strong>, I led a team of 800+ students, significantly boosting event participation through strategic engagement. My experience as a <strong>Kho-Kho Tournament Organizer</strong> and a <strong>District-Level Competitor</strong> in volleyball and cricket showcases my commitment to teamwork, seamless execution, and a competitive spirit.</p>
                <h3>📈 Aspirations:</h3>
                <p>I am actively seeking internship or entry-level opportunities that challenge me to expand my existing knowledge, collaborate within dynamic teams, and contribute to cutting-edge solutions. My goal is to apply my passion for web development to create impactful and user-centric applications.</p>
                <h3>📧 Connect with me:</h3>
                <p class="contact-links">
                    <i class="fas fa-envelope"></i> <a href="mailto:kushsharma.cor@gmail.com">kushsharma.cor@gmail.com</a><br>
                    <i class="fas fa-phone-alt"></i> +91 8233816674<br>
                    <i class="fab fa-linkedin"></i> <a href="https://www.linkedin.com/in/kush-sharma-9721a02ab/" target="_blank" rel="noopener noreferrer">LinkedIn <i class="fas fa-external-link-alt"></i></a><br>
                    <i class="fab fa-github"></i> <a href="https://github.com/sharmakush2003?tab=repositories" target="_blank" rel="noopener noreferrer">GitHub Repositories <i class="fas fa-external-link-alt"></i></a><br>
                    <i class="fas fa-link"></i> <a href="https://linktr.ee/sharmaKush2003" target="_blank" rel="noopener noreferrer">Linktree <i class="fas fa-external-link-alt"></i></a>
                </p>
            </div>
            <div class="modal-actions"><button type="button" class="btn btn-primary cancel-modal-btn"><i class="fas fa-arrow-left"></i> Back to App</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="edit-modal">
        <div class="modal-content">
            <h2>Edit Expense ✍️</h2>
            <form id="edit-form">
                <div class="form-grid">
                    <div class="form-control"><label for="edit-date">Date</label><input type="date" id="edit-date" required><span class="error-message"></span></div>
                    <div class="form-control"><label for="edit-category">Category</label><select id="edit-category" required></select><span class="error-message"></span></div>
                    <div class="form-control full-width"><label for="edit-description">Description</label><input type="text" id="edit-description" required><span class="error-message"></span></div>
                    <div class="form-control full-width"><label for="edit-amount">Amount (<span id="currency-label-edit">₹</span>)</label><input type="number" id="edit-amount" step="0.01" min="0.01" required><span class="error-message"></span></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger cancel-modal-btn"><i class="fas fa-times-circle"></i> Cancel</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="add-category-modal">
        <div class="modal-content">
            <h2>Add New Category ✨</h2>
            <form id="add-category-form">
                <div class="form-control full-width"><label for="new-category-name">Category Name</label><input type="text" id="new-category-name" placeholder="e.g., Groceries" required><span class="error-message"></span></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger cancel-modal-btn"><i class="fas fa-times-circle"></i> Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Add Category</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="budget-modal">
        <div class="modal-content">
            <h2>Set Monthly Budgets 🐷</h2>
            <form id="budget-form">
                <div class="budget-item"><label for="budget-total">Overall Monthly Budget</label><div class="budget-input-wrapper"><span id="budget-currency-label-total">₹</span><input type="number" id="budget-total" step="1" min="0" placeholder="e.g., 50000"></div></div>
                <div id="category-budgets-container"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger cancel-modal-btn"><i class="fas fa-times-circle"></i> Cancel</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Save Budgets</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="manage-recurring-modal">
        <div class="modal-content">
            <h2>Manage Recurring Expenses <i class="fas fa-sync-alt"></i></h2>
            <div id="recurring-list-container"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-primary cancel-modal-btn"><i class="fas fa-check"></i> Done</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="year-in-review-modal">
        <div class="modal-content">
            <h2>Your Year in Review <i class="fas fa-award"></i></h2>
            <select id="year-review-select" style="margin-bottom: 20px;"></select>
            <div id="year-in-review-content"></div>
             <div class="modal-actions">
                <button type="button" class="btn btn-primary cancel-modal-btn"><i class="fas fa-arrow-left"></i> Back to App</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="clear-confirm-modal">
        <div class="modal-content">
            <h2>Confirm Clear Data ⚠️</h2>
            <p style="text-align: center; margin-bottom: 25px; color: rgba(255,255,255,0.9);">
                This action is permanent and will delete ALL data.
                <br><strong>It is highly recommended to save a report first.</strong>
            </p>
            <div class="actions">
                <button type="button" class="btn btn-info" id="clear-data-send-report-btn"><i class="fas fa-envelope"></i> Send Report & Enable Deletion</button>
                <button type="button" id="confirm-clear-data-btn" class="btn btn-danger" disabled><i class="fas fa-trash-alt"></i> Yes, Clear All Data</button>
            </div>
             <div class="modal-actions" style="margin-top: 25px;">
                <button type="button" class="btn btn-success cancel-modal-btn"><i class="fas fa-times-circle"></i> Cancel</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Constants ---
            const DEFAULT_CATEGORIES = ["Food", "Transport", "Bills", "Shopping", "Entertainment", "Health", "Education", "Rent", "Other"];
            const CURRENCY_OPTIONS = [
                { name: "Indian Rupee", symbol: "₹", code: "INR" }, { name: "US Dollar", symbol: "$", code: "USD" },
                { name: "Euro", symbol: "€", code: "EUR" }, { name: "British Pound", symbol: "£", code: "GBP" },
                { name: "Japanese Yen", symbol: "¥", code: "JPY" }, { name: "Chinese Yuan", symbol: "¥", code: "CNY" },
                { name: "Australian Dollar", symbol: "A$", code: "AUD" }, { name: "Canadian Dollar", symbol: "C$", code: "CAD" }
            ];

            // --- DOM Elements ---
            const expenseForm = document.getElementById('expense-form');
            const expenseTableBody = document.getElementById('expense-table-body');
            const totalAmountDisplay = document.getElementById('total-amount');
            const expenseSummaryContent = document.getElementById('expense-summary-content');
            const sendEmailBtn = document.getElementById('send-email-btn');
            const clearDataBtn = document.getElementById('clear-data-btn');
            const categoryFilter = document.getElementById('category-filter');
            const startDateFilter = document.getElementById('start-date-filter');
            const endDateFilter = document.getElementById('end-date-filter');
            const toastContainer = document.getElementById('toast-container');
            const welcomeMessageElement = document.getElementById('welcome-message');
            const recurringCheckbox = document.getElementById('recurring-checkbox');
            const recurringOptionsContainer = document.getElementById('recurring-options-container');
            const currencySelect = document.getElementById('currency-select');

            // Modals & Forms
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            const addCategoryModal = document.getElementById('add-category-modal');
            const addCategoryForm = document.getElementById('add-category-form');
            const clearConfirmModal = document.getElementById('clear-confirm-modal');
            const confirmClearDataBtn = document.getElementById('confirm-clear-data-btn');
            const clearDataSendReportBtn = document.getElementById('clear-data-send-report-btn');
            const developerModal = document.getElementById('developer-modal');
            const devInfoButton = document.getElementById('dev-info-button');
            const settingsModal = document.getElementById('settings-modal');
            const settingsButton = document.getElementById('settings-button');
            
            // Currency labels
            const currencyLabelMain = document.getElementById('currency-label-main');
            const currencyLabelEdit = document.getElementById('currency-label-edit');

            // Speech Recognition
            const speakDescriptionBtn = document.getElementById('speak-description-btn');
            let recognition, isRecognizing = false;

            // Chart & Analysis
            const expenseChartCanvas = document.getElementById('expenseChart');
            const noChartDataMessage = document.getElementById('no-chart-data-message');
            const analysisSuggestionsContent = document.getElementById('analysis-suggestions-content');
            let expenseChart;

            // New DOM Elements
            const budgetModal = document.getElementById('budget-modal');
            const budgetForm = document.getElementById('budget-form');
            const setBudgetsBtn = document.getElementById('set-budgets-btn');
            const categoryBudgetsContainer = document.getElementById('category-budgets-container');
            const budgetCurrencyLabelTotal = document.getElementById('budget-currency-label-total');
            const manageRecurringBtn = document.getElementById('manage-recurring-btn');
            const manageRecurringModal = document.getElementById('manage-recurring-modal');
            const recurringListContainer = document.getElementById('recurring-list-container');
            const yearInReviewBtn = document.getElementById('year-in-review-btn');
            const yearInReviewModal = document.getElementById('year-in-review-modal');
            const yearInReviewContent = document.getElementById('year-in-review-content');
            const yearReviewSelect = document.getElementById('year-review-select');

            // --- State Variables ---
            let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
            let categories = JSON.parse(localStorage.getItem('categories')) || DEFAULT_CATEGORIES;
            let sortConfig = JSON.parse(localStorage.getItem('sortConfig')) || { key: 'date', direction: 'desc' };
            let currentEditId = null;
            let currentCurrencySymbol = localStorage.getItem('selectedCurrencySymbol') || '₹';
            document.documentElement.style.setProperty('--current-currency-symbol', `'${currentCurrencySymbol}'`);
            
            let budgets = JSON.parse(localStorage.getItem('budgets')) || {};
            let recurringTemplates = JSON.parse(localStorage.getItem('recurringTemplates')) || [];

            const CHART_COLORS = [
                getComputedStyle(document.documentElement).getPropertyValue('--chart-color-1').trim(),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-color-2').trim(),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-color-3').trim(),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-color-4').trim(),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-color-5').trim(),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-color-6').trim(),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-color-7').trim(),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-color-8').trim(),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-color-9').trim(),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-color-10').trim(),
            ];

            // --- Helper Functions ---
            const stripEmojis = (str) => str ? str.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{2300}-\u{23FF}\u{2B00}-\u{2BFF}\u{25AA}-\u{25FE}\u{FE0F}\s]/gu, '').trim() : '';
            const toLocalDateInput = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString instanceof Date ? dateString : dateString + 'T00:00:00Z');
                return date.toISOString().split('T')[0];
            };
            const formatCurrency = (amount) => `${currentCurrencySymbol}${parseFloat(amount).toFixed(2)}`;

            const showToast = (message, type = 'info', duration = 3000, buttons = []) => {
                const toast = document.createElement('div');
                toast.classList.add('toast', type);
                
                let icon = '';
                if (type === 'success') icon = '<i class="fas fa-check-circle" aria-hidden="true"></i>';
                else if (type === 'error') icon = '<i class="fas fa-times-circle" aria-hidden="true"></i>';
                else if (type === 'info') icon = '<i class="fas fa-info-circle" aria-hidden="true"></i>';

                let buttonsHTML = buttons.map(btn => `<button data-id="${btn.id}">${btn.text}</button>`).join('');
                toast.innerHTML = `${icon} <span>${message}</span> ${buttonsHTML}`;
                toastContainer.appendChild(toast);

                if (buttons.length > 0) {
                    toast.querySelectorAll('button').forEach((btn, index) => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            buttons[index].action(btn.dataset.id);
                            toast.remove();
                        });
                    });
                }

                toast.classList.add('show');
                if (duration > 0) {
                    setTimeout(() => {
                        toast.classList.remove('show');
                        toast.classList.add('hide-effect');
                        setTimeout(() => toast.remove(), 300);
                    }, duration);
                }
            };

            const showModal = (modalElement) => {
                modalElement.style.display = 'flex';
                modalElement.classList.add('active');
                setTimeout(() => {
                    const firstInput = modalElement.querySelector('input, select, textarea, button:not(.cancel-modal-btn)');
                    if (firstInput) firstInput.focus();
                    else modalElement.querySelector('.modal-content').focus();
                }, 100);
            };

            const closeModal = (modalElement) => {
                modalElement.classList.remove('active');
                modalElement.style.display = 'none';
                const formInModal = modalElement.querySelector('form');
                if (formInModal) {
                    clearValidationErrors(formInModal);
                    formInModal.reset();
                }
            };

            const populateCurrencyDropdown = () => {
                currencySelect.innerHTML = '';
                CURRENCY_OPTIONS.forEach(currency => {
                    const option = document.createElement('option');
                    option.value = currency.symbol;
                    option.textContent = `${currency.symbol} ${currency.code} (${currency.name})`;
                    currencySelect.appendChild(option);
                });
                const savedCurrencySymbol = localStorage.getItem('selectedCurrencySymbol') || '₹';
                currencySelect.value = Array.from(currencySelect.options).some(opt => opt.value === savedCurrencySymbol) ? savedCurrencySymbol : '₹';
                currentCurrencySymbol = currencySelect.value;
                document.documentElement.style.setProperty('--current-currency-symbol', `'${currentCurrencySymbol}'`);
                updateCurrencyLabels();
            };

            const updateCurrencyLabels = () => {
                currencyLabelMain.textContent = currentCurrencySymbol;
                currencyLabelEdit.textContent = currentCurrencySymbol;
                budgetCurrencyLabelTotal.textContent = currentCurrencySymbol;
                document.querySelectorAll('.budget-currency-label-cat').forEach(el => el.textContent = currentCurrencySymbol);
            };

            const handleCurrencyChange = () => {
                currentCurrencySymbol = currencySelect.value;
                localStorage.setItem('selectedCurrencySymbol', currentCurrencySymbol);
                document.documentElement.style.setProperty('--current-currency-symbol', `'${currentCurrencySymbol}'`);
                updateCurrencyLabels();
                updateAllSections();
            };

            const persistExpensesToLocalStorage = () => localStorage.setItem('expenses', JSON.stringify(expenses));
            const saveCategories = () => {
                localStorage.setItem('categories', JSON.stringify(categories));
                populateCategoryDropdowns();
            };

            const validateInput = (inputElement) => {
                const errorMessageElement = inputElement.closest('.form-control')?.querySelector('.error-message');
                let isValid = true;
                let errorMessage = '';

                if (inputElement.required && inputElement.value.trim() === '') {
                    isValid = false;
                    errorMessage = 'This field is required.';
                } else if (inputElement.type === 'number') {
                    const value = parseFloat(inputElement.value);
                    if (isNaN(value)) {
                        isValid = false; errorMessage = 'Must be a valid number.';
                    } else if (value < 0) {
                        isValid = false; errorMessage = 'Value cannot be negative.';
                    } else if (inputElement.min && value < parseFloat(inputElement.min)) {
                        isValid = false; errorMessage = `Must be at least ${parseFloat(inputElement.min)}.`;
                    }
                } else if (inputElement.id === 'new-category-name') {
                    const cleanedNewCatName = stripEmojis(inputElement.value);
                    const categoryExists = categories.some(cat => stripEmojis(cat).toLowerCase() === cleanedNewCatName.toLowerCase());
                    if (cleanedNewCatName === '') {
                        isValid = false; errorMessage = 'Category name cannot be empty.';
                    } else if (categoryExists) {
                        isValid = false; errorMessage = 'Category already exists!';
                    }
                } else if (inputElement.id === 'start-date-filter' || inputElement.id === 'end-date-filter') {
                    const startVal = startDateFilter.value, endVal = endDateFilter.value;
                    startDateFilter.classList.remove('invalid');
                    if (startDateFilter.closest('.form-control')?.querySelector('.error-message')) startDateFilter.closest('.form-control').querySelector('.error-message').textContent = '';
                    endDateFilter.classList.remove('invalid');
                    if (endDateFilter.closest('.form-control')?.querySelector('.error-message')) endDateFilter.closest('.form-control').querySelector('.error-message').textContent = '';
                    if (startVal && endVal) {
                        const start = new Date(startVal + 'T00:00:00Z'), end = new Date(endVal + 'T00:00:00Z');
                        if (start > end) {
                            isValid = false; errorMessage = 'End date cannot be before start date.';
                            startDateFilter.classList.add('invalid');
                            if (startDateFilter.closest('.form-control')?.querySelector('.error-message')) startDateFilter.closest('.form-control').querySelector('.error-message').textContent = errorMessage;
                            endDateFilter.classList.add('invalid');
                            if (endDateFilter.closest('.form-control')?.querySelector('.error-message')) endDateFilter.closest('.form-control').querySelector('.error-message').textContent = errorMessage;
                        }
                    }
                    if (inputElement.id === 'start-date-filter' || inputElement.id === 'end-date-filter') return isValid;
                }

                if (!isValid) {
                    inputElement.classList.add('invalid');
                    if (errorMessageElement) {
                        errorMessageElement.textContent = errorMessage;
                        errorMessageElement.style.opacity = 1;
                    }
                } else {
                    inputElement.classList.remove('invalid');
                    if (errorMessageElement) {
                        errorMessageElement.textContent = '';
                        errorMessageElement.style.opacity = 0;
                    }
                }
                return isValid;
            };

            const validateForm = (formElement) => {
                let allValid = true;
                formElement.querySelectorAll('input[required], select[required], input[type="number"], #new-category-name').forEach(input => {
                    if (!validateInput(input)) allValid = false;
                });
                return allValid;
            };

            const clearValidationErrors = (formElement) => {
                formElement.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
                formElement.querySelectorAll('.error-message').forEach(el => { el.textContent = ''; });
            };

            const createExpenseRow = (expense) => {
                const tr = document.createElement('tr');
                tr.className = 'expense-item';
                tr.dataset.id = expense.id;
                const date = new Date(expense.date + 'T00:00:00Z');
                const formattedDate = date.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'UTC' });
                tr.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${stripEmojis(expense.category)}</td> 
                    <td>${expense.description}</td>
                    <td class="col-amount">${formatCurrency(expense.amount)}</td>
                    <td class="col-actions">
                        <button type="button" class="action-btn edit-btn" data-id="${expense.id}" title="Edit"><i class="fas fa-edit"></i></button>
                        <button type="button" class="action-btn duplicate-btn" data-id="${expense.id}" title="Duplicate"><i class="fas fa-copy"></i></button>
                        <button type="button" class="action-btn delete-btn" data-id="${expense.id}" title="Delete"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                return tr;
            };

            const renderExpenses = () => {
                const expensesToRender = getFilteredAndSortedExpenses();
                expenseTableBody.innerHTML = '';
                if (expensesToRender.length === 0) {
                    const message = expenses.length === 0 ? 'No expenses added yet. Start by using the form above! 📝' : 'No expenses match your current filters. 🧐';
                    expenseTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 25px 0; color: rgba(255,255,255,0.7);">${message}</td></tr>`;
                } else {
                    expensesToRender.forEach((expense) => expenseTableBody.appendChild(createExpenseRow(expense)));
                }
                updateSortIcons();
            };

            const updateAllSections = () => {
                renderExpenses();
                updateTotal();
                updateExpenseSummary();
                updateExpenseAnalysisSection();
            };

            const populateCategoryDropdowns = () => {
                const dropdowns = [
                    document.getElementById('expense-category'),
                    document.getElementById('edit-category'),
                    document.getElementById('category-filter')
                ];
                
                dropdowns.forEach((dropdown, index) => {
                    const currentSelected = dropdown.value;
                    dropdown.innerHTML = '';
                    if (index === 2) {
                        const allOption = document.createElement('option');
                        allOption.value = 'all';
                        allOption.textContent = 'All Categories';
                        dropdown.appendChild(allOption);
                    }
                    categories.slice().sort((a, b) => stripEmojis(a).localeCompare(stripEmojis(b))).forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = stripEmojis(cat);
                        dropdown.appendChild(option);
                    });
                    if (index === 0) {
                        const addNewOption = document.createElement('option');
                        addNewOption.value = '--add-new--';
                        addNewOption.textContent = '✨ Add New Category...';
                        dropdown.appendChild(addNewOption);
                    }
                    if (Array.from(dropdown.options).some(opt => opt.value === currentSelected)) {
                        dropdown.value = currentSelected;
                    } else if (index === 2) {
                        dropdown.value = 'all';
                    } else if (dropdown.options.length > 0) {
                        dropdown.value = dropdown.options[0].value;
                    }
                });
            };

            const updateTotal = () => {
                const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
                totalAmountDisplay.textContent = formatCurrency(total);
            };

            const updateExpenseSummary = () => {
                let summaryHtml = '';
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                const currentMonthExpenses = expenses.filter(exp => {
                    const expDate = new Date(exp.date + 'T00:00:00Z');
                    return expDate.getUTCFullYear() === currentYear && expDate.getUTCMonth() === currentMonth;
                });
                const totalCurrentMonthSpent = currentMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);

                if (budgets.total || Object.keys(budgets.categories || {}).length > 0) {
                    if (budgets.total > 0) {
                        const percentUsed = Math.min((totalCurrentMonthSpent / budgets.total) * 100, 100);
                        const remaining = budgets.total - totalCurrentMonthSpent;
                        let progressBarClass = '';
                        if (percentUsed > 85) progressBarClass = 'warning';
                        if (percentUsed >= 100) progressBarClass = 'exceeded';
                        
                        summaryHtml += `
                            <div class="budget-summary">
                                <h4><span>Overall Monthly Budget</span> <span>${formatCurrency(budgets.total)}</span></h4>
                                <div class="progress-bar-container"><div class="progress-bar ${progressBarClass}" style="width: ${percentUsed}%;"></div></div>
                                <div class="budget-details">
                                    <span>Spent: ${formatCurrency(totalCurrentMonthSpent)}</span>
                                    <span>${remaining >= 0 ? `Remaining: ${formatCurrency(remaining)}` : `Overspent: ${formatCurrency(Math.abs(remaining))}`}</span>
                                </div>
                            </div>`;
                    }
                    if (budgets.categories) {
                        Object.entries(budgets.categories).forEach(([category, budgetAmount]) => {
                             if (budgetAmount > 0) {
                                const spentInCategory = currentMonthExpenses.filter(e => stripEmojis(e.category) === stripEmojis(category)).reduce((sum, e) => sum + e.amount, 0);
                                const percentUsed = Math.min((spentInCategory / budgetAmount) * 100, 100);
                                const remaining = budgetAmount - spentInCategory;
                                let progressBarClass = '';
                                if (percentUsed > 85) progressBarClass = 'warning';
                                if (percentUsed >= 100) progressBarClass = 'exceeded';

                                summaryHtml += `
                                    <div class="budget-summary">
                                        <h4><span>${stripEmojis(category)} Budget</span> <span>${formatCurrency(budgetAmount)}</span></h4>
                                        <div class="progress-bar-container"><div class="progress-bar ${progressBarClass}" style="width: ${percentUsed}%;"></div></div>
                                        <div class="budget-details">
                                            <span>Spent: ${formatCurrency(spentInCategory)}</span>
                                            <span>${remaining >= 0 ? `Remaining: ${formatCurrency(remaining)}` : `Overspent: ${formatCurrency(Math.abs(remaining))}`}</span>
                                        </div>
                                    </div>`;
                            }
                        });
                    }
                }
                
                summaryHtml += generateOriginalSummary(currentMonthExpenses, totalCurrentMonthSpent);

                if (summaryHtml.trim() === '') {
                     expenseSummaryContent.innerHTML = `<p style="text-align: center; color: rgba(255,255,255,0.7); border: none; background: none;">
                        <i class="fas fa-hand-holding-usd" style="margin-right: 8px;" aria-hidden="true"></i> <span>Start by adding your first expense to see your financial summary here! 🚀</span>
                    </p>`;
                } else {
                    expenseSummaryContent.innerHTML = summaryHtml;
                }
            };
            
            const generateOriginalSummary = (currentMonthExpenses, totalCurrentMonthSpent) => {
                let newSummaryHtml = '';

                if (expenses.length === 0) {
                    return '';
                } 
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();

                const getExpensesForMonth = (year, month) => {
                    return expenses.filter(exp => {
                        const expDate = new Date(exp.date + 'T00:00:00Z'); 
                        return expDate.getUTCFullYear() === year && expDate.getUTCMonth() === month;
                    });
                };
                const calculateSpendingByCategory = (expenseList) => expenseList.reduce((acc, exp) => {
                    const categoryName = stripEmojis(exp.category);
                    acc[categoryName] = (acc[categoryName] || 0) + exp.amount;
                    return acc;
                }, {});

                let lastMonth = currentMonth - 1;
                let lastYear = currentYear;
                if (lastMonth < 0) { lastMonth = 11; lastYear--; }
                
                const lastMonthExpenses = getExpensesForMonth(lastYear, lastMonth);
                const totalLastMonthSpent = lastMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                
                const currentMonthName = now.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                const lastMonthName = new Date(lastYear, lastMonth).toLocaleString('en-US', { month: 'long', year: 'numeric' });
                
                if (totalCurrentMonthSpent > 0 && totalLastMonthSpent === 0) {
                    newSummaryHtml += `<p><i class="fas fa-money-bill-wave" aria-hidden="true"></i> <span>In ${currentMonthName}, you've spent <strong>${formatCurrency(totalCurrentMonthSpent)}</strong>. Great start to your tracking journey! 💰</span></p>`;
                } else if (totalCurrentMonthSpent > totalLastMonthSpent) {
                    const diff = totalCurrentMonthSpent - totalLastMonthSpent;
                    const percentage = (diff / (totalLastMonthSpent || 1)) * 100;
                    newSummaryHtml += `<p class="bad-news"><i class="fas fa-arrow-trend-up" aria-hidden="true"></i> <span>Your spending in ${currentMonthName} is <strong>${formatCurrency(diff)} (${percentage.toFixed(1)}% higher)</strong> than ${lastMonthName}'s ${formatCurrency(totalLastMonthSpent)}. Let's review where that extra cash went! 💸</span></p>`;
                } else if (totalCurrentMonthSpent < totalLastMonthSpent && totalCurrentMonthSpent >= 0) {
                    const diff = totalLastMonthSpent - totalCurrentMonthSpent;
                    const percentage = (diff / totalLastMonthSpent) * 100;
                    newSummaryHtml += `<p class="good-news"><i class="fas fa-arrow-trend-down" aria-hidden="true"></i> <span>Excellent! You spent <strong>${formatCurrency(diff)} (${percentage.toFixed(1)}% less)</strong> in ${currentMonthName} compared to ${lastMonthName}'s ${formatCurrency(totalLastMonthSpent)}. Keep up the smart saving! ✨</span></p>`;
                } else if (totalCurrentMonthSpent === totalLastMonthSpent && totalCurrentMonthSpent > 0) {
                    newSummaryHtml += `<p><i class="fas fa-balance-scale-left" aria-hidden="true"></i> <span>Your spending in ${currentMonthName} is consistent with ${lastMonthName}, totaling around <strong>${formatCurrency(totalCurrentMonthSpent)}</strong>. Steady financial management! 👍</span></p>`;
                } else if (currentMonthExpenses.length > 0) {
                    newSummaryHtml += `<p><i class="fas fa-calendar-alt" aria-hidden="true"></i> <span>No spending recorded for ${lastMonthName}. You spent <strong>${formatCurrency(totalCurrentMonthSpent)}</strong> in ${currentMonthName}.</span></p>`;
                }

                if (currentMonthExpenses.length > 0) {
                    const currentMonthSpendingByCategory = calculateSpendingByCategory(currentMonthExpenses);
                    const sortedCategories = Object.entries(currentMonthSpendingByCategory).sort(([, a], [, b]) => b - a).slice(0, 3);
                    if (sortedCategories.length > 0) {
                        const topCategoriesText = sortedCategories.map(([category, amount]) => `<strong>${stripEmojis(category)}</strong> (${formatCurrency(amount)}, ${((amount / totalCurrentMonthSpent) * 100).toFixed(1)}% of total)`).join(', ');
                        newSummaryHtml += `<p><i class="fas fa-boxes" aria-hidden="true"></i> <span>Your top ${sortedCategories.length} spending areas this month: ${topCategoriesText}. Knowing these can help you identify where to focus for potential savings!💡</span></p>`;
                    }
                    const largestExpense = currentMonthExpenses.reduce((max, exp) => (max === null || exp.amount > max.amount) ? exp : max, null);
                    if (largestExpense) {
                        newSummaryHtml += `<p><i class="fas fa-hand-holding-usd" aria-hidden="true"></i> <span>Your single largest expense this month was <strong>${formatCurrency(largestExpense.amount)}</strong> for "${largestExpense.description}" in "${stripEmojis(largestExpense.category)}". Big spending calls for careful consideration!💸</span></p>`;
                    }
                } else {
                     newSummaryHtml += `<p><i class="fas fa-smile-beam" aria-hidden="true"></i> <span>No spending recorded for ${currentMonthName} yet. A fresh start for tracking your finances!🆕</span></p>`;
                }
                return newSummaryHtml;
            };

            const getCategorySpendingDataForChart = (filteredExpenses) => {
                const spendingMap = filteredExpenses.reduce((acc, exp) => {
                    const cleanCategory = stripEmojis(exp.category);
                    acc[cleanCategory] = (acc[cleanCategory] || 0) + exp.amount;
                    return acc;
                }, {});
                const sortedPairs = Object.entries(spendingMap).sort((a, b) => b[1] - a[1]);
                return {
                    labels: sortedPairs.map(p => p[0]),
                    data: sortedPairs.map(p => p[1]),
                    total: sortedPairs.reduce((sum, p) => sum + p[1], 0),
                    spendingMap: spendingMap
                };
            };

            const renderPieChart = (chartData) => {
                const ctx = expenseChartCanvas.getContext('2d');
                if (expenseChart) expenseChart.destroy();
                if (chartData.labels.length === 0) {
                    expenseChartCanvas.style.display = 'none';
                    noChartDataMessage.style.display = 'block';
                    return;
                }
                expenseChartCanvas.style.display = 'block';
                noChartDataMessage.style.display = 'none';
                expenseChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            data: chartData.data,
                            backgroundColor: CHART_COLORS,
                            hoverOffset: 10,
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'left',
                                labels: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
                                    font: { size: 14, family: 'Poppins' },
                                    boxWidth: 20,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        if (label) {
                                            const value = context.parsed;
                                            const total = context.dataset.data.reduce((acc, current) => acc + current, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                        }
                                        return '';
                                    }
                                },
                                titleFont: { family: 'Poppins', size: 16 },
                                bodyFont: { family: 'Poppins', size: 14 },
                                backgroundColor: 'rgba(44, 62, 80, 0.95)',
                                borderColor: 'rgba(255,255,255,0.2)',
                                borderWidth: 1
                            }
                        }
                    }
                });
            };

            const generateAnalysisSuggestions = (chartData) => {
                let suggestionsHtml = '';
                if (chartData.labels.length === 0) {
                    suggestionsHtml = `<p style="text-align: center; color: rgba(255,255,255,0.7); border: none; background: none;"><i class="fas fa-lightbulb" style="margin-right: 8px;" aria-hidden="true"></i> <span>No expenses recorded for this period yet! Start adding to get insightful tips. 📝</span></p>`;
                } else {
                    const numTopCategories = Math.min(3, chartData.labels.length);
                    const topCategories = chartData.labels.slice(0, numTopCategories);
                    const totalExpenses = chartData.total;
                    const sumOfTopCategories = topCategories.reduce((sum, cat) => sum + chartData.spendingMap[cat], 0);

                    suggestionsHtml += `<p><i class="fas fa-magnifying-glass-chart" aria-hidden="true"></i> <span>Your top <strong>${numTopCategories}</strong> spending categories (${topCategories.map(c => `<strong>${c}</strong>`).join(', ')}) account for <strong>${formatCurrency(sumOfTopCategories)}</strong>, out of a total of <strong>${formatCurrency(totalExpenses)}</strong> in this period. Focusing on these areas can provide the maximum impact on your financial well-being! ✨</span></p>`;
                    
                    const highestCategoryAmount = chartData.data[0];
                    const highestCategoryName = chartData.labels[0];
                    const highestPercentage = (highestCategoryAmount / totalExpenses) * 100;
                    if (highestPercentage > 40) {
                        suggestionsHtml += `<p class="bad-news"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> <span><strong>High concentration!</strong> <strong>${highestCategoryName}</strong> represents <strong>${highestPercentage.toFixed(1)}%</strong> of your spending. Deep diving into expenses within this category could reveal significant saving opportunities. 🧐💡</span></p>`;
                    }

                    const otherCategoryData = chartData.spendingMap['Other'];
                    if (otherCategoryData && otherCategoryData > 0) {
                        const otherPercentage = (otherCategoryData / totalExpenses) * 100;
                        if (otherPercentage > 10) {
                            suggestionsHtml += `<p class="info"><i class="fas fa-question-circle" aria-hidden="true"></i> <span>Your '<strong>Other</strong>' category is currently ${formatCurrency(otherCategoryData)} (${otherPercentage.toFixed(1)}%). Consider categorizing these expenses more specifically to get clearer insights into your spending habits! 💡</span></p>`;
                        }
                    }
                }
                analysisSuggestionsContent.innerHTML = suggestionsHtml;
            };

            const updateExpenseAnalysisSection = () => {
                const expensesForAnalysis = getFilteredAndSortedExpenses();
                const chartData = getCategorySpendingDataForChart(expensesForAnalysis);
                renderPieChart(chartData);
                generateAnalysisSuggestions(chartData);
            };

            const updateSortIcons = () => {
                document.querySelectorAll('.expense-table th').forEach(header => {
                    const sortKey = header.dataset.sortBy, iconSpan = header.querySelector('.sort-icon');
                    if (iconSpan) {
                        let icon = '';
                        if (sortKey === sortConfig.key) {
                            icon = sortConfig.direction === 'asc' ? ' ↑' : ' ↓';
                            header.classList.add('sorted');
                        } else {
                            header.classList.remove('sorted');
                        }
                        iconSpan.textContent = icon;
                    }
                });
            };

            const updateWelcomeMessage = () => {
                let userName = localStorage.getItem('userName');
                if (!userName) {
                    userName = prompt("👋 Welcome to your Smart Expense Tracker! What's your name?");
                    localStorage.setItem('userName', userName ? userName.trim() : "Guest");
                }
                welcomeMessageElement.textContent = `Hello, ${localStorage.getItem('userName')}! Let's track your expenses. 📊`;
            };
            
            const getFilteredAndSortedExpenses = () => {
                const filterValue = categoryFilter.value;
                const start = startDateFilter.value ? new Date(startDateFilter.value + 'T00:00:00Z') : null;
                const end = endDateFilter.value ? new Date(endDateFilter.value + 'T00:00:00Z') : null;

                let filtered = expenses.filter(exp => {
                    if (filterValue !== 'all' && stripEmojis(exp.category) !== stripEmojis(filterValue)) return false;
                    const expDate = new Date(exp.date + 'T00:00:00Z');
                    if (start && expDate < start) return false;
                    if (end) {
                        const endOfDay = new Date(end.valueOf());
                        endOfDay.setUTCHours(23, 59, 59, 999);
                        if (expDate > endOfDay) return false;
                    }
                    return true;
                });

                return filtered.sort((a, b) => {
                    let valA, valB;
                    if (sortConfig.key === 'date') {
                        valA = new Date(a.date); valB = new Date(b.date);
                    } else if (sortConfig.key === 'amount') {
                        valA = a.amount; valB = b.amount;
                    } else {
                        valA = stripEmojis(String(a[sortConfig.key])).toLowerCase();
                        valB = stripEmojis(String(b[sortConfig.key])).toLowerCase();
                    }
                    if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            };

            const sendDataEmail = (isBackup = false) => {
                const expensesToReport = isBackup ? expenses : getFilteredAndSortedExpenses();
                if (expensesToReport.length === 0) {
                    showToast('No data to send.', 'info');
                    if (isBackup) confirmClearDataBtn.disabled = false;
                    return;
                }
                const email = prompt("Enter your email address to send the report:");
                if (!email || !email.includes('@')) {
                    showToast('Invalid email or cancelled.', 'error');
                    if (isBackup) confirmClearDataBtn.disabled = false; // Allow deletion even if mail fails
                    return;
                }
                const userName = localStorage.getItem('userName') || "User";
                const totalReportAmount = expensesToReport.reduce((sum, e) => sum + e.amount, 0);
                const subject = isBackup ? `Expense Tracker Backup - ${new Date().toLocaleDateString()}` : 'Smart Expense Tracker Report';
                let body = `Dear ${userName},\n\nHere is your expense report.\n\nTotal: ${formatCurrency(totalReportAmount)}\n\n---DETAILS---\n`;
                body += expensesToReport.map(e => `${toLocalDateInput(e.date)} | ${stripEmojis(e.category)} | ${e.description} | ${formatCurrency(e.amount)}`).join('\n');
                window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                if (isBackup) {
                    showToast('Email client opened. Deletion is now enabled.', 'success');
                    confirmClearDataBtn.disabled = false;
                }
            };

            // --- Event Listeners ---
            expenseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!validateForm(expenseForm)) {
                    showToast('Please correct the highlighted fields.', 'error'); return;
                }
                const newExpense = {
                    id: Date.now(),
                    date: toLocalDateInput(document.getElementById('expense-date').value),
                    category: document.getElementById('expense-category').value,
                    description: document.getElementById('expense-description').value.trim(),
                    amount: parseFloat(document.getElementById('expense-amount').value),
                };
                if (recurringCheckbox.checked) {
                    recurringTemplates.push({ ...newExpense, frequency: document.getElementById('recurring-frequency').value, lastInstanceDate: newExpense.date });
                    localStorage.setItem('recurringTemplates', JSON.stringify(recurringTemplates));
                    showToast('New recurring expense template created!', 'success');
                }
                expenses.unshift(newExpense);
                persistExpensesToLocalStorage();
                updateAllSections();
                expenseForm.reset();
                document.getElementById('expense-date').valueAsDate = new Date();
                recurringCheckbox.checked = false;
                recurringOptionsContainer.style.display = 'none';
                clearValidationErrors(expenseForm);
                showToast('Expense Added Successfully! ✅', 'success');
            });

            document.getElementById('expense-category').addEventListener('change', (e) => {
                if(e.target.value === '--add-new--') {
                    e.target.selectedIndex = 0; 
                    showModal(addCategoryModal);
                }
            });

            expenseTableBody.addEventListener('click', (e) => {
                const button = e.target.closest('.action-btn');
                if (!button) return;
                const id = parseInt(button.dataset.id);
                const expenseIndex = expenses.findIndex(exp => exp.id === id);
                if (expenseIndex === -1) return;

                if (button.classList.contains('delete-btn')) {
                    expenses.splice(expenseIndex, 1);
                    persistExpensesToLocalStorage();
                    updateAllSections();
                    showToast('Expense Deleted. 🗑️', 'info');
                } else if (button.classList.contains('duplicate-btn')) {
                    const duplicatedExpense = { ...expenses[expenseIndex], id: Date.now(), date: toLocalDateInput(new Date()), description: `(Copy) ${expenses[expenseIndex].description}` };
                    expenses.unshift(duplicatedExpense);
                    persistExpensesToLocalStorage();
                    updateAllSections();
                    showToast('Expense Duplicated! 📋', 'info');
                } else if (button.classList.contains('edit-btn')) {
                    const expenseToEdit = expenses[expenseIndex];
                    currentEditId = id;
                    document.getElementById('edit-date').value = toLocalDateInput(expenseToEdit.date);
                    document.getElementById('edit-category').value = expenseToEdit.category;
                    document.getElementById('edit-description').value = expenseToEdit.description;
                    document.getElementById('edit-amount').value = expenseToEdit.amount;
                    clearValidationErrors(editForm);
                    showModal(editModal);
                }
            });

            editForm.addEventListener('submit', e => {
                e.preventDefault();
                if (!validateForm(editForm)) return;
                const expenseIndex = expenses.findIndex(exp => exp.id === currentEditId);
                if (expenseIndex > -1) {
                    expenses[expenseIndex] = {
                        id: currentEditId,
                        date: toLocalDateInput(document.getElementById('edit-date').value),
                        category: document.getElementById('edit-category').value,
                        description: document.getElementById('edit-description').value.trim(),
                        amount: parseFloat(document.getElementById('edit-amount').value),
                    };
                    persistExpensesToLocalStorage();
                    updateAllSections();
                    showToast('Changes Saved! ✨', 'success');
                }
                closeModal(editModal);
                currentEditId = null;
            });

            addCategoryForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newCatNameInput = document.getElementById('new-category-name');
                if (!validateInput(newCatNameInput)) return;
                const newCategoryName = newCatNameInput.value.trim();
                categories.push(newCategoryName);
                saveCategories();
                document.getElementById('expense-category').value = newCategoryName;
                closeModal(addCategoryModal);
                showToast(`Category "${newCategoryName}" Added! 🎉`, 'success');
            });
            
            clearDataBtn.addEventListener('click', () => {
                if (expenses.length > 0 || categories.length > DEFAULT_CATEGORIES.length) {
                    confirmClearDataBtn.disabled = true; // Reset button state on open
                    showModal(clearConfirmModal);
                }
                else showToast('No user data to clear. 🧹', 'info');
            });
            
            clearDataSendReportBtn.addEventListener('click', () => sendDataEmail(true));
            
            confirmClearDataBtn.addEventListener('click', () => {
                expenses = []; categories = [...DEFAULT_CATEGORIES]; budgets = {}; recurringTemplates = [];
                localStorage.clear();
                sortConfig = { key: 'date', direction: 'desc' };
                localStorage.setItem('sortConfig', JSON.stringify(sortConfig));
                populateCategoryDropdowns(); updateWelcomeMessage();
                categoryFilter.value = 'all'; startDateFilter.value = ''; endDateFilter.value = '';
                updateAllSections();
                closeModal(clearConfirmModal);
                showToast('All data cleared! ✅', 'success');
            });
            
            document.querySelectorAll('.cancel-modal-btn').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal-overlay'))));
            [categoryFilter, startDateFilter, endDateFilter].forEach(el => el.addEventListener('change', updateAllSections));
            document.querySelectorAll('.expense-table th[data-sort-by]').forEach(header => {
                header.addEventListener('click', () => {
                    const newSortKey = header.dataset.sortBy;
                    if (sortConfig.key === newSortKey) {
                        sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortConfig.key = newSortKey;
                        sortConfig.direction = (newSortKey === 'date' || newSortKey === 'amount') ? 'desc' : 'asc';
                    }
                    localStorage.setItem('sortConfig', JSON.stringify(sortConfig));
                    updateAllSections();
                });
            });

            sendEmailBtn.addEventListener('click', () => sendDataEmail(false));

            // New Feature Listeners
            setBudgetsBtn.addEventListener('click', (e) => { e.preventDefault(); populateBudgetModal(); showModal(budgetModal); closeModal(settingsModal); });
            budgetForm.addEventListener('submit', (e) => {
                e.preventDefault();
                budgets = {
                    total: parseFloat(document.getElementById('budget-total').value) || 0,
                    categories: Array.from(document.querySelectorAll('.category-budget-input')).reduce((acc, input) => {
                        const amount = parseFloat(input.value);
                        if (amount > 0) acc[input.dataset.category] = amount;
                        return acc;
                    }, {})
                };
                localStorage.setItem('budgets', JSON.stringify(budgets));
                showToast('Budgets saved!', 'success');
                closeModal(budgetModal);
                updateAllSections();
            });
            function populateBudgetModal() {
                document.getElementById('budget-total').value = budgets.total || '';
                categoryBudgetsContainer.innerHTML = '<h3>Category Budgets</h3>';
                categories.forEach(cat => {
                    const catBudget = (budgets.categories && budgets.categories[cat]) || '';
                    categoryBudgetsContainer.innerHTML += `
                        <div class="budget-item">
                            <label for="budget-${stripEmojis(cat)}">${stripEmojis(cat)}</label>
                            <div class="budget-input-wrapper">
                                <span class="budget-currency-label-cat">${currentCurrencySymbol}</span>
                                <input type="number" class="category-budget-input" id="budget-${stripEmojis(cat)}" data-category="${cat}" value="${catBudget}" step="1" min="0">
                            </div>
                        </div>`;
                });
            }

            recurringCheckbox.addEventListener('change', () => { recurringOptionsContainer.style.display = recurringCheckbox.checked ? 'flex' : 'none'; });
            manageRecurringBtn.addEventListener('click', () => { populateRecurringModal(); showModal(manageRecurringModal); });
            function populateRecurringModal() {
                recurringListContainer.innerHTML = recurringTemplates.length === 0 ? `<p style="text-align:center;">No recurring expenses set up.</p>` :
                    recurringTemplates.map(t => `
                    <div class="budget-item">
                        <div><strong>${t.description}</strong> (${formatCurrency(t.amount)})<br><small>Category: ${stripEmojis(t.category)}, Freq: ${t.frequency}</small></div>
                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteRecurringTemplate(${t.id})"><i class="fas fa-trash"></i></button>
                    </div>`).join('');
            }
            window.deleteRecurringTemplate = (id) => {
                if (confirm('Delete this recurring template?')) {
                    recurringTemplates = recurringTemplates.filter(t => t.id !== id);
                    localStorage.setItem('recurringTemplates', JSON.stringify(recurringTemplates));
                    populateRecurringModal();
                    showToast('Template deleted.', 'info');
                }
            };
            function checkDueRecurringExpenses() {
                const today = new Date(); today.setHours(0,0,0,0);
                recurringTemplates.forEach(t => {
                    const lastDate = new Date(t.lastInstanceDate + 'T00:00:00Z'), dueDate = new Date(lastDate);
                    if (t.frequency === 'weekly') dueDate.setDate(lastDate.getDate() + 7);
                    else if (t.frequency === 'monthly') dueDate.setMonth(lastDate.getMonth() + 1);
                    else if (t.frequency === 'yearly') dueDate.setFullYear(lastDate.getFullYear() + 1);
                    if (today >= dueDate) showToast(`Recurring expense "${t.description}" is due!`, 'info', 0, [{ text: 'Add Now', id: t.id, action: addRecurringInstance }]);
                });
            }
            window.addRecurringInstance = (templateId) => {
                const template = recurringTemplates.find(t => t.id == templateId);
                if (!template) return;
                const newExpense = { id: Date.now(), date: toLocalDateInput(new Date()), category: template.category, description: template.description, amount: template.amount };
                expenses.unshift(newExpense);
                persistExpensesToLocalStorage();
                template.lastInstanceDate = newExpense.date;
                localStorage.setItem('recurringTemplates', JSON.stringify(recurringTemplates));
                showToast(`Added: ${template.description}`, 'success');
                updateAllSections();
            };
            yearInReviewBtn.addEventListener('click', () => { populateYearReviewSelect(); generateYearInReview(); showModal(yearInReviewModal); });
            yearReviewSelect.addEventListener('change', generateYearInReview);
            function populateYearReviewSelect() {
                const years = [...new Set(expenses.map(e => new Date(e.date + 'T00:00:00Z').getUTCFullYear()))].sort((a,b) => b-a);
                if (years.length === 0) years.push(new Date().getFullYear());
                yearReviewSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
            }
            function generateYearInReview() {
                const year = parseInt(yearReviewSelect.value);
                const yearExpenses = expenses.filter(e => new Date(e.date + 'T00:00:00Z').getUTCFullYear() === year);
                if (yearExpenses.length === 0) {
                    yearInReviewContent.innerHTML = `<p style="padding: 40px 0;">No expense data for ${year}.</p>`; return;
                }
                const totalSpent = yearExpenses.reduce((s, e) => s + e.amount, 0), avgMonthly = totalSpent / 12;
                const catData = getCategorySpendingDataForChart(yearExpenses), topCat = catData.labels.length > 0 ? `${catData.labels[0]} (${formatCurrency(catData.data[0])})` : 'N/A';
                const monthlySpending = Array(12).fill(0);
                yearExpenses.forEach(e => { monthlySpending[new Date(e.date + 'T00:00:00Z').getUTCMonth()] += e.amount; });
                const highestMonthIdx = monthlySpending.indexOf(Math.max(...monthlySpending));
                const highestMonthName = new Date(year, highestMonthIdx).toLocaleString('default', { month: 'long' });
                const biggestExpense = yearExpenses.reduce((max, e) => e.amount > max.amount ? e : max, yearExpenses[0]);
                yearInReviewContent.innerHTML = `
                    <div class="review-stats">
                        <div class="stat-card"><h4>Total Spent in ${year}</h4><p class="stat-value">${formatCurrency(totalSpent)}</p></div>
                        <div class="stat-card"><h4>Avg. Monthly Spending</h4><p class="stat-value">${formatCurrency(avgMonthly)}</p></div>
                        <div class="stat-card"><h4>Highest Spending Month</h4><p class="stat-value">${highestMonthName}</p><p class="stat-details">${formatCurrency(monthlySpending[highestMonthIdx])}</p></div>
                        <div class="stat-card"><h4>Top Spending Category</h4><p class="stat-value">${stripEmojis(topCat.split(' (')[0])}</p><p class="stat-details">${topCat.split(' (')[1] ? '('+topCat.split(' (')[1] : ''}</p></div>
                        <div class="stat-card full-width"><h4>Largest Single Expense</h4><p class="stat-value">${formatCurrency(biggestExpense.amount)}</p><p class="stat-details">For "${biggestExpense.description}" in ${stripEmojis(biggestExpense.category)}</p></div>
                    </div>`;
            }

            // Speech Recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false; recognition.interimResults = false; recognition.lang = 'en-US';
                recognition.onstart = () => {
                    isRecognizing = true;
                    speakDescriptionBtn.innerHTML = '<i class="fas fa-microphone-alt" aria-hidden="true"></i> <span>Listening...</span>';
                    speakDescriptionBtn.classList.add('recognizing'); speakDescriptionBtn.disabled = true;
                };
                recognition.onresult = (e) => document.getElementById('expense-description').value = e.results[0][0].transcript.trim();
                recognition.onend = () => {
                    isRecognizing = false; speakDescriptionBtn.disabled = false;
                    speakDescriptionBtn.classList.remove('recognizing');
                    speakDescriptionBtn.innerHTML = '<i class="fas fa-microphone" aria-hidden="true"></i> Speak';
                };
                recognition.onerror = (e) => showToast(`Speech error: ${e.error}`, 'error');
                speakDescriptionBtn.addEventListener('click', () => { if (!isRecognizing) recognition.start(); });
            } else {
                speakDescriptionBtn.style.display = 'none';
            }

            // Initialization
            const initializeApp = () => {
                document.body.dataset.theme = 'dark';
                
                // --- EVENT LISTENERS ---
                settingsButton.addEventListener('click', () => showModal(settingsModal));
                devInfoButton.addEventListener('click', () => showModal(developerModal));
                currencySelect.addEventListener('change', handleCurrencyChange);

                updateWelcomeMessage();
                populateCategoryDropdowns();
                populateCurrencyDropdown();
                document.getElementById('expense-date').valueAsDate = new Date();
                updateAllSections();
                checkDueRecurringExpenses();
            };
            initializeApp();
        });
    </script>
</body>
</html>
